<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard pentru agenti si administratori - Poliția Locală Slobozia">
    <title>Admin Chat - Poliția Locală Slobozia</title>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-functions-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-storage-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        /* Import fonts to match main site */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Poppins:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-color: #1A2F5F;
            --secondary-color: #1E88E5;
            --secondary-light: rgba(30, 136, 229, 0.2);
            --accent-color: #FFCA28;
            --accent-dark: #FFC107;
            --text-primary: #333333;
            --text-secondary: #666666;
            --background-light: #F5F7FA;
            --background-dark: #172B4D;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --border-radius-small: 6px;
            --border-radius-medium: 10px;
            --border-radius-large: 15px;
            --shadow-small: 0 2px 10px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 5px 15px rgba(0, 0, 0, 0.1);
            --shadow-large: 0 10px 30px rgba(0, 0, 0, 0.15);
            --transition-fast: all 0.3s ease;
            --transition-medium: all 0.5s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            color: var(--text-primary);
            background-color: var(--background-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
        }
        
        a:focus, button:focus, input:focus, select:focus, textarea:focus {
            outline: 3px solid var(--secondary-light);
            outline-offset: 2px;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* Auth Screens */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--background-dark) 100%);
            padding: 2rem;
        }
        
        .auth-card {
            width: 100%;
            max-width: 500px;
            background-color: white;
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-large);
            overflow: hidden;
        }
        
        .auth-header {
            background-color: var(--primary-color);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .auth-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
        }
        
        .auth-logo img {
            max-width: 100%;
            height: auto;
        }
        
        .auth-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .auth-subtitle {
            font-size: 1rem;
            opacity: 0.8;
            font-weight: normal;
        }
        
        .auth-form {
            padding: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius-small);
            font-size: 1rem;
            transition: var(--transition-fast);
        }
        
        .form-control:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px var(--secondary-light);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            background-color: var(--secondary-color);
            color: white;
            border-radius: var(--border-radius-medium);
            font-size: 1rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: var(--transition-fast);
            text-decoration: none;
        }
        
        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
        }
        
        .btn-primary:hover {
            background-color: #1976d2;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .auth-footer {
            text-align: center;
            padding: 0 2rem 2rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .auth-footer a {
            color: var(--secondary-color);
            text-decoration: none;
        }
        
        .auth-footer a:hover {
            text-decoration: underline;
        }
        
        .auth-error {
            background-color: rgba(244, 67, 54, 0.1);
            border-left: 4px solid var(--danger-color);
            color: var(--danger-color);
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius-small);
            display: none;
        }

        /* Main App Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Header */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            box-shadow: var(--shadow-medium);
            z-index: 1000;
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
        }
        
        .header-logo img {
            height: 35px;
            margin-right: 1rem;
        }
        
        .header-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-dropdown {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--border-radius-medium);
            transition: var(--transition-fast);
        }
        
        .user-dropdown:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-weight: 600;
        }
        
        .user-info {
            line-height: 1.2;
        }
        
        .user-name {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .user-role {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .dropdown-toggle {
            font-size: 1.2rem;
            margin-left: 0.5rem;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 55px;
            right: 1.5rem;
            background-color: white;
            border-radius: var(--border-radius-medium);
            box-shadow: var(--shadow-medium);
            min-width: 180px;
            z-index: 1000;
            display: none;
        }
        
        .dropdown-menu.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition-fast);
        }
        
        .dropdown-item:hover {
            background-color: var(--background-light);
        }
        
        .dropdown-item i {
            margin-right: 0.75rem;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }
        
        .dropdown-divider {
            height: 1px;
            background-color: rgba(0, 0, 0, 0.1);
            margin: 0.5rem 0;
        }
        
        /* Main content */
        .main-content {
            flex: 1;
            display: flex;
            margin-top: 60px;
            height: calc(100vh - 60px);
        }
        
        /* Chat interface - Left panel */
        .chat-list-panel {
            width: 350px;
            background-color: white;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-list-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .panel-title {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
        }
        
        .chat-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .filter-btn {
            flex: 1;
            padding: 0.5rem;
            background-color: var(--background-light);
            border: none;
            border-radius: var(--border-radius-small);
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .filter-btn.active {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .search-container {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 0.6rem 1rem 0.6rem 2.5rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius-small);
            font-size: 0.9rem;
        }
        
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.2rem;
        }
        
        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem 0;
        }
        
        .chat-item {
            padding: 1rem;
            display: flex;
            border-left: 3px solid transparent;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .chat-item:hover {
            background-color: var(--background-light);
        }
        
        .chat-item.active {
            background-color: var(--secondary-light);
            border-left-color: var(--secondary-color);
        }
        
        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--background-light);
            margin-right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .chat-avatar.priority-high {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
        }
        
        .chat-avatar.priority-medium {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
        }
        
        .chat-avatar.status-waiting {
            border: 2px solid var(--warning-color);
        }
        
        .chat-avatar.status-active {
            border: 2px solid var(--success-color);
        }
        
        .chat-avatar.status-closed {
            border: 2px solid var(--text-secondary);
        }
        
        .chat-info {
            flex: 1;
            min-width: 0;
        }
        
        .chat-info-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.3rem;
        }
        
        .chat-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .chat-subject {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }
        
        .chat-preview {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.3rem;
        }
        
        .chat-department {
            font-size: 0.75rem;
            background-color: var(--background-light);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
        }
        
        .chat-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-waiting {
            background-color: var(--warning-color);
        }
        
        .status-active {
            background-color: var(--success-color);
        }
        
        .status-closed {
            background-color: var(--text-secondary);
        }
        
        .unread-badge {
            background-color: var(--danger-color);
            color: white;
            border-radius: 10px;
            padding: 0.1rem 0.4rem;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        /* Chat interface - Right panel */
        .chat-view-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--background-light);
        }
        
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            color: var(--secondary-color);
            opacity: 0.5;
        }
        
        .empty-state-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .empty-state-text {
            max-width: 500px;
            margin-bottom: 1.5rem;
        }
        
        .chat-view-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background-color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-details {
            display: flex;
            align-items: center;
        }
        
        .user-details-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--background-light);
            margin-right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .user-details-info {
            line-height: 1.3;
        }
        
        .user-details-name {
            font-weight: 600;
        }
        
        .user-details-status {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .view-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--background-light);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .action-btn:hover {
            background-color: var(--secondary-light);
            color: var(--secondary-color);
        }
        
        .action-btn.btn-danger {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
        }
        
        .action-btn.btn-danger:hover {
            background-color: rgba(244, 67, 54, 0.2);
        }
        
        .action-btn i {
            font-size: 1.2rem;
        }
        
        .chat-view-body {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        
        .chat-info-card {
            background-color: white;
            border-radius: var(--border-radius-medium);
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-small);
        }
        
        .info-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }
        
        .info-title i {
            margin-right: 0.5rem;
        }
        
        .info-content {
            font-size: 0.9rem;
        }
        
        .info-row {
            display: flex;
            margin-bottom: 0.5rem;
        }
        
        .info-label {
            width: 120px;
            color: var(--text-secondary);
        }
        
        .info-value {
            flex: 1;
        }
        
        .message-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            max-width: 80%;
            margin-bottom: 1rem;
            position: relative;
        }
        
        .message.user-message {
            align-self: flex-end;
        }
        
        .message.agent-message {
            align-self: flex-start;
        }
        
        .message.system-message {
            align-self: center;
            background-color: rgba(0, 0, 0, 0.05);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius-small);
            font-size: 0.9rem;
            color: var(--text-secondary);
            max-width: 90%;
            text-align: center;
            margin: 0.5rem 0;
        }
        
        .message-content {
            padding: 1rem;
            border-radius: var(--border-radius-medium);
            position: relative;
        }
        
        .user-message .message-content {
            background-color: var(--secondary-light);
            color: var(--primary-color);
            border-bottom-right-radius: 0;
        }
        
        .agent-message .message-content {
            background-color: white;
            border-bottom-left-radius: 0;
            box-shadow: var(--shadow-small);
        }
        
        .message-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-top: 0.3rem;
            padding: 0 0.3rem;
        }
        
        .message-time {
            color: var(--text-secondary);
        }
        
        .message-status {
            display: flex;
            align-items: center;
            color: var(--text-secondary);
        }
        
        .message-status i {
            font-size: 1rem;
            margin-left: 0.2rem;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            margin: 0 0 1rem;
            align-self: flex-start;
        }
        
        .typing-dot {
            height: 8px;
            width: 8px;
            margin: 0 1px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: inline-block;
            animation: typingAnimation 1.5s infinite;
        }
        
        @keyframes typingAnimation {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        /* Chat input */
        .chat-view-footer {
            padding: 1rem;
            background-color: white;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .quick-responses {
            margin-bottom: 0.75rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .quick-response {
            padding: 0.4rem 0.8rem;
            background-color: var(--background-light);
            border-radius: var(--border-radius-small);
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition-fast);
            border: none;
        }
        
        .quick-response:hover {
            background-color: var(--secondary-light);
            color: var(--secondary-color);
        }
        
        .chat-input-container {
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
            position: relative;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius-medium);
            resize: none;
            min-height: 45px;
            max-height: 150px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
            line-height: 1.5;
            transition: var(--transition-fast);
        }
        
        .chat-input:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px var(--secondary-light);
            outline: none;
        }
        
        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-action {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background-color: var(--background-light);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .btn-action:hover {
            background-color: var(--secondary-light);
            color: var(--secondary-color);
        }
        
        .btn-action i {
            font-size: 1.2rem;
        }
        
        .btn-send {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-send:hover {
            background-color: #1976d2;
        }
        
        /* Dropdown menu */
        .templates-dropdown {
            position: absolute;
            bottom: 55px;
            left: 0;
            width: 100%;
            background-color: white;
            border-radius: var(--border-radius-medium);
            box-shadow: var(--shadow-medium);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        
        .templates-dropdown.show {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        
        .templates-header {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .templates-list {
            padding: 0.5rem 0;
        }
        
        .template-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .template-item:hover {
            background-color: var(--background-light);
        }
        
        .template-title {
            font-weight: 500;
            margin-bottom: 0.3rem;
        }
        
        .template-preview {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* User info panel (right sidebar) */
        .user-info-panel {
            width: 300px;
            background-color: white;
            border-left: 1px solid rgba(0, 0, 0, 0.1);
            padding: 1rem;
            overflow-y: auto;
            display: none;
        }
        
        .user-info-panel.show {
            display: block;
        }
        
        .user-info-header {
            margin-bottom: 1.5rem;
        }
        
        .user-info-title {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .user-full-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background-color: var(--background-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .user-full-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .user-full-email, .user-full-phone {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
        }
        
        .user-full-email i, .user-full-phone i {
            margin-right: 0.5rem;
            font-size: 1rem;
        }
        
        .user-info-section {
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            letter-spacing: 0.05em;
        }
        
        .info-list {
            background-color: var(--background-light);
            border-radius: var(--border-radius-medium);
            overflow: hidden;
        }
        
        .info-item {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 0.9rem;
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-item-label {
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        .info-item-value {
            font-weight: 500;
        }
        
        .chat-timeline {
            list-style: none;
        }
        
        .timeline-item {
            position: relative;
            padding-left: 1.5rem;
            padding-bottom: 1.5rem;
            border-left: 2px solid var(--background-light);
        }
        
        .timeline-item:last-child {
            border-left: none;
            padding-bottom: 0;
        }
        
        .timeline-icon {
            position: absolute;
            left: -10px;
            top: 0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        .timeline-content {
            font-size: 0.9rem;
        }
        
        .timeline-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        /* Modal */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-fast);
        }
        
        .modal-backdrop.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-container {
            width: 100%;
            max-width: 500px;
            background-color: white;
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-large);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            transition: var(--transition-fast);
        }
        
        .modal-backdrop.show .modal-container {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition-fast);
        }
        
        .modal-close:hover {
            color: var(--danger-color);
        }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        /* Loading indicator */
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--secondary-color);
            animation: spinner 1s ease-in-out infinite;
        }
        
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-left: 1rem;
            color: var(--text-secondary);
        }
        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 2000;
        }
        
        .toast {
            padding: 1rem 1.5rem;
            background-color: white;
            border-radius: var(--border-radius-medium);
            box-shadow: var(--shadow-large);
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            min-width: 300px;
            transform: translateX(100%);
            opacity: 0;
            transition: var(--transition-fast);
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .toast-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition-fast);
        }
        
        .toast-close:hover {
            color: var(--danger-color);
        }
        
        .toast-success .toast-icon {
            color: var(--success-color);
        }
        
        .toast-error .toast-icon {
            color: var(--danger-color);
        }
        
        .toast-warning .toast-icon {
            color: var(--warning-color);
        }
        
        .toast-info .toast-icon {
            color: var(--secondary-color);
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .user-info-panel {
                position: fixed;
                top: 60px;
                right: 0;
                height: calc(100vh - 60px);
                z-index: 100;
                transform: translateX(100%);
                transition: var(--transition-fast);
                display: block;
                width: 280px;
            }
            
            .user-info-panel.show {
                transform: translateX(0);
            }
        }
        
        @media (max-width: 992px) {
            .chat-list-panel {
                width: 300px;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .chat-list-panel {
                width: 100%;
                height: 50%;
                border-right: none;
                border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            }
            
            .chat-view-panel {
                height: 50%;
            }
            
            .user-info-panel {
                width: 100%;
                height: 100%;
            }
        }
        
        @media (max-width: 576px) {
            .app-header {
                padding: 0 1rem;
            }
            
            .header-title {
                display: none;
            }
            
            .chat-view-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .view-actions {
                margin-top: 0.5rem;
            }
        }
        
        /* High contrast mode enhancements */
        @media (forced-colors: active) {
            .btn, 
            .action-btn,
            .form-control,
            .chat-input {
                border: 1px solid currentColor;
            }
            
            .message-content {
                border: 1px solid currentColor;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">
                    <img src="https://images4.imagebam.com/d3/36/5c/ME11M3EE_o.png" alt="Logo Poliția Locală">
                </div>
                <h1 class="auth-title">Autentificare Agent</h1>
                <p class="auth-subtitle">Introduceți datele de conectare pentru a accesa panoul de administrare</p>
            </div>
            
            <div class="auth-form">
                <div id="authError" class="auth-error">
                    Email sau parolă incorecte. Vă rugăm să încercați din nou.
                </div>
                
                <div class="form-group">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" id="email" class="form-control" placeholder="exemplu@email.ro" required>
                </div>
                
                <div class="form-group">
                    <label for="password" class="form-label">Parolă</label>
                    <input type="password" id="password" class="form-control" placeholder="••••••••" required>
                </div>
                
                <button id="loginBtn" class="btn btn-primary btn-lg btn-block">
                    Autentificare
                </button>
            </div>
            
            <div class="auth-footer">
                <p>Sistem de chat - Poliția Locală Slobozia</p>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="appScreen" class="app-container" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="header-logo">
                    <img src="https://images4.imagebam.com/d3/36/5c/ME11M3EE_o.png" alt="Logo Poliția Locală">
                    <h1 class="header-title">Chat Agent - Poliția Locală</h1>
                </div>
            </div>
            
            <div class="header-right">
                <div id="userDropdown" class="user-dropdown">
                    <div class="user-avatar" id="userInitials">PL</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Nume Agent</div>
                        <div class="user-role" id="userRole">Agent</div>
                    </div>
                    <i class="material-icons dropdown-toggle">arrow_drop_down</i>
                </div>
                
                <div id="dropdownMenu" class="dropdown-menu">
                    <a href="#" class="dropdown-item">
                        <i class="material-icons">account_circle</i>
                        Profil
                    </a>
                    <a href="#" class="dropdown-item">
                        <i class="material-icons">settings</i>
                        Setări
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="#" id="logoutBtn" class="dropdown-item">
                        <i class="material-icons">exit_to_app</i>
                        Deconectare
                    </a>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Chat List Panel -->
            <div class="chat-list-panel">
                <div class="chat-list-header">
                    <h2 class="panel-title">Conversații</h2>
                    <div class="chat-filter">
                        <button class="filter-btn active" data-filter="all">Toate</button>
                        <button class="filter-btn" data-filter="waiting">În așteptare</button>
                        <button class="filter-btn" data-filter="active">Active</button>
                    </div>
                    <div class="search-container">
                        <i class="material-icons search-icon">search</i>
                        <input type="text" class="search-input" id="searchChat" placeholder="Caută conversații...">
                    </div>
                </div>
                
                <div class="chat-list" id="chatList">
                    <!-- Chat items will be populated here -->
                </div>
            </div>
            
            <!-- Chat View Panel -->
            <div class="chat-view-panel">
                <!-- Empty state (shown when no chat is selected) -->
                <div id="emptyState" class="empty-state">
                    <i class="material-icons empty-state-icon">chat</i>
                    <h2 class="empty-state-title">Selectați o conversație</h2>
                    <p class="empty-state-text">Alegeți o conversație din lista din stânga pentru a începe să comunicați.</p>
                </div>
                
                <!-- Chat interface (hidden by default, shown when a chat is selected) -->
                <div id="chatInterface" style="display: none; height: 100%; flex-direction: column;">
                    <div class="chat-view-header">
                        <div class="user-details">
                            <div class="user-details-avatar" id="chatUserInitials">U</div>
                            <div class="user-details-info">
                                <div class="user-details-name" id="chatUserName">Nume Utilizator</div>
                                <div class="user-details-status">
                                    <span id="chatUserStatusIndicator" class="status-indicator status-active"></span>
                                    <span id="chatUserStatus">Online</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="view-actions">
                            <button class="action-btn" id="toggleInfoBtn" title="Informații utilizator">
                                <i class="material-icons">info</i>
                            </button>
                            <button class="action-btn" id="assignChatBtn" title="Preluare conversație">
                                <i class="material-icons">assignment_ind</i>
                            </button>
                            <button class="action-btn" id="transferChatBtn" title="Transfer conversație">
                                <i class="material-icons">swap_horiz</i>
                            </button>
                            <button class="action-btn btn-danger" id="endChatBtn" title="Încheiere conversație">
                                <i class="material-icons">close</i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="chat-view-body" id="chatViewBody">
                        <!-- Chat info card -->
                        <div class="chat-info-card">
                            <div class="info-title">
                                <i class="material-icons">info</i> Detalii conversație
                            </div>
                            <div class="info-content">
                                <div class="info-row">
                                    <div class="info-label">Subiect:</div>
                                    <div class="info-value" id="chatSubject">Problemă de trafic</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Departament:</div>
                                    <div class="info-value" id="chatDepartment">Circulație rutieră</div>
                                </div>
                                <div class="info-row">
                                    <div class="info-label">Data inițierii:</div>
                                    <div class="info-value" id="chatCreatedAt">25 Aprilie 2025, 14:30</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Messages container -->
                        <div class="message-container">
                            <div class="chat-messages" id="chatMessages">
                                <!-- Messages will be populated here -->
                            </div>
                            
                            <!-- Typing indicator (hidden by default) -->
                            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                                <span class="typing-dot"></span>
                                <span class="typing-dot"></span>
                                <span class="typing-dot"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-view-footer">
                        <div class="quick-responses" id="quickResponses">
                            <button class="quick-response">Bună ziua!</button>
                            <button class="quick-response">Vă mulțumim pentru raportare.</button>
                            <button class="quick-response">Un moment, vă rog.</button>
                            <button class="quick-response">Mai aveți întrebări?</button>
                        </div>
                        
                        <div class="chat-input-container">
                            <textarea id="messageInput" class="chat-input" placeholder="Scrieți un mesaj..." rows="1"></textarea>
                            
                            <div class="chat-actions">
                                <button id="templatesBtn" class="btn-action" title="Șabloane de răspuns">
                                    <i class="material-icons">format_list_bulleted</i>
                                </button>
                                <button id="sendMessageBtn" class="btn-action btn-send" title="Trimite mesaj">
                                    <i class="material-icons">send</i>
                                </button>
                            </div>
                            
                            <!-- Templates dropdown (hidden by default) -->
                            <div class="templates-dropdown" id="templatesDropdown">
                                <div class="templates-header">
                                    Șabloane de răspuns
                                </div>
                                <div class="templates-list" id="templatesList">
                                    <!-- Templates will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Info Panel (Right Sidebar) -->
            <div class="user-info-panel" id="userInfoPanel">
                <div class="user-info-header">
                    <h3 class="user-info-title">Informații utilizator</h3>
                    <div class="user-full-avatar" id="userFullInitials">JD</div>
                    <div class="user-full-name" id="userFullName">John Doe</div>
                    <div class="user-full-email" id="userFullEmail">
                        <i class="material-icons">email</i> 
                        <span>email@example.com</span>
                    </div>
                    <div class="user-full-phone" id="userFullPhone">
                        <i class="material-icons">phone</i>
                        <span>0700 000 000</span>
                    </div>
                </div>
                
                <div class="user-info-section">
                    <h4 class="section-title">Detalii dispozitiv</h4>
                    <div class="info-list">
                        <div class="info-item">
                            <div class="info-item-label">Browser</div>
                            <div class="info-item-value" id="userBrowser">Chrome 103.0.5060.134</div>
                        </div>
                        <div class="info-item">
                            <div class="info-item-label">Sistem de operare</div>
                            <div class="info-item-value" id="userOS">Windows 10</div>
                        </div>
                        <div class="info-item">
                            <div class="info-item-label">Limbă</div>
                            <div class="info-item-value" id="userLanguage">ro-RO</div>
                        </div>
                    </div>
                </div>
                
                <div class="user-info-section">
                    <h4 class="section-title">Locație</h4>
                    <div class="info-list">
                        <div class="info-item">
                            <div class="info-item-label">Adresă</div>
                            <div class="info-item-value" id="userLocation">Str. Exemplu nr. 1, Slobozia</div>
                        </div>
                    </div>
                </div>
                
                <div class="user-info-section">
                    <h4 class="section-title">Istoric conversații</h4>
                    <ul class="chat-timeline" id="chatTimeline">
                        <!-- Timeline items will be populated here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- Transfer Chat Modal -->
    <div id="transferModal" class="modal-backdrop">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">Transfer conversație</h3>
                <button class="modal-close" id="closeTransferModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="transferDepartment" class="form-label">Departament</label>
                    <select id="transferDepartment" class="form-control">
                        <option value="">Selectați departamentul</option>
                        <option value="traffic">Circulație Rutieră</option>
                        <option value="public-order">Ordine Publică</option>
                        <option value="environment">Protecția Mediului</option>
                        <option value="commerce">Control Comercial</option>
                        <option value="general">Informații Generale</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transferAgent" class="form-label">Agent</label>
                    <select id="transferAgent" class="form-control">
                        <option value="">Selectați agentul</option>
                        <!-- Agents will be populated here -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="transferNote" class="form-label">Notă (opțional)</label>
                    <textarea id="transferNote" class="form-control" rows="3" placeholder="Adăugați o notă pentru agent..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelTransferBtn" class="btn btn-secondary">Anulare</button>
                <button id="confirmTransferBtn" class="btn btn-primary">Transfer</button>
            </div>
        </div>
    </div>
    
    <!-- End Chat Confirmation Modal -->
    <div id="endChatModal" class="modal-backdrop">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">Încheiere conversație</h3>
                <button class="modal-close" id="closeEndChatModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Sunteți sigur că doriți să încheiați această conversație?</p>
                <div class="form-group">
                    <label for="endChatNote" class="form-label">Notă de încheiere (opțional)</label>
                    <textarea id="endChatNote" class="form-control" rows="3" placeholder="Adăugați o notă de încheiere..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelEndChatBtn" class="btn btn-secondary">Anulare</button>
                <button id="confirmEndChatBtn" class="btn btn-primary">Încheiere conversație</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toastContainer">
        <!-- Toast notifications will be added here dynamically -->
    </div>
    
    <!-- Firebase Configuration -->
    <script src="js/firebase-config.js"></script>
    
    <script>
        // DOM Elements
        const authScreen = document.getElementById('authScreen');
        const appScreen = document.getElementById('appScreen');
        const authError = document.getElementById('authError');
        const loginBtn = document.getElementById('loginBtn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const logoutBtn = document.getElementById('logoutBtn');
        const userDropdown = document.getElementById('userDropdown');
        const dropdownMenu = document.getElementById('dropdownMenu');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const userInitials = document.getElementById('userInitials');
        
        const chatList = document.getElementById('chatList');
        const emptyState = document.getElementById('emptyState');
        const chatInterface = document.getElementById('chatInterface');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        
        const userInfoPanel = document.getElementById('userInfoPanel');
        const toggleInfoBtn = document.getElementById('toggleInfoBtn');
        const assignChatBtn = document.getElementById('assignChatBtn');
        const transferChatBtn = document.getElementById('transferChatBtn');
        const endChatBtn = document.getElementById('endChatBtn');
        
        const chatUserName = document.getElementById('chatUserName');
        const chatUserInitials = document.getElementById('chatUserInitials');
        const chatUserStatus = document.getElementById('chatUserStatus');
        const chatUserStatusIndicator = document.getElementById('chatUserStatusIndicator');
        const chatSubject = document.getElementById('chatSubject');
        const chatDepartment = document.getElementById('chatDepartment');
        const chatCreatedAt = document.getElementById('chatCreatedAt');
        
        const userFullName = document.getElementById('userFullName');
        const userFullInitials = document.getElementById('userFullInitials');
        const userFullEmail = document.getElementById('userFullEmail').querySelector('span');
        const userFullPhone = document.getElementById('userFullPhone').querySelector('span');
        const userBrowser = document.getElementById('userBrowser');
        const userOS = document.getElementById('userOS');
        const userLanguage = document.getElementById('userLanguage');
        const userLocation = document.getElementById('userLocation');
        const chatTimeline = document.getElementById('chatTimeline');
        
        const transferModal = document.getElementById('transferModal');
        const closeTransferModal = document.getElementById('closeTransferModal');
        const cancelTransferBtn = document.getElementById('cancelTransferBtn');
        const confirmTransferBtn = document.getElementById('confirmTransferBtn');
        const transferDepartment = document.getElementById('transferDepartment');
        const transferAgent = document.getElementById('transferAgent');
        
        const endChatModal = document.getElementById('endChatModal');
        const closeEndChatModal = document.getElementById('closeEndChatModal');
        const cancelEndChatBtn = document.getElementById('cancelEndChatBtn');
        const confirmEndChatBtn = document.getElementById('confirmEndChatBtn');
        const endChatNote = document.getElementById('endChatNote');
        
        const templatesBtn = document.getElementById('templatesBtn');
        const templatesDropdown = document.getElementById('templatesDropdown');
        const templatesList = document.getElementById('templatesList');
        const quickResponses = document.getElementById('quickResponses');
        const searchChatInput = document.getElementById('searchChat');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const toastContainer = document.getElementById('toastContainer');
        
        // State variables
        let currentUser = null;
        let currentChatId = null;
        let currentChat = null;
        let userChats = [];
        let chatListeners = {};
        let templates = [];
        let departments = [];
        let agents = [];
        let isTyping = false;
        let typingTimeout = null;
        let lastTypingSent = 0;
        let currentFilter = 'all';
        let searchQuery = '';
        
        // ===========================
        // Authentication functions
        // ===========================
        
        // Handle login
        loginBtn.addEventListener('click', function() {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            
            if (!email || !password) {
                showAuthError('Vă rugăm să completați toate câmpurile.');
                return;
            }
            
            // Disable login button and show loading state
            loginBtn.disabled = true;
            loginBtn.textContent = 'Se autentifică...';
            
            // Sign in with email/password
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // Clear form
                    emailInput.value = '';
                    passwordInput.value = '';
                    hideAuthError();
                })
                .catch(error => {
                    console.error('Login error:', error);
                    showAuthError('Email sau parolă incorecte. Vă rugăm să încercați din nou.');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Autentificare';
                });
        });
        
        // Handle logout
        logoutBtn.addEventListener('click', function() {
            firebase.auth().signOut().catch(error => {
                console.error('Logout error:', error);
            });
        });
        
        // Show auth error
        function showAuthError(message) {
            authError.textContent = message;
            authError.style.display = 'block';
        }
        
        // Hide auth error
        function hideAuthError() {
            authError.style.display = 'none';
        }
        
        // Listen for auth state changes
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                currentUser = user;
                
                // Get user details from Firestore
                firebase.firestore().collection('users').doc(user.uid).get()
                    .then(doc => {
                        if (doc.exists) {
                            const userData = doc.data();
                            
                            // Update UI with user info
                            userName.textContent = userData.displayName || user.email;
                            userRole.textContent = capitalizeFirstLetter(userData.role || 'agent');
                            userInitials.textContent = getInitials(userData.displayName || user.email);
                            
                            // Show the app screen
                            authScreen.style.display = 'none';
                            appScreen.style.display = 'block';
                            
                            // Initialize the app
                            initializeApp(userData.role);
                        } else {
                            // User document doesn't exist - log out
                            console.error('User document not found');
                            firebase.auth().signOut();
                            showAuthError('Contul dvs. nu are acces la această aplicație.');
                        }
                    })
                    .catch(error => {
                        console.error('Error getting user data:', error);
                        firebase.auth().signOut();
                        showAuthError('Eroare la încărcarea datelor utilizatorului.');
                    });
            } else {
                // User is signed out
                currentUser = null;
                
                // Show the auth screen
                authScreen.style.display = 'flex';
                appScreen.style.display = 'none';
                
                // Reset login button
                loginBtn.disabled = false;
                loginBtn.textContent = 'Autentificare';
                
                // Clean up
                cleanupListeners();
            }
        });
        
        // ===========================
        // App initialization
        // ===========================
        
        // Initialize app
        function initializeApp(userRole) {
            // Load departments
            loadDepartments();
            
            // Load message templates
            loadTemplates();
            
            // Load chat list
            loadChatList();
            
            // Load agents for transfers
            loadAgents();
            
            // Set up event listeners
            setupEventListeners();
            
            // Show toast notification
            showToast('success', 'Conectat cu succes', 'Bine ați venit în panoul de administrare.');
        }
        
        // Load departments
        function loadDepartments() {
            firebase.firestore().collection('departments').get()
                .then(snapshot => {
                    departments = [];
                    snapshot.forEach(doc => {
                        departments.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading departments:', error);
                });
        }
        
        // Load templates
        function loadTemplates() {
            firebase.firestore().collection('templates').get()
                .then(snapshot => {
                    templates = [];
                    snapshot.forEach(doc => {
                        templates.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Populate templates dropdown
                    populateTemplates();
                })
                .catch(error => {
                    console.error('Error loading templates:', error);
                });
        }
        
        // Populate templates dropdown
        function populateTemplates() {
            // Clear the list
            templatesList.innerHTML = '';
            
            // Add templates to the list
            templates.forEach(template => {
                const templateItem = document.createElement('div');
                templateItem.className = 'template-item';
                templateItem.dataset.id = template.id;
                templateItem.innerHTML = `
                    <div class="template-title">${template.title}</div>
                    <div class="template-preview">${template.content.substring(0, 60)}${template.content.length > 60 ? '...' : ''}</div>
                `;
                
                // Add click event
                templateItem.addEventListener('click', function() {
                    messageInput.value = template.content;
                    templatesDropdown.classList.remove('show');
                    messageInput.focus();
                });
                
                templatesList.appendChild(templateItem);
            });
            
            // Populate quick responses
            quickResponses.innerHTML = '';
            
            // Get first 4 shortest templates for quick responses
            const shortTemplates = [...templates]
                .sort((a, b) => a.content.length - b.content.length)
                .slice(0, 4);
            
            shortTemplates.forEach(template => {
                const quickResponse = document.createElement('button');
                quickResponse.className = 'quick-response';
                quickResponse.textContent = template.content.substring(0, 30) + (template.content.length > 30 ? '...' : '');
                
                // Add click event
                quickResponse.addEventListener('click', function() {
                    messageInput.value = template.content;
                    messageInput.focus();
                });
                
                quickResponses.appendChild(quickResponse);
            });
        }
        
        // Load agents for transfers
        function loadAgents() {
            firebase.firestore().collection('users')
                .where('role', 'in', ['agent', 'supervisor', 'admin'])
                .get()
                .then(snapshot => {
                    agents = [];
                    snapshot.forEach(doc => {
                        if (doc.id !== currentUser.uid) { // Don't include current user
                            agents.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading agents:', error);
                });
        }
        
        // Load chat list
        function loadChatList() {
            // Query for chats based on user role
            // The security rules handle access control
            firebase.firestore().collection('chats')
                .orderBy('updatedAt', 'desc')
                .onSnapshot(snapshot => {
                    userChats = [];
                    
                    snapshot.forEach(doc => {
                        userChats.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Update the UI
                    updateChatList();
                }, error => {
                    console.error('Error loading chats:', error);
                    showToast('error', 'Eroare', 'Nu s-au putut încărca conversațiile.');
                });
        }
        
        // Update chat list UI
        function updateChatList() {
            // Clear the list
            chatList.innerHTML = '';
            
            // Filter chats based on current filter and search query
            let filteredChats = userChats;
            
            // Apply filter
            if (currentFilter !== 'all') {
                filteredChats = filteredChats.filter(chat => chat.status === currentFilter);
            }
            
            // Apply search
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filteredChats = filteredChats.filter(chat => 
                    (chat.userName && chat.userName.toLowerCase().includes(query)) ||
                    (chat.subject && chat.subject.toLowerCase().includes(query))
                );
            }
            
            // Show message if no chats
            if (filteredChats.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'chat-item';
                emptyItem.innerHTML = `
                    <div style="text-align: center; width: 100%; padding: 2rem 1rem; color: var(--text-secondary);">
                        Nu există conversații ${currentFilter !== 'all' ? 'în această categorie' : ''}.
                    </div>
                `;
                chatList.appendChild(emptyItem);
                return;
            }
            
            // Add chats to the list
            filteredChats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.dataset.id = chat.id;
                
                if (currentChatId === chat.id) {
                    chatItem.classList.add('active');
                }
                
                // Get the first letter of the user's name
                const initial = getInitials(chat.userName || 'Anonim');
                
                // Determine the avatar status class
                let statusClass = '';
                switch (chat.status) {
                    case 'waiting':
                        statusClass = 'status-waiting';
                        break;
                    case 'active':
                        statusClass = 'status-active';
                        break;
                    case 'closed':
                        statusClass = 'status-closed';
                        break;
                }
                
                // Determine priority class
                let priorityClass = '';
                switch (chat.priority) {
                    case 'high':
                        priorityClass = 'priority-high';
                        break;
                    case 'medium':
                        priorityClass = 'priority-medium';
                        break;
                }
                
                // Format the time
                const timeString = formatChatTime(chat.updatedAt);
                
                // Get department name
                const departmentName = getDepartmentName(chat.department);
                
                // Check if there are unread messages
                const unreadCount = chat.unreadCount || 0;
                
                chatItem.innerHTML = `
                    <div class="chat-avatar ${statusClass} ${priorityClass}">${initial}</div>
                    <div class="chat-info">
                        <div class="chat-info-header">
                            <div class="chat-name">${chat.userName || 'Anonim'}</div>
                            <div class="chat-time">${timeString}</div>
                        </div>
                        <div class="chat-subject">${chat.subject || 'Fără subiect'}</div>
                        <div class="chat-preview">${chat.lastMessage || 'Conversație nouă'}</div>
                        <div class="chat-meta">
                            <div class="chat-department">${departmentName}</div>
                            ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
                        </div>
                    </div>
                `;
                
                // Add click event
                chatItem.addEventListener('click', function() {
                    selectChat(chat.id);
                });
                
                chatList.appendChild(chatItem);
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // User dropdown
            userDropdown.addEventListener('click', function() {
                dropdownMenu.classList.toggle('show');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                if (!userDropdown.contains(event.target) && !dropdownMenu.contains(event.target)) {
                    dropdownMenu.classList.remove('show');
                }
            });
            
            // Toggle user info panel
            toggleInfoBtn.addEventListener('click', function() {
                userInfoPanel.classList.toggle('show');
            });
            
            // Templates button
            templatesBtn.addEventListener('click', function() {
                templatesDropdown.classList.toggle('show');
            });
            
            // Close templates dropdown when clicking outside
            document.addEventListener('click', function(event) {
                if (!templatesBtn.contains(event.target) && !templatesDropdown.contains(event.target)) {
                    templatesDropdown.classList.remove('show');
                }
            });
            
            // Assign chat button
            assignChatBtn.addEventListener('click', function() {
                if (currentChatId) {
                    assignChatToAgent(currentChatId, currentUser.uid);
                }
            });
            
            // Transfer chat button
            transferChatBtn.addEventListener('click', function() {
                if (currentChatId) {
                    // Populate agent dropdown based on selected department
                    populateAgentDropdown();
                    
                    // Show transfer modal
                    transferModal.classList.add('show');
                }
            });
            
            // Department change in transfer modal
            transferDepartment.addEventListener('change', function() {
                populateAgentDropdown();
            });
            
            // Close transfer modal
            closeTransferModal.addEventListener('click', function() {
                transferModal.classList.remove('show');
            });
            
            // Cancel transfer button
            cancelTransferBtn.addEventListener('click', function() {
                transferModal.classList.remove('show');
            });
            
            // Confirm transfer button
            confirmTransferBtn.addEventListener('click', function() {
                const departmentId = transferDepartment.value;
                const agentId = transferAgent.value;
                const note = transferNote.value.trim();
                
                if (!departmentId) {
                    showToast('error', 'Eroare', 'Vă rugăm să selectați un departament.');
                    return;
                }
                
                transferChat(currentChatId, departmentId, agentId, note);
                transferModal.classList.remove('show');
            });
            
            // End chat button
            endChatBtn.addEventListener('click', function() {
                if (currentChatId) {
                    // Show end chat modal
                    endChatModal.classList.add('show');
                }
            });
            
            // Close end chat modal
            closeEndChatModal.addEventListener('click', function() {
                endChatModal.classList.remove('show');
            });
            
            // Cancel end chat button
            cancelEndChatBtn.addEventListener('click', function() {
                endChatModal.classList.remove('show');
            });
            
            // Confirm end chat button
            confirmEndChatBtn.addEventListener('click', function() {
                const note = endChatNote.value.trim();
                
                endChat(currentChatId, note);
                endChatModal.classList.remove('show');
            });
            
            // Send message button
            sendMessageBtn.addEventListener('click', function() {
                sendMessage();
            });
            
            // Send message on Enter key
            messageInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });
            
            // Handle typing events
            messageInput.addEventListener('input', function() {
                handleTypingStart();
            });
            
            // Filter buttons
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Add active class to clicked button
                    button.classList.add('active');
                    
                    // Update filter
                    currentFilter = button.dataset.filter;
                    
                    // Update chat list
                    updateChatList();
                });
            });
            
            // Search input
            searchChatInput.addEventListener('input', function() {
                searchQuery = this.value.trim();
                updateChatList();
            });
        }
        
        // ===========================
        // Chat functions
        // ===========================
        
        // Select a chat
        function selectChat(chatId) {
            // If already selected, do nothing
            if (currentChatId === chatId) {
                return;
            }
            
            // Clean up previous chat listeners
            cleanupChatListeners();
            
            // Update current chat ID
            currentChatId = chatId;
            
            // Update UI - highlight selected chat
            const chatItems = document.querySelectorAll('.chat-item');
            chatItems.forEach(item => {
                if (item.dataset.id === chatId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // Show chat interface, hide empty state
            emptyState.style.display = 'none';
            chatInterface.style.display = 'flex';
            
            // Clear messages
            chatMessages.innerHTML = '';
            
            // Get chat data
            firebase.firestore().collection('chats').doc(chatId).get()
                .then(doc => {
                    if (doc.exists) {
                        currentChat = {
                            id: doc.id,
                            ...doc.data()
                        };
                        
                        // Update chat header
                        updateChatHeader(currentChat);
                        
                        // Update user info panel
                        updateUserInfoPanel(currentChat);
                        
                        // Load chat messages
                        loadChatMessages(chatId);
                        
                        // Set up typing indicator
                        setupTypingIndicator(chatId);
                        
                        // Update the UI based on chat status
                        updateUIForChatStatus(currentChat.status);
                        
                        // Mark as read
                        markChatAsRead(chatId);
                    } else {
                        console.error('Chat document does not exist');
                        showToast('error', 'Eroare', 'Conversația nu a fost găsită.');
                        
                        // Reset
                        currentChatId = null;
                        currentChat = null;
                        
                        // Show empty state
                        emptyState.style.display = 'flex';
                        chatInterface.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error getting chat document:', error);
                    showToast('error', 'Eroare', 'Nu s-a putut încărca conversația.');
                });
        }
        
        // Update chat header
        function updateChatHeader(chat) {
            // Set user name
            chatUserName.textContent = chat.userName || 'Anonim';
            
            // Set user initials
            chatUserInitials.textContent = getInitials(chat.userName || 'Anonim');
            
            // Set user status
            switch (chat.status) {
                case 'waiting':
                    chatUserStatus.textContent = 'În așteptare';
                    chatUserStatusIndicator.className = 'status-indicator status-waiting';
                    break;
                case 'active':
                    chatUserStatus.textContent = 'Activ';
                    chatUserStatusIndicator.className = 'status-indicator status-active';
                    break;
                case 'closed':
                    chatUserStatus.textContent = 'Închis';
                    chatUserStatusIndicator.className = 'status-indicator status-closed';
                    break;
            }
            
            // Set chat subject
            chatSubject.textContent = chat.subject || 'Fără subiect';
            
            // Set chat department
            chatDepartment.textContent = getDepartmentName(chat.department);
            
            // Set chat creation time
            chatCreatedAt.textContent = formatDateTime(chat.createdAt);
        }
        
        // Update user info panel
        function updateUserInfoPanel(chat) {
            // Set user name
            userFullName.textContent = chat.userName || 'Anonim';
            
            // Set user initials
            userFullInitials.textContent = getInitials(chat.userName || 'Anonim');
            
            // Set user email
            userFullEmail.textContent = chat.userEmail || 'N/A';
            
            // Set user phone
            userFullPhone.textContent = chat.userPhone || 'N/A';
            
            // Set user device info
            if (chat.conversationData) {
                userBrowser.textContent = chat.conversationData.clientBrowser || 'N/A';
                userOS.textContent = chat.conversationData.clientPlatform || 'N/A';
                userLanguage.textContent = chat.conversationData.clientLanguage || 'N/A';
            } else {
                userBrowser.textContent = 'N/A';
                userOS.textContent = 'N/A';
                userLanguage.textContent = 'N/A';
            }
            
            // Set user location
            userLocation.textContent = chat.userLocation || 'Locație necunoscută';
            
            // Load chat history for this user
            loadUserChatHistory(chat.userId);
        }
        
        // Load chat history for user
        function loadUserChatHistory(userId) {
            if (!userId) return;
            
            // Clear timeline
            chatTimeline.innerHTML = '';
            
            // Query for previous chats from this user
            firebase.firestore().collection('chats')
                .where('userId', '==', userId)
                .where('status', '==', 'closed')
                .orderBy('createdAt', 'desc')
                .limit(5)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        chatTimeline.innerHTML = '<div style="padding: 1rem; color: var(--text-secondary);">Nu există conversații anterioare.</div>';
                        return;
                    }
                    
                    snapshot.forEach(doc => {
                        const chat = doc.data();
                        
                        // Skip current chat
                        if (doc.id === currentChatId) return;
                        
                        const timelineItem = document.createElement('li');
                        timelineItem.className = 'timeline-item';
                        
                        // Determine icon based on department
                        let iconClass = 'message';
                        switch (chat.department) {
                            case 'traffic':
                                iconClass = 'directions_car';
                                break;
                            case 'public-order':
                                iconClass = 'public';
                                break;
                            case 'environment':
                                iconClass = 'nature';
                                break;
                            case 'commerce':
                                iconClass = 'store';
                                break;
                        }
                        
                        timelineItem.innerHTML = `
                            <div class="timeline-icon">
                                <i class="material-icons" style="font-size: 12px;">${iconClass}</i>
                            </div>
                            <div class="timeline-content">
                                <div>${chat.subject || 'Conversație'}</div>
                                <div class="timeline-time">${formatDateTime(chat.createdAt)}</div>
                            </div>
                        `;
                        
                        chatTimeline.appendChild(timelineItem);
                    });
                })
                .catch(error => {
                    console.error('Error loading user chat history:', error);
                    chatTimeline.innerHTML = '<div style="padding: 1rem; color: var(--danger-color);">Eroare la încărcarea istoricului.</div>';
                });
        }
        
        // Load chat messages
        function loadChatMessages(chatId) {
            // Listen for messages
            chatListeners.messages = firebase.firestore().collection('chats').doc(chatId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const message = {
                                id: change.doc.id,
                                ...change.doc.data()
                            };
                            
                            // If the message has encrypted content, decrypt it
                            if (message.encrypted && message.content && currentChat && currentChat.key) {
                                try {
                                    message.content = decryptMessage(message.content, currentChat.key);
                                } catch (error) {
                                    console.error('Error decrypting message:', error);
                                    message.content = '[Mesaj criptat]';
                                }
                            }
                            
                            // Add message to UI
                            displayMessage(message);
                            
                            // Scroll to bottom
                            scrollToBottom();
                        }
                    });
                }, error => {
                    console.error('Error loading messages:', error);
                    showToast('error', 'Eroare', 'Nu s-au putut încărca mesajele.');
                });
        }
        
        // Setup typing indicator
        function setupTypingIndicator(chatId) {
            // Listen for typing indicators
            chatListeners.typing = firebase.firestore().collection('chats').doc(chatId)
                .collection('typing')
                .doc('user')
                .onSnapshot(doc => {
                    if (doc.exists && doc.data().isTyping) {
                        showUserTyping();
                    } else {
                        hideUserTyping();
                    }
                }, error => {
                    console.error('Error in typing indicator listener:', error);
                });
        }
        
        // Update UI based on chat status
        function updateUIForChatStatus(status) {
            // Button visibility based on status
            switch (status) {
                case 'waiting':
                    // Show assign button, hide transfer button
                    assignChatBtn.style.display = 'flex';
                    transferChatBtn.style.display = 'none';
                    endChatBtn.style.display = 'none';
                    
                    // Disable message input
                    messageInput.disabled = true;
                    sendMessageBtn.disabled = true;
                    templatesBtn.disabled = true;
                    
                    // Show notice
                    let noticeEl = document.getElementById('waitingNotice');
                    if (!noticeEl) {
                        noticeEl = document.createElement('div');
                        noticeEl.id = 'waitingNotice';
                        noticeEl.className = 'message system-message';
                        noticeEl.innerHTML = 'Această conversație este în așteptare. Apăsați pe "Preluare conversație" pentru a răspunde.';
                        chatMessages.appendChild(noticeEl);
                    }
                    break;
                    
                case 'active':
                    // Hide assign button, show transfer and end chat buttons
                    assignChatBtn.style.display = 'none';
                    transferChatBtn.style.display = 'flex';
                    endChatBtn.style.display = 'flex';
                    
                    // Enable message input
                    messageInput.disabled = false;
                    sendMessageBtn.disabled = false;
                    templatesBtn.disabled = false;
                    
                    // Remove waiting notice if exists
                    const waitingNotice = document.getElementById('waitingNotice');
                    if (waitingNotice) {
                        waitingNotice.remove();
                    }
                    break;
                    
                case 'closed':
                    // Hide all action buttons
                    assignChatBtn.style.display = 'none';
                    transferChatBtn.style.display = 'none';
                    endChatBtn.style.display = 'none';
                    
                    // Disable message input
                    messageInput.disabled = true;
                    sendMessageBtn.disabled = true;
                    templatesBtn.disabled = true;
                    
                    // Show notice
                    let closedNoticeEl = document.getElementById('closedNotice');
                    if (!closedNoticeEl) {
                        closedNoticeEl = document.createElement('div');
                        closedNoticeEl.id = 'closedNotice';
                        closedNoticeEl.className = 'message system-message';
                        closedNoticeEl.innerHTML = 'Această conversație a fost încheiată.';
                        chatMessages.appendChild(closedNoticeEl);
                    }
                    break;
            }
        }
        
        // Mark chat as read
        function markChatAsRead(chatId) {
            firebase.firestore().collection('chats').doc(chatId).update({
                unreadCount: 0
            }).catch(error => {
                console.error('Error marking chat as read:', error);
            });
        }
        
// Display a message
            function displayMessage(message) {
                // Check if message already exists
                if (document.querySelector(`[data-message-id="${message.id}"]`)) {
                    return;
                }
                
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.dataset.messageId = message.id;
                
                // Format timestamp
                let timeString = 'Acum';
                if (message.timestamp) {
                    const timestamp = message.timestamp.toDate ? message.timestamp.toDate() : new Date();
                    timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
                
                // Handle different message types
                if (message.type === 'system') {
                    // System message
                    messageElement.className = 'message system-message';
                    messageElement.textContent = message.content;
                } else if (message.type === 'user') {
                    // User message
                    messageElement.classList.add('user-message');
                    
                    messageElement.innerHTML = `
                        <div class="message-content">
                            ${message.content}
                        </div>
                        <div class="message-meta">
                            <span class="message-time">${timeString}</span>
                        </div>
                    `;
                } else if (message.type === 'agent') {
                    // Agent message
                    messageElement.classList.add('agent-message');
                    
                    messageElement.innerHTML = `
                        <div class="message-content">
                            ${message.content}
                        </div>
                        <div class="message-meta">
                            <span class="message-time">${timeString}</span>
                            <span class="message-status">
                                ${message.sender ? message.sender.name : ''}
                            </span>
                        </div>
                    `;
                }
                
                // Add to chat
                chatMessages.appendChild(messageElement);
                
                // Scroll to bottom
                scrollToBottom();
            }
            
            // Scroll chat to bottom
            function scrollToBottom() {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Show user typing indicator
            function showUserTyping() {
                typingIndicator.style.display = 'flex';
                scrollToBottom();
            }
            
            // Hide user typing indicator
            function hideUserTyping() {
                typingIndicator.style.display = 'none';
            }
            
            // ===========================
            // Messaging functions
            // ===========================
            
            // Send a message
            function sendMessage() {
                const text = messageInput.value.trim();
                
                if (!text || !currentChatId || currentChat.status !== 'active') {
                    return;
                }
                
                // Disable input during send
                messageInput.disabled = true;
                sendMessageBtn.disabled = true;
                
                // Create the message object
                const messageObj = {
                    type: 'agent',
                    content: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    sender: {
                        id: currentUser.uid,
                        name: userName.textContent
                    },
                    status: 'sent'
                };
                
                // Check if chat is encrypted
                if (currentChat.key) {
                    try {
                        messageObj.content = encryptMessage(text, currentChat.key);
                        messageObj.encrypted = true;
                    } catch (error) {
                        console.error('Error encrypting message:', error);
                    }
                }
                
                // Send message to Firestore
                firebase.firestore().collection('chats').doc(currentChatId)
                    .collection('messages').add(messageObj)
                    .then(() => {
                        // Clear input
                        messageInput.value = '';
                        
                        // Reset typing indicator
                        clearTimeout(typingTimeout);
                        isTyping = false;
                        
                        // Update chat's last activity
                        return firebase.firestore().collection('chats').doc(currentChatId).update({
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastMessage: text,
                            lastMessageSender: 'agent'
                        });
                    })
                    .then(() => {
                        // Re-enable input
                        messageInput.disabled = false;
                        sendMessageBtn.disabled = false;
                        messageInput.focus();
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);
                        showToast('error', 'Eroare', 'Nu s-a putut trimite mesajul.');
                        
                        // Re-enable input
                        messageInput.disabled = false;
                        sendMessageBtn.disabled = false;
                    });
            }
            
            // Handle typing indicators
            function handleTypingStart() {
                // Only send typing indicator if not already typing
                // and not too frequently (no more than once every 3 seconds)
                const now = Date.now();
                if (!isTyping || now - lastTypingSent > 3000) {
                    isTyping = true;
                    lastTypingSent = now;
                    
                    // Send typing indicator to Firestore
                    firebase.firestore().collection('chats').doc(currentChatId)
                        .collection('typing')
                        .doc('agent')
                        .set({
                            isTyping: true,
                            agentId: currentUser.uid,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }).catch(error => {
                            console.error('Error updating typing status:', error);
                        });
                }
                
                // Clear previous timeout
                clearTimeout(typingTimeout);
                
                // Set new timeout to clear typing indicator after 3 seconds of inactivity
                typingTimeout = setTimeout(() => {
                    isTyping = false;
                    
                    // Send typing stopped indicator
                    firebase.firestore().collection('chats').doc(currentChatId)
                        .collection('typing')
                        .doc('agent')
                        .set({
                            isTyping: false,
                            agentId: currentUser.uid,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }).catch(error => {
                            console.error('Error updating typing status:', error);
                        });
                }, 3000);
            }
            
            // ===========================
            // Chat management functions
            // ===========================
            
            // Assign chat to current agent
            function assignChatToAgent(chatId, agentId) {
                if (!chatId || !agentId) return;
                
                // Update chat document
                firebase.firestore().collection('chats').doc(chatId)
                    .update({
                        agentId: agentId,
                        agentName: userName.textContent,
                        status: 'active',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    })
                    .then(() => {
                        // Add system message
                        return firebase.firestore().collection('chats').doc(chatId)
                            .collection('messages').add({
                                type: 'system',
                                content: `Agent ${userName.textContent} s-a alăturat conversației.`,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                    })
                    .then(() => {
                        // Update UI
                        currentChat.status = 'active';
                        currentChat.agentId = agentId;
                        currentChat.agentName = userName.textContent;
                        
                        updateUIForChatStatus('active');
                        showToast('success', 'Succes', 'Ați preluat cu succes această conversație.');
                    })
                    .catch(error => {
                        console.error('Error assigning chat:', error);
                        showToast('error', 'Eroare', 'Nu s-a putut prelua conversația.');
                    });
            }
            
            // Transfer chat to another agent or department
            function transferChat(chatId, departmentId, agentId, note) {
                if (!chatId || !departmentId) return;
                
                // Prepare update data
                const updateData = {
                    department: departmentId,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // If an agent is selected, assign directly to them
                if (agentId) {
                    updateData.agentId = agentId;
                    
                    // Get agent name
                    const agent = agents.find(a => a.id === agentId);
                    if (agent) {
                        updateData.agentName = agent.displayName;
                    }
                } else {
                    // Reset agent assignment
                    updateData.agentId = null;
                    updateData.agentName = null;
                    updateData.status = 'waiting';
                }
                
                // Update chat document
                firebase.firestore().collection('chats').doc(chatId)
                    .update(updateData)
                    .then(() => {
                        // Add system message
                        let message = `Conversația a fost transferată la departamentul ${getDepartmentName(departmentId)}.`;
                        
                        if (agentId) {
                            const agent = agents.find(a => a.id === agentId);
                            if (agent) {
                                message = `Conversația a fost transferată la agentul ${agent.displayName}.`;
                            }
                        }
                        
                        if (note) {
                            message += ` Notă: ${note}`;
                        }
                        
                        return firebase.firestore().collection('chats').doc(chatId)
                            .collection('messages').add({
                                type: 'system',
                                content: message,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                    })
                    .then(() => {
                        showToast('success', 'Succes', 'Conversația a fost transferată cu succes.');
                        
                        // If not assigned to a specific agent, go back to empty state
                        if (!agentId) {
                            currentChatId = null;
                            currentChat = null;
                            emptyState.style.display = 'flex';
                            chatInterface.style.display = 'none';
                            userInfoPanel.classList.remove('show');
                            updateChatList();
                        }
                    })
                    .catch(error => {
                        console.error('Error transferring chat:', error);
                        showToast('error', 'Eroare', 'Nu s-a putut transfera conversația.');
                    });
            }
            
            // Populate agent dropdown for transfers
            function populateAgentDropdown() {
                // Clear current options except the first one
                while (transferAgent.options.length > 1) {
                    transferAgent.remove(1);
                }
                
                // Get selected department
                const departmentId = transferDepartment.value;
                
                // Filter agents by department
                let filteredAgents = agents;
                if (departmentId) {
                    filteredAgents = agents.filter(agent => 
                        !agent.department || agent.department === departmentId || agent.role === 'admin'
                    );
                }
                
                // Add agents to dropdown
                filteredAgents.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent.id;
                    option.textContent = `${agent.displayName || agent.email} (${capitalizeFirstLetter(agent.role)})`;
                    transferAgent.appendChild(option);
                });
            }
            
            // End chat
            function endChat(chatId, note) {
                if (!chatId) return;
                
                // Update chat document
                firebase.firestore().collection('chats').doc(chatId)
                    .update({
                        status: 'closed',
                        closedBy: 'agent',
                        closedById: currentUser.uid,
                        closedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    })
                    .then(() => {
                        // Add system message
                        let message = 'Conversația a fost încheiată de agent.';
                        
                        if (note) {
                            message += ` Notă: ${note}`;
                        }
                        
                        return firebase.firestore().collection('chats').doc(chatId)
                            .collection('messages').add({
                                type: 'system',
                                content: message,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                    })
                    .then(() => {
                        // Update UI
                        currentChat.status = 'closed';
                        updateUIForChatStatus('closed');
                        showToast('success', 'Succes', 'Conversația a fost încheiată cu succes.');
                    })
                    .catch(error => {
                        console.error('Error ending chat:', error);
                        showToast('error', 'Eroare', 'Nu s-a putut încheia conversația.');
                    });
            }
            
            // ===========================
            // Utility functions
            // ===========================
            
            // Get initials from name
            function getInitials(name) {
                if (!name) return 'A';
                
                const nameParts = name.split(' ');
                if (nameParts.length === 1) {
                    return name.charAt(0).toUpperCase();
                }
                
                return (nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0)).toUpperCase();
            }
            
            // Format chat time
            function formatChatTime(timestamp) {
                if (!timestamp) return 'Acum';
                
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                const now = new Date();
                const diff = Math.floor((now - date) / 1000 / 60); // diff in minutes
                
                if (diff < 1) return 'Acum';
                if (diff < 60) return `Acum ${diff} minute`;
                
                const diffHours = Math.floor(diff / 60);
                if (diffHours < 24) return `Acum ${diffHours} ore`;
                
                const diffDays = Math.floor(diffHours / 24);
                if (diffDays < 7) return `Acum ${diffDays} zile`;
                
                return date.toLocaleDateString('ro-RO');
            }
            
            // Format date and time
            function formatDateTime(timestamp) {
                if (!timestamp) return 'N/A';
                
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleDateString('ro-RO') + ' ' + date.toLocaleTimeString('ro-RO', { hour: '2-digit', minute: '2-digit' });
            }
            
            // Capitalize first letter
            function capitalizeFirstLetter(string) {
                if (!string) return '';
                return string.charAt(0).toUpperCase() + string.slice(1);
            }
            
            // Get department name from ID
            function getDepartmentName(departmentId) {
                if (!departmentId) return 'Nedefinit';
                
                // Default department names
                const defaultNames = {
                    'traffic': 'Circulație Rutieră',
                    'public-order': 'Ordine Publică',
                    'environment': 'Protecția Mediului',
                    'commerce': 'Control Comercial',
                    'general': 'Informații Generale'
                };
                
                // Check if we have the department loaded
                const department = departments.find(d => d.id === departmentId);
                if (department) {
                    return department.name;
                }
                
                // Fallback to default names
                return defaultNames[departmentId] || departmentId;
            }
            
            // Show toast notification
            function showToast(type, title, message) {
                const toastId = 'toast-' + Date.now();
                const toast = document.createElement('div');
                toast.id = toastId;
                toast.className = `toast toast-${type}`;
                
                // Icon based on type
                let icon = '';
                switch (type) {
                    case 'success':
                        icon = 'check_circle';
                        break;
                    case 'error':
                        icon = 'error';
                        break;
                    case 'warning':
                        icon = 'warning';
                        break;
                    case 'info':
                        icon = 'info';
                        break;
                }
                
                toast.innerHTML = `
                    <i class="material-icons toast-icon">${icon}</i>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close">&times;</button>
                `;
                
                // Add to container
                toastContainer.appendChild(toast);
                
                // Add close event
                toast.querySelector('.toast-close').addEventListener('click', function() {
                    removeToast(toastId);
                });
                
                // Show toast with animation
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);
                
                // Auto-remove after 4 seconds
                setTimeout(() => {
                    removeToast(toastId);
                }, 4000);
            }
            
            // Remove toast notification
            function removeToast(toastId) {
                const toast = document.getElementById(toastId);
                if (toast) {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            }
            
            // ===========================
            // Encryption / Decryption
            // ===========================
            
            // Encrypt a message
            function encryptMessage(message, key) {
                try {
                    if (!key) return message; // Fallback for demo
                    return CryptoJS.AES.encrypt(message, key).toString();
                } catch (error) {
                    console.error('Encryption error:', error);
                    return message; // Fallback
                }
            }
            
            // Decrypt a message
            function decryptMessage(encryptedMessage, key) {
                try {
                    if (!key) return encryptedMessage; // Fallback for demo
                    const bytes = CryptoJS.AES.decrypt(encryptedMessage, key);
                    return bytes.toString(CryptoJS.enc.Utf8);
                } catch (error) {
                    console.error('Decryption error:', error);
                    return '[Mesaj criptat]'; // Fallback
                }
            }
            
            // ===========================
            // Cleanup
            // ===========================
            
            // Clean up listeners for current chat
            function cleanupChatListeners() {
                // Clean up message listener
                if (chatListeners.messages) {
                    chatListeners.messages();
                    chatListeners.messages = null;
                }
                
                // Clean up typing listener
                if (chatListeners.typing) {
                    chatListeners.typing();
                    chatListeners.typing = null;
                }
            }
            
            // Clean up all listeners
            function cleanupListeners() {
                cleanupChatListeners();
                
                // Clean up any other listeners
                // ...
            }
        
    </script>
</body>
</html>
