<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Chat online cu Poliția Locală Slobozia pentru raportarea problemelor non-urgente">
    <meta name="theme-color" content="#1A2F5F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Chat - Poliția Locală Slobozia</title>
    
    <!-- Firebase SDK - Optimized version -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-functions-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Reset & Base Styles */
        :root {
            --primary-color: #1A2F5F;
            --primary-dark: #0F1B38;
            --primary-light: rgba(26, 47, 95, 0.05);
            --primary-gradient: linear-gradient(135deg, #1A2F5F 0%, #253F78 100%);
            --secondary-color: #1E88E5;
            --secondary-light: rgba(30, 136, 229, 0.2);
            --secondary-dark: #1565C0;
            --secondary-gradient: linear-gradient(135deg, #1E88E5 0%, #1976D2 100%);
            --accent-color: #FFCA28;
            --accent-dark: #FFC107;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-light: #FFFFFF;
            --background-light: #F5F7FA;
            --background-dark: #172B4D;
            --background-gradient: linear-gradient(to bottom, #F5F7FA 0%, #EAEEF5 100%);
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --border-radius-small: 12px;
            --border-radius-medium: 16px;
            --border-radius-large: 22px;
            --shadow-small: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 6px 20px rgba(0, 0, 0, 0.15);
            --shadow-large: 0 10px 30px rgba(0, 0, 0, 0.2);
            --shadow-float: 0 10px 24px rgba(26, 47, 95, 0.08), 0 2px 8px rgba(26, 47, 95, 0.1);
            --shadow-card: 0 4px 20px rgba(26, 47, 95, 0.08), 0 2px 6px rgba(26, 47, 95, 0.04), 0 0 1px rgba(26, 47, 95, 0.12);
            --transition-fast: all 0.3s ease;
            --transition-medium: all 0.5s ease;
            --font-size-base: 16px;
            --font-size-large: 18px;
            --font-size-xl: 20px;
            --font-size-xxl: 24px;
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: auto;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            font-size: var(--font-size-base);
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--background-light);
            background-image: url('https://images4.imagebam.com/e7/9c/be/ME11NTZI_o.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            margin-bottom: var(--spacing-md);
        }
        
        a:focus, button:focus, input:focus, select:focus, textarea:focus {
            outline: 3px solid var(--secondary-light);
            outline-offset: 2px;
        }
        
        button, input, textarea {
            font-family: inherit;
            font-size: inherit;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* App Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            overflow: hidden;
            background-color: white;
            box-shadow: var(--shadow-card);
        }
        
        /* Header */
        .app-header {
            background-image: var(--primary-gradient);
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-medium);
            z-index: 10;
            height: 70px;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }
        
        .header-logo {
            width: 40px;
            height: 40px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--spacing-sm);
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: var(--transition-fast);
        }
        
        .header-logo:hover {
            transform: scale(1.05);
        }
        
        .header-logo img {
            width: 32px;
            height: 32px;
        }
        
        .header-title {
            font-size: var(--font-size-large);
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        
        .header-status {
            font-size: calc(var(--font-size-base) - 2px);
            opacity: 0.9;
            margin-top: -2px;
            display: flex;
            align-items: center;
        }
        
        .header-status::before {
            content: "";
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--success-color);
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .header-actions {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .header-actions a {
            text-decoration: none;
            color: white;
        }
        
        .header-actions button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: var(--font-size-xl);
            cursor: pointer;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }
        
        .header-button-with-text {
            min-width: 36px;
            height: 36px;
        }
        
        .header-button-with-text span {
            display: none;
        }
        
        .header-actions button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        /* Main Content Area */
        .app-content {
            flex: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--spacing-lg) var(--spacing-lg);
            height: 100%;
            background: linear-gradient(to bottom, rgba(26, 47, 95, 0.92) 0%, rgba(26, 47, 95, 0.85) 100%), url('https://images4.imagebam.com/c0/05/ef/ME11M3FT_o.png');
            background-size: cover;
            background-position: center;
            color: var(--text-light);
        }
        
        .welcome-title {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: var(--spacing-md);
            letter-spacing: 0.5px;
        }
        
        .welcome-description {
            font-size: var(--font-size-base);
            margin-bottom: var(--spacing-lg);
            max-width: 600px;
            line-height: 1.7;
        }
        
        .welcome-logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--spacing-lg);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
        }
        
        .welcome-logo img {
            width: 60px;
            height: 60px;
        }
        
        /* Phone Verification Screen */
        .phone-verification {
            padding: var(--spacing-lg) var(--spacing-lg);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            background-color: white;
        }
        
        .verification-title {
            font-size: var(--font-size-xl);
            color: var(--primary-color);
            margin-bottom: var(--spacing-md);
            text-align: center;
        }
        
        .verification-description {
            font-size: var(--font-size-base);
            margin-bottom: var(--spacing-lg);
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.7;
        }
        
        .phone-input-group {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius-small);
            overflow: hidden;
        }
        
        .phone-prefix {
            background-color: var(--background-light);
            padding: var(--spacing-sm) var(--spacing-md);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .phone-input-group input {
            flex: 1;
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: var(--font-size-base);
            outline: none;
        }
        
        .verification-code-section {
            margin-top: var(--spacing-xl);
        }
        
        .code-input-group {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }
        
        .code-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: var(--font-size-xl);
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius-small);
            transition: var(--transition-fast);
        }
        
        .code-input:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
        }
        
        .retry-message {
            text-align: center;
            color: var(--text-secondary);
            margin-top: var(--spacing-md);
        }
        
        .retry-timer {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        /* Emergency Check */
        .emergency-check {
            padding: var(--spacing-lg) var(--spacing-lg) var(--spacing-lg);
            background-color: white;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-width: 700px;
            margin: 0 auto;
            width: 100%;
        }
        
        .emergency-title {
            font-size: var(--font-size-xl);
            color: var(--danger-color);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
        }
        
        .emergency-title i {
            margin-right: var(--spacing-sm);
        }
        
        .emergency-text {
            font-size: var(--font-size-base);
            margin-bottom: var(--spacing-lg);
            color: var(--text-primary);
            line-height: 1.7;
        }
        
        .emergency-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        /* Department Selection */
        .department-select {
            padding: var(--spacing-md) var(--spacing-lg);
            height: 100%;
            overflow-y: auto;
            display: none;
            flex-direction: column;
            background-color: white;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }
        
        .department-title {
            font-size: var(--font-size-large);
            margin-bottom: var(--spacing-lg);
            text-align: center;
            color: var(--primary-color);
        }
        
        .department-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .department-item {
            padding: var(--spacing-md);
            border-radius: var(--border-radius-medium);
            background-color: var(--background-light);
            box-shadow: var(--shadow-small);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .department-item:active {
            transform: scale(0.98);
        }
        
        .department-item:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-3px);
            background-color: white;
        }
        
        .department-icon {
            width: 56px;
            height: 56px;
            background-color: var(--secondary-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--spacing-sm);
            color: var(--secondary-color);
            flex-shrink: 0;
            transition: var(--transition-fast);
        }
        
        .department-item:hover .department-icon {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .department-icon i {
            font-size: 28px;
        }
        
        .department-info {
            flex: 1;
        }
        
        .department-name {
            font-weight: 600;
            font-size: var(--font-size-base);
            margin-bottom: 4px;
        }
        
        .department-description {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* Pre-Chat Form */
        .chat-form {
            padding: var(--spacing-lg);
            overflow-y: auto;
            height: 100%;
            display: none;
            flex-direction: column;
            background-color: white;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        
        .form-title {
            font-size: var(--font-size-large);
            color: var(--primary-color);
            margin-bottom: var(--spacing-md);
            text-align: center;
        }
        
        .form-group {
            margin-bottom: var(--spacing-md);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            color: var(--text-primary);
            font-size: var(--font-size-base);
        }
        
        .form-control {
            width: 100%;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-small);
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-color: var(--background-light);
            transition: var(--transition-fast);
            font-size: var(--font-size-base);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1), inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .form-check {
            display: flex;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
            min-height: 36px;
        }
        
        .form-check-input {
            margin-right: var(--spacing-sm);
            margin-top: 4px;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .form-check-label {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            flex: 1;
        }
        
        .form-check-label a {
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 500;
        }
        
        .form-check-label a:hover {
            text-decoration: underline;
        }
        
        .gdpr-info {
            margin-top: var(--spacing-md);
            font-size: 13px;
            color: var(--text-secondary);
            background-color: rgba(0, 0, 0, 0.03);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-small);
            line-height: 1.5;
        }
        
        /* Chat Area */
        .chat-area {
            height: 100%;
            display: flex;
            flex-direction: column;
            display: none;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--background-light);
            display: flex;
            flex-direction: column;
            -webkit-overflow-scrolling: touch;
        }
        
        .message {
            margin-bottom: var(--spacing-sm);
            max-width: 85%;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-received {
            align-self: flex-start;
        }
        
        .message-sent {
            align-self: flex-end;
        }
        
        .message-content {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-medium);
            position: relative;
            font-size: var(--font-size-base);
            box-shadow: var(--shadow-small);
            line-height: 1.6;
            transition: transform 0.2s ease;
        }
        
        .message-received .message-content {
            background-color: white;
            border-bottom-left-radius: 4px;
        }
        
        .message-sent .message-content {
            background-image: var(--secondary-gradient);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-content:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .message-meta {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin-top: 2px;
            padding: 0 var(--spacing-xs);
        }
        
        .message-time {
            color: var(--text-secondary);
        }
        
        .message-status {
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }
        
        .message-status i {
            font-size: 12px;
            margin-left: 4px;
        }
        
        .message-system {
            align-self: center;
            max-width: 90%;
            background-color: rgba(0,0,0,0.05);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-small);
            margin-bottom: var(--spacing-sm);
            text-align: center;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .chat-input {
            padding: var(--spacing-xs) var(--spacing-sm);
            background-color: white;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .chat-input-field {
            flex: 1;
            padding: var(--spacing-sm);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 28px;
            background-color: var(--background-light);
            transition: var(--transition-fast);
            font-size: var(--font-size-base);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            min-height: 46px;
            resize: none;
        }
        
        .chat-input-field:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1), inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .chat-actions {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .chat-action {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--secondary-light);
            color: var(--secondary-color);
            border: none;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .chat-action:hover, .chat-action:active {
            background-color: var(--secondary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-small);
        }
        
        .chat-action i {
            font-size: 22px;
        }
        
        .chat-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .chat-action-send {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .chat-action-send:hover {
            background-color: var(--secondary-dark);
        }
        
        /* Chat End */
        .chat-end {
            padding: var(--spacing-lg);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
        }
        
        .chat-end-icon {
            font-size: 48px;
            color: var(--success-color);
            margin-bottom: var(--spacing-sm);
            animation: scaleIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes scaleIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .chat-end-title {
            font-size: var(--font-size-xl);
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
        }
        
        .chat-end-text {
            margin-bottom: var(--spacing-lg);
            color: var(--text-secondary);
            font-size: var(--font-size-base);
            max-width: 600px;
        }
        
        /* Loading State */
        .loading-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            gap: var(--spacing-md);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Notices */
        .notice {
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            border-radius: var(--border-radius-small);
            font-size: 14px;
            display: none;
            box-shadow: var(--shadow-small);
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .error-notice {
            background-color: rgba(244, 67, 54, 0.1);
            border-left: 4px solid var(--danger-color);
            color: var(--danger-color);
        }
        
        .success-notice {
            background-color: rgba(76, 175, 80, 0.1);
            border-left: 4px solid var(--success-color);
            color: var(--success-color);
        }
        
        /* Typing Animation */
        @keyframes typingAnimation {
            0% { opacity: 0.3; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-2px); }
            100% { opacity: 0.3; transform: translateY(0); }
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            margin: 8px 0;
            align-self: flex-start;
            background: white;
            padding: 10px 14px;
            border-radius: var(--border-radius-medium);
            box-shadow: var(--shadow-small);
        }
        
        .typing-dot {
            height: 8px;
            width: 8px;
            margin: 0 2px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: inline-block;
            animation: typingAnimation 1.5s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-medium);
            font-weight: 600;
            text-decoration: none;
            transition: var(--transition-fast);
            font-size: var(--font-size-base);
            border: none;
            cursor: pointer;
            min-height: 48px;
            width: 100%;
            max-width: 280px;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .btn:hover::after {
            transform: translateY(0);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background-image: var(--secondary-gradient);
            color: white;
            box-shadow: var(--shadow-small);
        }
        
        .btn-primary:hover, .btn-primary:focus {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: var(--background-light);
            color: var(--text-primary);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary:hover, .btn-secondary:focus {
            background-color: #e9e9e9;
            transform: translateY(-2px);
            box-shadow: var(--shadow-small);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
            box-shadow: var(--shadow-small);
        }
        
        .btn-danger:hover, .btn-danger:focus {
            background-color: #d32f2f;
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
            box-shadow: var(--shadow-small);
        }
        
        .btn-success:hover, .btn-success:focus {
            background-color: #43a047;
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }
        
        .btn i {
            margin-right: var(--spacing-sm);
            font-size: 22px;
        }
        
        /* Welcome Screen Button */
        .welcome-btn {
            max-width: 250px;
            margin-top: var(--spacing-md);
        }
        
        /* Center the start chat button */
        #btnStartChat {
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Form Submit Button */
        .form-submit-btn {
            margin-top: 24px;
            display: flex;
            justify-content: center;
        }
        
        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            .message,
            .btn:hover,
            .department-item:hover,
            .loading-spinner,
            .typing-dot {
                animation: none !important;
                transition: none !important;
                transform: none !important;
            }
        }
        
        /* High contrast mode */
        @media (forced-colors: active) {
            .btn,
            .chat-action,
            .form-control,
            .message-content {
                border: 1px solid currentColor;
            }
        }
        
        /* PWA Installation Banner */
        .pwa-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-image: var(--primary-gradient);
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 999;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .pwa-banner.show {
            transform: translateY(0);
        }
        
        .pwa-message {
            flex: 1;
            margin-right: var(--spacing-sm);
        }
        
        .pwa-title {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 14px;
        }
        
        .pwa-buttons {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .pwa-btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-small);
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 14px;
        }
        
        .pwa-btn-install {
            background-color: var(--accent-color);
            color: var(--text-primary);
        }
        
        .pwa-btn-install:hover {
            background-color: var(--accent-dark);
            transform: translateY(-2px);
        }
        
        .pwa-btn-dismiss {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .pwa-btn-dismiss:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        /* Desktop Specific Styles */
        @media (min-width: 768px) {
            body {
                background-color: transparent;
                padding: 20px;
                overflow: auto;
                position: static;
            }
            
            .app-container {
                width: 90%;
                max-width: 1200px;
                height: calc(100vh - 40px);
                margin: 0 auto;
                border-radius: var(--border-radius-large);
                box-shadow: var(--shadow-large);
                overflow: hidden;
                transition: all 0.3s ease;
            }
            
            .app-header {
                height: 80px;
                padding: var(--spacing-md) var(--spacing-lg);
            }
            
            .header-logo {
                width: 48px;
                height: 48px;
                margin-right: var(--spacing-md);
            }
            
            .header-logo img {
                width: 36px;
                height: 36px;
            }
            
            .header-title {
                font-size: var(--font-size-xl);
            }
            
            .header-status {
                font-size: calc(var(--font-size-base) - 1px);
            }
            
            .header-button-with-text {
                min-width: 42px;
                height: 42px;
            }
            
            .header-button-with-text span {
                display: inline-block;
                margin-left: 6px;
                font-size: 14px;
                font-weight: 500;
            }
            
            .chat-messages {
                padding: var(--spacing-lg) var(--spacing-xl);
            }
            
            .message {
                max-width: 65%;
                margin-bottom: var(--spacing-md);
            }
            
            .message-content {
                padding: var(--spacing-md) var(--spacing-lg);
                font-size: var(--font-size-large);
            }
            
            .message-meta {
                font-size: 12px;
                margin-top: 4px;
            }
            
            .message-status i {
                font-size: 14px;
            }
            
            .message-system {
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: 14px;
                margin-bottom: var(--spacing-md);
            }
            
            .chat-input {
                padding: var(--spacing-md) var(--spacing-xl);
            }
            
            .chat-input-field {
                min-height: 60px;
                font-size: var(--font-size-large);
                padding: var(--spacing-md) var(--spacing-lg);
            }
            
            .chat-action {
                width: 54px;
                height: 54px;
            }
            
            .chat-action i {
                font-size: 24px;
            }
            
            .emergency-buttons {
                flex-direction: row;
                justify-content: center;
                gap: var(--spacing-lg);
            }
            
            .btn {
                width: auto;
                padding: var(--spacing-md) var(--spacing-xl);
                font-size: var(--font-size-large);
                min-height: 56px;
                max-width: 400px;
            }
            
            .btn i {
                font-size: 24px;
            }
            
            .welcome-screen {
                padding: var(--spacing-xl) var(--spacing-xl) var(--spacing-xl);
            }
            
            .welcome-title {
                font-size: 36px;
                margin-bottom: var(--spacing-lg);
            }
            
            .welcome-description {
                font-size: 20px;
                margin-bottom: var(--spacing-xl);
                max-width: 700px;
            }
            
            .welcome-logo {
                width: 100px;
                height: 100px;
                margin-bottom: var(--spacing-xl);
            }
            
            .welcome-logo img {
                width: 76px;
                height: 76px;
            }
            
            .welcome-btn {
                max-width: 280px;
            }
            
            .department-list {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                gap: var(--spacing-lg);
            }
            
            .department-item {
                height: 100%;
                padding: var(--spacing-lg);
            }
            
            .department-icon {
                width: 64px;
                height: 64px;
                margin-right: var(--spacing-md);
            }
            
            .department-icon i {
                font-size: 32px;
            }
            
            .department-name {
                font-size: var(--font-size-large);
            }
            
            .department-description {
                font-size: inherit;
            }
            
            .department-title {
                font-size: var(--font-size-xl);
                margin-bottom: var(--spacing-xl);
            }
            
            .department-select {
                padding: var(--spacing-lg) var(--spacing-xl);
            }
            
            .form-title {
                font-size: var(--font-size-xl);
                margin-bottom: var(--spacing-lg);
            }
            
            .form-control {
                padding: var(--spacing-md);
                font-size: var(--font-size-large);
            }
            
            .form-check-label {
                font-size: var(--font-size-base);
            }
            
            .gdpr-info {
                font-size: 14px;
                padding: var(--spacing-md);
            }
            
            .chat-form {
                padding: var(--spacing-xl);
            }
            
            .form-group {
                margin-bottom: var(--spacing-lg);
            }
            
            .emergency-title {
                font-size: var(--font-size-xxl);
                margin-bottom: var(--spacing-lg);
            }
            
            .emergency-text {
                font-size: var(--font-size-large);
                margin-bottom: var(--spacing-xl);
            }
            
            .emergency-check {
                padding: var(--spacing-xl) var(--spacing-xl) var(--spacing-xl);
            }
            
            .chat-end {
                padding: var(--spacing-xl);
            }
            
            .chat-end-icon {
                font-size: 56px;
                margin-bottom: var(--spacing-md);
            }
            
            .chat-end-title {
                font-size: var(--font-size-xxl);
                margin-bottom: var(--spacing-md);
            }
            
            .chat-end-text {
                font-size: var(--font-size-large);
                margin-bottom: var(--spacing-xl);
            }
            
            .loading-spinner {
                width: 60px;
                height: 60px;
                border-width: 4px;
            }
            
            .loading-container {
                gap: var(--spacing-lg);
            }
            
            .notice {
                padding: var(--spacing-md);
                margin-bottom: var(--spacing-md);
                font-size: var(--font-size-base);
            }
            
            .typing-indicator {
                margin: 10px 0;
                padding: 12px 16px;
            }
            
            .typing-dot {
                height: 10px;
                width: 10px;
            }
            
            .pwa-banner {
                padding: var(--spacing-md) var(--spacing-lg);
            }
            
            .pwa-message {
                margin-right: var(--spacing-md);
            }
            
            .pwa-title {
                margin-bottom: 4px;
                font-size: inherit;
            }
            
            .pwa-btn {
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: inherit;
            }
            
            .department-item:hover .department-name {
                color: var(--secondary-color);
            }
            
            .header-logo:hover {
                transform: scale(1.05);
            }
            
            .chat-action:hover {
                transform: translateY(-3px);
            }
            
            .btn-primary:hover, .btn-success:hover, .btn-danger:hover, .btn-secondary:hover {
                transform: translateY(-3px);
            }
        }
        
        /* Large Desktop */
        @media (min-width: 1400px) {
            .app-container {
                max-width: 1400px;
            }
            
            .chat-messages {
                padding: var(--spacing-xl) var(--spacing-xl);
            }
            
            .message {
                max-width: 60%;
            }
            
            .welcome-title {
                font-size: 42px;
            }
            
            .welcome-description {
                font-size: 22px;
                max-width: 800px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- App Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="header-logo">
                    <img src="https://images4.imagebam.com/d3/36/5c/ME11M3EE_o.png" alt="Logo Poliția Locală">
                </div>
                <div>
                    <div class="header-title">Poliția Locală Slobozia</div>
                    <div class="header-status">
                        <span id="connectionStatus">Online</span> • 
                        <span id="securityStatus">Chat Securizat</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <a href="/" aria-label="Pagina principală">
                    <button id="btnHome" aria-label="Pagina principală" class="header-button-with-text">
                        <i class="material-icons">home</i>
                        <span>Acasă</span>
                    </button>
                </a>
                <button id="btnCloseChat" aria-label="Închide chat" class="header-button-with-text">
                    <i class="material-icons">close</i>
                    <span>Închide</span>
                </button>
            </div>
        </header>
        
        <!-- Main App Content -->
        <main class="app-content">
            <!-- Error Notice -->
            <div id="errorNotice" class="notice error-notice" role="alert"></div>
            
            <!-- Success Notice -->
            <div id="successNotice" class="notice success-notice" role="status"></div>
            
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="welcome-screen">
                <div class="welcome-logo">
                    <img src="https://images4.imagebam.com/16/bf/9a/ME11NRG3_o.png" alt="Logo Poliția Locală">
                </div>
                <h1 class="welcome-title">Chat Online cu Poliția Locală</h1>
                <p class="welcome-description">Raportați probleme non-urgente și primiți asistență în timp real de la agenții Poliției Locale Slobozia.</p>
                <button id="btnStartWelcome" class="btn btn-primary welcome-btn">
                    <i class="material-icons">message</i> Începe Chat
                </button>
            </div>
            
            <!-- Phone Verification Screen -->
            <div id="phoneVerification" class="phone-verification" style="display:none;">
                <h2 class="verification-title">Verificare Număr de Telefon</h2>
                <p class="verification-description">Introduceți numărul dvs. de telefon pentru a continua. Veți primi un cod SMS pentru verificare.</p>
                
                <div class="phone-input-group">
                    <span class="phone-prefix">+40</span>
                    <input type="tel" id="phoneNumber" class="form-control" placeholder="7XX XXX XXX" maxlength="9" pattern="[0-9]*" inputmode="numeric">
                </div>
                
                <button id="btnSendCode" class="btn btn-primary">
                    <i class="material-icons">sms</i> Trimite Cod SMS
                </button>
                
                <div id="verificationSection" class="verification-code-section" style="display:none;">
                    <p class="verification-description">Introduceți codul de 6 cifre primit prin SMS:</p>
                    <div class="code-input-group">
                        <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                        <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                        <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                        <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                        <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                        <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                    </div>
                    <button id="btnVerifyCode" class="btn btn-primary">
                        <i class="material-icons">check</i> Verifică Cod
                    </button>
                    <div class="retry-message" id="retryMessage" style="display:none;">
                        Puteți solicita un nou cod în <span class="retry-timer" id="retryTimer">60</span> secunde.
                    </div>
                </div>
                
                <div id="recaptcha-container"></div>
            </div>
            
            <!-- Emergency Check -->
            <div id="emergencyCheck" class="emergency-check" style="display:none;">
                <h2 class="emergency-title">
                    <i class="material-icons">warning</i>Verificare Urgență
                </h2>
                <p class="emergency-text">Vă aflați într-o situație de urgență care necesită asistență imediată?</p>
                <div class="emergency-buttons">
                    <button id="btnEmergency" class="btn btn-danger">
                        <i class="material-icons">call</i> Da, am nevoie de ajutor acum
                    </button>
                    <button id="btnNonemergency" class="btn btn-success">
                        <i class="material-icons">check_circle</i> Nu, este o situație non-urgentă
                    </button>
                </div>
            </div>
            
            <!-- Department Selection -->
            <div id="departmentSelect" class="department-select">
                <h2 class="department-title">Selectați departamentul care vă poate ajuta</h2>
                
                <div class="department-list">
                    <div class="department-item" data-id="traffic">
                        <div class="department-icon">
                            <i class="material-icons">directions_car</i>
                        </div>
                        <div class="department-info">
                            <div class="department-name">Circulație Rutieră</div>
                            <div class="department-description">Probleme legate de trafic, parcare sau semaforizare</div>
                        </div>
                    </div>
                    
                    <div class="department-item" data-id="public-order">
                        <div class="department-icon">
                            <i class="material-icons">public</i>
                        </div>
                        <div class="department-info">
                            <div class="department-name">Ordine Publică</div>
                            <div class="department-description">Tulburarea liniștii publice, comportament necorespunzător</div>
                        </div>
                    </div>
                    
                    <div class="department-item" data-id="environment">
                        <div class="department-icon">
                            <i class="material-icons">nature</i>
                        </div>
                        <div class="department-info">
                            <div class="department-name">Protecția Mediului</div>
                            <div class="department-description">Depozitarea deșeurilor, poluare, animale abandonate</div>
                        </div>
                    </div>
                    
                    <div class="department-item" data-id="commerce">
                        <div class="department-icon">
                            <i class="material-icons">store</i>
                        </div>
                        <div class="department-info">
                            <div class="department-name">Control Comercial</div>
                            <div class="department-description">Comerț ilegal, nereguli în activități comerciale</div>
                        </div>
                    </div>
                    
                    <div class="department-item" data-id="general">
                        <div class="department-icon">
                            <i class="material-icons">help_outline</i>
                        </div>
                        <div class="department-info">
                            <div class="department-name">Informații Generale</div>
                            <div class="department-description">Întrebări generale, informații despre serviciile poliției</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pre-Chat Form -->
            <div id="chatForm" class="chat-form">
                <div class="notice error-notice" id="formErrorNotice" style="display:none;">
                    Vă rugăm să completați toate câmpurile obligatorii.
                </div>
                
                <h2 class="form-title">Înainte de a începe</h2>
                
                <div class="form-group">
                    <label class="form-label" for="chat-subject">Subiect:</label>
                    <input type="text" id="chat-subject" class="form-control" placeholder="Descrieți pe scurt problema" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="chat-name">Numele dumneavoastră:</label>
                    <input type="text" id="chat-name" class="form-control" placeholder="Nume și prenume" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="chat-email">Email (pentru transcriere):</label>
                    <input type="email" id="chat-email" class="form-control" placeholder="adresa@email.ro">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="chat-phone">Telefon:</label>
                    <input type="tel" id="chat-phone" class="form-control" placeholder="Număr de telefon" readonly>
                </div>
                
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="privacy-check" required>
                        <label class="form-check-label" for="privacy-check">Am citit și accept <a href="/privacy-policy" target="_blank">politica de confidențialitate</a>.</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="recording-check" required>
                        <label class="form-check-label" for="recording-check">Înțeleg că această conversație poate fi înregistrată pentru îmbunătățirea serviciilor.</label>
                    </div>
                </div>
                
                <div class="gdpr-info">
                    <p>Datele dumneavoastră sunt protejate în conformitate cu Regulamentul General privind Protecția Datelor (GDPR).</p>
                </div>
                
                <div class="form-submit-btn">
                    <button id="btnStartChat" class="btn btn-primary">
                        <i class="material-icons">chat</i> Începe Chat
                    </button>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="loadingState" class="loading-container">
                <div class="loading-spinner"></div>
                <p id="loadingText">Se conectează la chat...</p>
            </div>
            
            <!-- Chat Area -->
            <div id="chatArea" class="chat-area">
                <!-- Chat Messages -->
                <div id="chatMessages" class="chat-messages"></div>
                
                <!-- Chat Input -->
                <div id="chatInput" class="chat-input">
                    <input type="text" class="chat-input-field" id="messageInput" placeholder="Scrieți mesajul aici..." aria-label="Scrieți mesajul">
                    <div class="chat-actions">
                        <button id="btnSendMessage" class="chat-action chat-action-send" aria-label="Trimite mesaj">
                            <i class="material-icons">send</i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Chat End -->
            <div id="chatEnd" class="chat-end">
                <i class="material-icons chat-end-icon">check_circle</i>
                <h2 class="chat-end-title">Conversație încheiată</h2>
                <p class="chat-end-text">Vă mulțumim pentru că ați contactat Poliția Locală Slobozia. Puteți primi transcriptul conversației pe email sau puteți începe o nouă conversație.</p>
                <button id="btnRequestTranscript" class="btn btn-secondary">
                    <i class="material-icons">description</i> Primește transcript
                </button>
                <button id="btnStartNewChat" class="btn btn-primary" style="margin-top: var(--spacing-md);">
                    <i class="material-icons">chat</i> Conversație nouă
                </button>
            </div>
        </main>
        
        <!-- PWA Installation Banner -->
        <div id="pwaBanner" class="pwa-banner">
            <div class="pwa-message">
                <div class="pwa-title">Instalează aplicația</div>
                <div class="pwa-description">Adaugă pe ecranul principal pentru acces rapid</div>
            </div>
            <div class="pwa-buttons">
                <button id="btnDismissPwa" class="pwa-btn pwa-btn-dismiss">Nu acum</button>
                <button id="btnInstallPwa" class="pwa-btn pwa-btn-install">Instalează</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase configuration -->
    <script src="../chat/js/firebase-config.js"></script>
    
    <script>
        // =============================================
        // Firebase Services
        // =============================================
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();
        
        // =============================================
        // DOM Elements
        // =============================================
        // Screens
        const welcomeScreen = document.getElementById('welcomeScreen');
        const phoneVerification = document.getElementById('phoneVerification');
        const emergencyCheck = document.getElementById('emergencyCheck');
        const departmentSelect = document.getElementById('departmentSelect');
        const chatForm = document.getElementById('chatForm');
        const loadingState = document.getElementById('loadingState');
        const chatArea = document.getElementById('chatArea');
        const chatEnd = document.getElementById('chatEnd');
        
        // Phone verification elements
        const phoneNumberInput = document.getElementById('phoneNumber');
        const btnSendCode = document.getElementById('btnSendCode');
        const verificationSection = document.getElementById('verificationSection');
        const btnVerifyCode = document.getElementById('btnVerifyCode');
        const retryMessage = document.getElementById('retryMessage');
        const retryTimer = document.getElementById('retryTimer');
        const codeInputs = document.querySelectorAll('.code-input');
        
        // Notices
        const errorNotice = document.getElementById('errorNotice');
        const successNotice = document.getElementById('successNotice');
        const formErrorNotice = document.getElementById('formErrorNotice');
        
        // Chat Elements
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const messageInput = document.getElementById('messageInput');
        
        // Buttons
        const btnStartWelcome = document.getElementById('btnStartWelcome');
        const btnEmergency = document.getElementById('btnEmergency');
        const btnNonemergency = document.getElementById('btnNonemergency');
        const btnStartChat = document.getElementById('btnStartChat');
        const btnSendMessage = document.getElementById('btnSendMessage');
        const btnCloseChat = document.getElementById('btnCloseChat');
        const btnRequestTranscript = document.getElementById('btnRequestTranscript');
        const btnStartNewChat = document.getElementById('btnStartNewChat');
        
        // Department selection
        const departmentItems = document.querySelectorAll('.department-item');
        
        // Other elements
        const connectionStatus = document.getElementById('connectionStatus');
        const securityStatus = document.getElementById('securityStatus');
        const loadingText = document.getElementById('loadingText');
        
        // PWA Banner
        const pwaBanner = document.getElementById('pwaBanner');
        const btnDismissPwa = document.getElementById('btnDismissPwa');
        const btnInstallPwa = document.getElementById('btnInstallPwa');
        
        // =============================================
        // State Variables
        // =============================================
        let currentUser = null;
        let currentChatId = null;
        let selectedDepartment = null;
        let chatSessionKey = null;
        let agentPublicKey = null;
        let chatEnded = false;
        let isTyping = false;
        let typingTimeout = null;
        let lastReadTimestamp = null;
        let unreadCount = 0;
        let offlineTimeout = null;
        let messageQueue = [];
        let agentJoinedFlag = false;
        let deferredPrompt = null;
        let deviceFingerprint = null;
        let verificationId = null;
        let retryCountdown = null;
        let retryTimeLeft = 60;
        
        // Rate limiting
        const rateLimitConfig = {
            maxMessages: 20,
            timeWindow: 60000,
            sentMessages: [],
            isLimited: false
        };
        
        // Phone verification rate limiting
        const phoneRateLimitConfig = {
            maxAttempts: 3,
            timeWindow: 3600000, // 1 hour
            cooldownPeriods: [60, 300, 900, 3600, 86400], // 1min, 5min, 15min, 1hr, 24hr
            attempts: []
        };
        
        // =============================================
        // Device Fingerprinting
        // =============================================
        
        // Generate device fingerprint
        function generateDeviceFingerprint() {
            return new Promise((resolve) => {
                try {
                    // Collect browser information
                    const components = [
                        navigator.userAgent,
                        navigator.language,
                        navigator.platform,
                        navigator.vendor,
                        screen.colorDepth,
                        screen.width + 'x' + screen.height,
                        new Date().getTimezoneOffset(),
                        !!window.sessionStorage,
                        !!window.localStorage,
                        !!window.indexedDB
                    ];

                    // Check for available plugins
                    if (navigator.plugins) {
                        const pluginsStr = Array.from(navigator.plugins)
                            .map(p => p.name + p.filename + p.description)
                            .join('');
                        components.push(pluginsStr);
                    }

                    // Create canvas fingerprint
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 200;
                        canvas.height = 50;

                        // Add text with different styles
                        ctx.textBaseline = 'top';
                        ctx.font = '16px Arial';
                        ctx.fillStyle = '#F72585';
                        ctx.fillText('Fingerprint', 0, 10);
                        ctx.fillStyle = '#4361EE';
                        ctx.font = 'bold 14px Times New Roman';
                        ctx.fillText('Canvas', 100, 25);

                        // Add shapes
                        ctx.beginPath();
                        ctx.moveTo(10, 40);
                        ctx.bezierCurveTo(30, 30, 60, 50, 90, 35);
                        ctx.strokeStyle = '#7209B7';
                        ctx.stroke();

                        // Get canvas data
                        const canvasData = canvas.toDataURL();
                        components.push(canvasData);
                    } catch (e) {
                        components.push('canvas-not-supported');
                    }

                    // Check for localStorage fingerprint
                    const storedFingerprint = localStorage.getItem('deviceIdentifier');
                    if (storedFingerprint) {
                        components.push(storedFingerprint);
                    }

                    // Combine and hash components
                    const componentsStr = components.join('###');
                    const fingerprint = CryptoJS.SHA256(componentsStr).toString();

                    // Cache in localStorage for persistence
                    localStorage.setItem('deviceIdentifier', fingerprint);

                    resolve(fingerprint);
                } catch (error) {
                    console.error('Error generating device fingerprint:', error);
                    // Fallback to a simpler fingerprint
                    const fallbackFingerprint = CryptoJS.SHA256(
                        navigator.userAgent + screen.width + screen.height + navigator.language
                    ).toString();
                    localStorage.setItem('deviceIdentifier', fallbackFingerprint);
                    resolve(fallbackFingerprint);
                }
            });
        }

        // Register or update device fingerprint in Firestore
        function registerDeviceFingerprint(fingerprint) {
            return new Promise((resolve, reject) => {
                if (!fingerprint) {
                    reject(new Error('No device fingerprint provided'));
                    return;
                }

                // Create a fingerprint hash for the document ID
                const fingerprintHash = CryptoJS.SHA256(fingerprint).toString();

                // Check if this fingerprint already exists
                db.collection('deviceFingerprints')
                    .doc(fingerprintHash)
                    .get()
                    .then((doc) => {
                        const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                        const deviceData = {
                            fingerprintHash: fingerprintHash,
                            lastSeen: timestamp,
                            userAgent: navigator.userAgent
                        };

                        if (doc.exists) {
                            // Update existing fingerprint
                            return db.collection('deviceFingerprints')
                                .doc(fingerprintHash)
                                .update({
                                    lastSeen: timestamp,
                                    userAgent: navigator.userAgent,
                                    ...(currentUser ? { userId: currentUser.uid } : {})
                                });
                        } else {
                            // Create new fingerprint record
                            return db.collection('deviceFingerprints')
                                .doc(fingerprintHash)
                                .set({
                                    ...deviceData,
                                    createdAt: timestamp,
                                    ...(currentUser ? { userId: currentUser.uid } : {})
                                });
                        }
                    })
                    .then(() => {
                        console.log('Device fingerprint registered successfully');
                        resolve(fingerprintHash);
                    })
                    .catch((error) => {
                        console.error('Error registering device fingerprint:', error);
                        reject(error);
                    });
            });
        }
        
        // =============================================
        // Security and Encryption Functions
        // =============================================
        
        // Generate a new encryption key for the chat session
        function generateEncryptionKey() {
            const randomBytes = CryptoJS.lib.WordArray.random(32);
            return randomBytes.toString();
        }
        
        // Encrypt a message
        function encryptMessage(message, key) {
            try {
                if (!key) return message;
                return CryptoJS.AES.encrypt(message, key).toString();
            } catch (error) {
                console.error('Encryption error:', error);
                return message;
            }
        }
        
        // Decrypt a message
        function decryptMessage(encryptedMessage, key) {
            try {
                if (!key) return encryptedMessage;
                const bytes = CryptoJS.AES.decrypt(encryptedMessage, key);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch (error) {
                console.error('Decryption error:', error);
                return encryptedMessage;
            }
        }
        
        // =============================================
        // Phone Authentication Rate Limiting
        // =============================================
        
        // Check phone verification rate limits
        async function checkPhoneRateLimits(deviceFingerprint, phoneNumber) {
            const phoneHash = CryptoJS.SHA256(phoneNumber).toString();
            const today = new Date().toISOString().split('T')[0];
            
            try {
                // Check daily global limit
                const dailyStatsRef = db.collection('dailyVerificationStats').doc(today);
                const dailyStats = await dailyStatsRef.get();
                
                if (dailyStats.exists && dailyStats.data().totalAttempts >= 50) {
                    throw new Error('Limita zilnică de verificări a fost atinsă. Vă rugăm să încercați mâine.');
                }
                
                // Check device limits
                const deviceRef = db.collection('phoneVerificationAttempts').doc(deviceFingerprint);
                const deviceData = await deviceRef.get();
                
                if (deviceData.exists) {
                    const data = deviceData.data();
                    
                    // Check if device is blocked
                    if (data.isBlocked && data.blockUntil > firebase.firestore.Timestamp.now()) {
                        const waitTime = calculateWaitTime(data.blockUntil);
                        throw new Error(`Dispozitivul este blocat. Încercați din nou în ${waitTime}.`);
                    }
                    
                    // Check attempt count within time window
                    const recentAttempts = await db.collection('phoneVerificationAttempts')
                        .doc(deviceFingerprint)
                        .collection('attempts')
                        .where('timestamp', '>', firebase.firestore.Timestamp.fromMillis(Date.now() - phoneRateLimitConfig.timeWindow))
                        .get();
                    
                    if (recentAttempts.size >= phoneRateLimitConfig.maxAttempts) {
                        const cooldownIndex = Math.min(recentAttempts.size - phoneRateLimitConfig.maxAttempts, phoneRateLimitConfig.cooldownPeriods.length - 1);
                        const cooldownPeriod = phoneRateLimitConfig.cooldownPeriods[cooldownIndex];
                        
                        // Block the device
                        await deviceRef.update({
                            isBlocked: true,
                            blockUntil: firebase.firestore.Timestamp.fromMillis(Date.now() + cooldownPeriod * 1000),
                            attempts: firebase.firestore.FieldValue.increment(1)
                        });
                        
                        throw new Error(`Prea multe încercări. Vă rugăm să așteptați ${formatDuration(cooldownPeriod)}.`);
                    }
                }
                
                // Check if phone number already used
                const phoneRef = db.collection('phoneNumbersUsed').doc(phoneHash);
                const phoneData = await phoneRef.get();
                
                if (phoneData.exists) {
                    throw new Error('Acest număr de telefon este deja înregistrat.');
                }
                
                // Log this attempt
                await logVerificationAttempt(deviceFingerprint, phoneHash);
                
                return true;
            } catch (error) {
                console.error('Rate limit check error:', error);
                throw error;
            }
        }
        
        // Log verification attempt
        async function logVerificationAttempt(deviceFingerprint, phoneHash) {
            const timestamp = firebase.firestore.FieldValue.serverTimestamp();
            const today = new Date().toISOString().split('T')[0];
            
            try {
                // Log to device attempts
                await db.collection('phoneVerificationAttempts')
                    .doc(deviceFingerprint)
                    .collection('attempts')
                    .add({
                        phoneHash: phoneHash,
                        timestamp: timestamp
                    });
                
                // Update device data
                await db.collection('phoneVerificationAttempts')
                    .doc(deviceFingerprint)
                    .set({
                        deviceFingerprint: deviceFingerprint,
                        lastAttempt: timestamp,
                        attempts: firebase.firestore.FieldValue.increment(1)
                    }, { merge: true });
                
                // Update daily stats
                await db.collection('dailyVerificationStats')
                    .doc(today)
                    .set({
                        date: today,
                        totalAttempts: firebase.firestore.FieldValue.increment(1),
                        lastUpdated: timestamp
                    }, { merge: true });
            } catch (error) {
                console.error('Error logging verification attempt:', error);
            }
        }
        
        // =============================================
        // Phone Verification Functions
        // =============================================
        
        // Validate Romanian phone number
        function validateRomanianPhoneNumber(phoneNumber) {
            // Romanian mobile numbers: 7XX XXX XXX
            const romanianMobileRegex = /^7\d{8}$/;
            return romanianMobileRegex.test(phoneNumber);
        }
        
        // Format phone number for display
        function formatPhoneNumber(phoneNumber) {
            if (!phoneNumber) return '';
            return phoneNumber.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3');
        }
        
        // Format duration for display
        function formatDuration(seconds) {
            if (seconds < 60) return `${seconds} secunde`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)} minute`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} ore`;
            return `${Math.floor(seconds / 86400)} zile`;
        }
        
        // Calculate wait time
        function calculateWaitTime(blockUntilTimestamp) {
            const now = firebase.firestore.Timestamp.now();
            const blockUntil = blockUntilTimestamp.toMillis();
            const difference = blockUntil - now.toMillis();
            
            if (difference <= 0) return 'acum';
            
            return formatDuration(Math.ceil(difference / 1000));
        }
        
        // Handle phone number input
        function handlePhoneInput(event) {
            // Allow only digits
            const value = event.target.value.replace(/\D/g, '');
            event.target.value = value;
        }
        
        // Handle code input
        function handleCodeInput(event, index) {
            const input = event.target;
            const value = input.value.replace(/\D/g, '').substr(0, 1);
            input.value = value;
            
            if (value) {
                // Move to next input
                if (index < codeInputs.length - 1) {
                    codeInputs[index + 1].focus();
                }
            }
            
            // Check if all code inputs are filled
            if (index === codeInputs.length - 1) {
                const code = Array.from(codeInputs).map(input => input.value).join('');
                if (code.length === 6) {
                    // Enable verify button
                    btnVerifyCode.disabled = false;
                }
            }
        }
        
        // Handle code paste
        function handleCodePaste(event) {
            event.preventDefault();
            const pastedData = (event.clipboardData || window.clipboardData).getData('text');
            const cleanData = pastedData.replace(/\D/g, '').substr(0, 6);
            
            // Fill inputs with pasted data
            for (let i = 0; i < cleanData.length && i < codeInputs.length; i++) {
                codeInputs[i].value = cleanData[i];
            }
            
            // Focus last filled input or first empty one
            const lastFilledIndex = cleanData.length - 1;
            if (lastFilledIndex >= 0 && lastFilledIndex < codeInputs.length) {
                codeInputs[Math.min(lastFilledIndex, codeInputs.length - 1)].focus();
            }
            
            // Check if all inputs are filled
            if (cleanData.length === 6) {
                btnVerifyCode.disabled = false;
            }
        }
        
        // Setup code inputs
        function setupCodeInputs() {
            codeInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => handleCodeInput(e, index));
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !input.value && index > 0) {
                        codeInputs[index - 1].focus();
                    }
                });
                input.addEventListener('paste', handleCodePaste);
            });
        }
        
        // Start retry countdown
        function startRetryCountdown() {
            retryTimeLeft = 60;
            retryMessage.style.display = 'block';
            retryTimer.textContent = retryTimeLeft;
            
            if (retryCountdown) {
                clearInterval(retryCountdown);
            }
            
            retryCountdown = setInterval(() => {
                retryTimeLeft--;
                retryTimer.textContent = retryTimeLeft;
                
                if (retryTimeLeft <= 0) {
                    clearInterval(retryCountdown);
                    retryMessage.style.display = 'none';
                    btnSendCode.disabled = false;
                    btnSendCode.textContent = 'Retrimite Cod SMS';
                }
            }, 1000);
        }
        
        // Send verification code
        async function sendVerificationCode() {
            const phoneNumber = phoneNumberInput.value.trim();
            
            // Validate phone number
            if (!validateRomanianPhoneNumber(phoneNumber)) {
                showNotice(errorNotice, 'Vă rugăm să introduceți un număr de telefon valid (format: 7XX XXX XXX)');
                return;
            }
            
            const fullPhoneNumber = '+40' + phoneNumber;
            
            try {
                // Disable button and show loading
                btnSendCode.disabled = true;
                btnSendCode.innerHTML = '<i class="material-icons">hourglass_empty</i> Se trimite...';
                
                // Check rate limits
                await checkPhoneRateLimits(deviceFingerprint, fullPhoneNumber);
                
                // Set up reCAPTCHA
                if (!window.recaptchaVerifier) {
                    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                        size: 'invisible',
                        callback: (response) => {
                            console.log('reCAPTCHA solved');
                        },
                        'expired-callback': () => {
                            console.log('reCAPTCHA expired');
                        }
                    });
                }
                
                // Send verification code
                const confirmationResult = await auth.signInWithPhoneNumber(fullPhoneNumber, window.recaptchaVerifier);
                window.confirmationResult = confirmationResult;
                
                // Show verification code input
                verificationSection.style.display = 'block';
                codeInputs[0].focus();
                
                // Start retry countdown
                startRetryCountdown();
                
                // Update button state
                btnSendCode.innerHTML = '<i class="material-icons">refresh</i> Retrimite Cod SMS';
                btnSendCode.disabled = true;
                
                showNotice(successNotice, 'Cod trimis! Verificați SMS-ul.');
                
            } catch (error) {
                console.error('Error sending verification code:', error);
                handleAuthError(error);
                
                // Reset button
                btnSendCode.disabled = false;
                btnSendCode.innerHTML = '<i class="material-icons">sms</i> Trimite Cod SMS';
                
                // Reset reCAPTCHA
                if (window.recaptchaVerifier) {
                    window.recaptchaVerifier.clear();
                    window.recaptchaVerifier = null;
                }
            }
        }
        
        // Verify code
        async function verifyCode() {
            const code = Array.from(codeInputs).map(input => input.value).join('');
            
            if (code.length !== 6) {
                showNotice(errorNotice, 'Vă rugăm să introduceți codul complet de 6 cifre');
                return;
            }
            
            try {
                // Disable button and show loading
                btnVerifyCode.disabled = true;
                btnVerifyCode.innerHTML = '<i class="material-icons">hourglass_empty</i> Se verifică...';
                
                // Verify the code
                const result = await window.confirmationResult.confirm(code);
                currentUser = result.user;
                
                // Check if phone number already used
                const phoneHash = CryptoJS.SHA256(currentUser.phoneNumber).toString();
                const phoneRef = db.collection('phoneNumbersUsed').doc(phoneHash);
                const phoneData = await phoneRef.get();
                
                if (phoneData.exists && phoneData.data().userId !== currentUser.uid) {
                    // Phone number already used by another account
                    await auth.signOut();
                    throw new Error('Acest număr de telefon este deja înregistrat.');
                }
                
                // Register phone number
                if (!phoneData.exists) {
                    await phoneRef.set({
                        phoneHash: phoneHash,
                        userId: currentUser.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        deviceFingerprint: deviceFingerprint
                    });
                }
                
                // Update verification success stats
                const today = new Date().toISOString().split('T')[0];
                await db.collection('dailyVerificationStats').doc(today).update({
                    successfulVerifications: firebase.firestore.FieldValue.increment(1)
                });
                
                // Register device fingerprint with user ID
                await registerDeviceFingerprint(deviceFingerprint);
                
                // Clear retry countdown
                if (retryCountdown) {
                    clearInterval(retryCountdown);
                }
                
                // Continue to emergency check
                phoneVerification.style.display = 'none';
                emergencyCheck.style.display = 'flex';
                
                showNotice(successNotice, 'Verificare reușită!');
                
            } catch (error) {
                console.error('Error verifying code:', error);
                handleAuthError(error);
                
                // Reset button
                btnVerifyCode.disabled = false;
                btnVerifyCode.innerHTML = '<i class="material-icons">check</i> Verifică Cod';
            }
        }
        
        // Handle authentication errors
        function handleAuthError(error) {
            let message = 'A apărut o eroare. Vă rugăm să încercați din nou.';
            
            switch (error.code) {
                case 'auth/invalid-phone-number':
                    message = 'Număr de telefon invalid. Vă rugăm să verificați formatul.';
                    break;
                case 'auth/too-many-requests':
                    message = 'Prea multe încercări. Vă rugăm să așteptați și să încercați din nou.';
                    break;
                case 'auth/quota-exceeded':
                    message = 'Serviciul este temporar indisponibil. Vă rugăm să încercați mai târziu.';
                    break;
                case 'auth/invalid-verification-code':
                    message = 'Cod de verificare invalid. Vă rugăm să verificați și să încercați din nou.';
                    break;
                case 'auth/code-expired':
                    message = 'Codul de verificare a expirat. Vă rugăm să solicitați un nou cod.';
                    break;
                case 'auth/missing-verification-code':
                    message = 'Vă rugăm să introduceți codul de verificare.';
                    break;
                default:
                    if (error.message) {
                        message = error.message;
                    }
            }
            
            showNotice(errorNotice, message);
        }
        
        // =============================================
        // Chat Status and Connection Management
        // =============================================
        
        // Update connection status
        function updateConnectionStatus(status) {
            connectionStatus.textContent = status;
            
            if (status === 'Offline') {
                connectionStatus.style.color = 'var(--danger-color)';
                
                if (!chatEnded && chatArea.style.display !== 'none') {
                    showNotice(errorNotice, 'Conexiune pierdută. Mesajele vor fi trimise când conexiunea va fi restabilită.');
                }
            } else if (status === 'Connecting...') {
                connectionStatus.style.color = 'var(--warning-color)';
            } else {
                connectionStatus.style.color = '';
                errorNotice.style.display = 'none';
                
                if (messageQueue.length > 0) {
                    processMessageQueue();
                }
            }
        }
        
        // Monitor connection status
        function setupConnectionMonitoring() {
            try {
                const connectedRef = firebase.database().ref('.info/connected');
                connectedRef.on('value', (snap) => {
                    if (snap && snap.val() === true) {
                        updateConnectionStatus('Online');
                        
                        if (offlineTimeout) {
                            clearTimeout(offlineTimeout);
                            offlineTimeout = null;
                        }
                    } else {
                        if (!offlineTimeout) {
                            offlineTimeout = setTimeout(() => {
                                updateConnectionStatus('Offline');
                            }, 5000);
                        }
                    }
                }, (error) => {
                    console.error('Error monitoring connection status:', error);
                    updateConnectionStatus(navigator.onLine ? 'Online' : 'Offline');
                });
            } catch (error) {
                console.error('Error setting up connection monitoring:', error);
                updateConnectionStatus(navigator.onLine ? 'Online' : 'Offline');
            }
            
            window.addEventListener('online', () => {
                updateConnectionStatus('Online');
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus('Offline');
            });
        }
        
        // Show a notice
        function showNotice(element, message, duration = 5000) {
            element.textContent = message;
            element.style.display = 'block';
            
            if (duration > 0) {
                setTimeout(() => {
                    element.style.display = 'none';
                }, duration);
            }
        }
        
        // =============================================
        // Rate Limiting
        // =============================================
        
        // Check rate limit before sending a message
        function checkRateLimit() {
            const now = Date.now();
            
            rateLimitConfig.sentMessages = rateLimitConfig.sentMessages.filter(
                timestamp => now - timestamp < rateLimitConfig.timeWindow
            );
            
            if (rateLimitConfig.sentMessages.length >= rateLimitConfig.maxMessages) {
                if (!rateLimitConfig.isLimited) {
                    rateLimitConfig.isLimited = true;
                    showNotice(
                        errorNotice, 
                        `Ați trimis prea multe mesaje într-un interval scurt de timp. Vă rugăm să așteptați ${Math.ceil(rateLimitConfig.timeWindow/1000)} secunde.`,
                        rateLimitConfig.timeWindow
                    );
                    
                    setTimeout(() => {
                        rateLimitConfig.isLimited = false;
                        errorNotice.style.display = 'none';
                    }, rateLimitConfig.timeWindow);
                }
                return false;
            }
            
            return true;
        }
        
        // Record a sent message for rate limiting
        function recordMessageSent() {
            rateLimitConfig.sentMessages.push(Date.now());
        }
        
        // =============================================
        // Message Queue Management (for offline support)
        // =============================================
        
        // Add a message to the queue
        function queueMessage(message) {
            messageQueue.push(message);
            localStorage.setItem('messageQueue_' + currentChatId, JSON.stringify(messageQueue));
        }
        
        // Process the message queue when back online
        function processMessageQueue() {
            if (messageQueue.length === 0) return;
            
            showNotice(successNotice, `Se trimit ${messageQueue.length} mesaje din coada offline...`);
            
            const processNext = () => {
                if (messageQueue.length === 0) {
                    showNotice(successNotice, 'Toate mesajele au fost trimise cu succes.');
                    return;
                }
                
                const message = messageQueue.shift();
                
                sendMessageToFirestore(message)
                .then(() => {
                    localStorage.setItem('messageQueue_' + currentChatId, JSON.stringify(messageQueue));
                    processNext();
                })

                .setItem('messageQueue_' + currentChatId, JSON.stringify(messageQueue));
                        processNext();
                    })
                    .catch(error => {
                        console.error('Error processing queued message:', error);
                        messageQueue.unshift(message);
                        localStorage.setItem('messageQueue_' + currentChatId, JSON.stringify(messageQueue));
                        showNotice(errorNotice, 'Nu s-au putut trimite toate mesajele. Se va încerca din nou mai târziu.');
                    });
            };
            
            processNext();
        }
        
        // Send a message to Firestore
        function sendMessageToFirestore(messageObj) {
            return new Promise((resolve, reject) => {
                // Add message to Firestore 
                db.collection('chats').doc(currentChatId).collection('messages').add(messageObj)
                    .then(messageRef => {
                        // Update the chat's last activity timestamp
                        return db.collection('chats').doc(currentChatId).update({
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastMessage: messageObj.encrypted ? "[Encrypted message]" : (messageObj.content || '[Mesaj gol]'),
                            lastMessageSender: 'user'
                        });
                    })
                    .then(() => {
                        resolve();
                    })
                    .catch(error => {
                        console.error('Error details:', error);
                        reject(error);
                    });
            });
        }
        
        // Handle Enter key press
        function handleEnterPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        // =============================================
        // Message Display Functions
        // =============================================
        
        // Display a message in the chat
        function displayMessage(message) {
            // Check if this message is already displayed (for offline message handling)
            const existingMessage = document.querySelector(`[data-message-id="${message.id}"]`);
            if (existingMessage) return;
            
            // Create message element
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            // Set message ID if available
            if (message.id) {
                messageElement.dataset.messageId = message.id;
            }
            
            // Format timestamp
            let timeString = 'Acum';
            if (message.timestamp) {
                const timestamp = message.timestamp.toDate ? message.timestamp.toDate() : new Date();
                timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // Handle different message types
            if (message.type === 'system') {
                // System message
                messageElement.className = 'message-system';
                messageElement.textContent = message.content;
            } else if (message.type === 'user') {
                // User message (sent by current user)
                messageElement.classList.add('message-sent');
                
                // Create HTML for the message
                let messageHtml = '';
                
                // Add text content
                if (message.content) {
                    messageHtml += `
                        <div class="message-content">
                            ${message.content}
                        </div>
                    `;
                }
                
                // Add metadata (time, status)
                let statusHtml = '';
                if (message.status === 'sent') {
                    statusHtml = `<i class="material-icons" aria-hidden="true">done</i>`;
                } else if (message.status === 'delivered') {
                    statusHtml = `<i class="material-icons" aria-hidden="true">done_all</i>`;
                } else if (message.status === 'read') {
                    statusHtml = `<i class="material-icons" style="color: var(--secondary-color);" aria-hidden="true">done_all</i>`;
                }
                
                messageHtml += `
                    <div class="message-meta">
                        <span class="message-time">${timeString}</span>
                        <span class="message-status">
                            ${statusHtml}
                        </span>
                    </div>
                `;
                
                messageElement.innerHTML = messageHtml;
            } else if (message.type === 'agent') {
                // Agent message
                messageElement.classList.add('message-received');
                
                // Hide typing indicator when receiving agent message
                hideTypingIndicator();
                
                // Create HTML for the message
                let messageHtml = '';
                
                // Add text content
                if (message.content) {
                    messageHtml += `
                        <div class="message-content">
                            ${message.content}
                        </div>
                    `;
                }
                
                // Add metadata (time)
                messageHtml += `
                    <div class="message-meta">
                        <span class="message-time">${timeString}</span>
                    </div>
                `;
                
                messageElement.innerHTML = messageHtml;
            }
            
            // Add to chat
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            scrollToBottom();
        }
        
        // Display a local message (for offline support)
        function displayLocalMessage(message) {
            // Clone the message object to avoid modifying the original
            const localMessage = { ...message };
            
            // Add a local ID
            localMessage.id = 'local-' + Date.now();
            
            // Add pending status indicator
            localMessage.status = 'pending';
            
            // Display with "pending" styling
            displayMessage(localMessage);
            
            // Update the message element to show it's queued
            const messageElement = document.querySelector(`[data-message-id="${localMessage.id}"]`);
            if (messageElement) {
                const statusSpan = messageElement.querySelector('.message-status');
                if (statusSpan) {
                    statusSpan.innerHTML = '<i class="material-icons" style="color: var(--warning-color);">schedule</i>';
                }
            }
        }
        
        // Add a system message
        function addSystemMessage(text) {
            // Create a temporary ID to prevent duplication
            const tempId = 'local-system-' + Date.now();
            
            // First add to UI immediately with the temp ID
            const systemMessage = {
                type: 'system',
                content: text,
                timestamp: new Date(),
                id: tempId // Temporary ID to prevent duplication
            };
            
            displayMessage(systemMessage);
            
            // Then add to Firestore, but don't display it again when it comes back
            db.collection('chats').doc(currentChatId).collection('messages').add({
                type: 'system',
                content: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                clientGeneratedId: tempId // Track that this was generated by the client
            }).catch(error => {
                console.error('Error adding system message:', error);
            });
        }
        
        // Scroll chat to bottom
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 50);
        }
        
        // =============================================
        // Typing Indicators
        // =============================================
        
        // Handle user typing start
        function handleTypingStart() {
            if (!isTyping) {
                isTyping = true;
                
                // Notify the server that the user is typing
                db.collection('chats').doc(currentChatId).collection('typing')
                    .doc('user')
                    .set({
                        isTyping: true,
                        userId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(error => {
                        console.error('Error updating typing status:', error);
                    });
            }
            
            // Reset the typing timeout
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            typingTimeout = setTimeout(resetTypingIndicator, 3000);
        }
        
        // Reset typing indicator
        function resetTypingIndicator() {
            if (isTyping) {
                isTyping = false;
                
                // Notify the server that the user stopped typing
                db.collection('chats').doc(currentChatId).collection('typing')
                    .doc('user')
                    .set({
                        isTyping: false,
                        userId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(error => {
                        console.error('Error updating typing status:', error);
                    });
            }
            
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                typingTimeout = null;
            }
        }
        
        // Show agent typing indicator
        function showTypingIndicator() {
            // Check if typing indicator already exists
            let typingIndicator = document.querySelector('.typing-indicator');
            
            if (!typingIndicator) {
                typingIndicator = document.createElement('div');
                typingIndicator.className = 'typing-indicator';
                typingIndicator.setAttribute('aria-label', 'Agentul scrie un mesaj');
                
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('span');
                    dot.className = 'typing-dot';
                    typingIndicator.appendChild(dot);
                }
                
                chatMessages.appendChild(typingIndicator);
                scrollToBottom();
            }
        }
        
        // Hide agent typing indicator
        function hideTypingIndicator() {
            const typingIndicator = document.querySelector('.typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // =============================================
        // Read Receipts
        // =============================================
        
        // Set up read receipts
        function setupReadReceipts() {
            // Update read status when the chat is visible
            document.addEventListener('visibilitychange', updateReadStatus);
            chatMessages.addEventListener('scroll', updateReadStatus);
            
            // Initial update
            updateReadStatus();
        }
        
        // Update read status for all messages
        function updateReadStatus() {
            if (document.visibilityState === 'visible' && !chatEnded) {
                // Find the latest agent message
                const agentMessages = document.querySelectorAll('.message-received');
                if (agentMessages.length > 0) {
                    const lastAgentMessage = agentMessages[agentMessages.length - 1];
                    const messageId = lastAgentMessage.dataset.messageId;
                    
                    if (messageId && !messageId.startsWith('local-')) {
                        updateMessageReadStatus(messageId);
                    }
                }
            }
        }
        
        // Update a specific message's read status
        function updateMessageReadStatus(messageId) {
            db.collection('chats').doc(currentChatId).collection('messages').doc(messageId)
                .update({
                    readAt: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(error => {
                    console.error('Error updating read status:', error);
                });
        }
        
        // =============================================
        // Chat Conclusion
        // =============================================
        
        // Handle chat ended
        function handleChatEnded() {
            chatEnded = true;
            
            // Add system message
            addSystemMessage('Conversația a fost încheiată.');
            
            // Disable input
            messageInput.disabled = true;
            btnSendMessage.disabled = true;
            
            // Show end screen after a delay
            setTimeout(() => {
                chatArea.style.display = 'none';
                chatEnd.style.display = 'flex';
            }, 3000);
        }
        
        // Confirm end chat
        function confirmEndChat() {
            if (confirm('Sigur doriți să încheiați această conversație?')) {
                endChat();
            }
        }
        
        // End chat
        function endChat() {
            chatEnded = true;
            
            // Update chat status in Firestore
            db.collection('chats').doc(currentChatId).update({
                status: 'closed',
                endedBy: 'user',
                endedAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                handleChatEnded();
            }).catch(error => {
                console.error('Error ending chat:', error);
                showNotice(errorNotice, 'Eroare la închiderea conversației. Vă rugăm să încercați din nou.');
            });
        }
        
        // Request transcript
        function requestTranscript() {
            const email = document.getElementById('chat-email').value;
            
            if (!email || !email.includes('@')) {
                showNotice(errorNotice, 'Vă rugăm să introduceți o adresă de email validă.');
                return;
            }
            
            // Show loading state
            btnRequestTranscript.disabled = true;
            btnRequestTranscript.textContent = 'Se trimite...';
            
            // Call Cloud Function to send transcript
            const sendTranscriptFunction = firebase.functions().httpsCallable('sendChatTranscript');
            sendTranscriptFunction({ chatId: currentChatId, email: email })
                .then(result => {
                    showNotice(successNotice, 'Transcriptul a fost trimis la adresa de email specificată.');
                    btnRequestTranscript.textContent = 'Transcript trimis ✓';
                })
                .catch(error => {
                    console.error('Error requesting transcript:', error);
                    showNotice(errorNotice, 'Eroare la trimiterea transcriptului. Vă rugăm să încercați din nou.');
                    btnRequestTranscript.disabled = false;
                    btnRequestTranscript.textContent = 'Primește transcript';
                });
        }
        
        // Reset chat and start a new one
        function resetChat() {
            // Clean up current chat listeners first
            cleanupChatListeners();
            
            // Reset all variables
            currentChatId = null;
            selectedDepartment = null;
            chatSessionKey = null;
            agentPublicKey = null;
            chatEnded = false;
            isTyping = false;
            agentJoinedFlag = false;
            
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                typingTimeout = null;
            }
            
            // Clear message queue
            messageQueue = [];
            if (currentChatId) {
                localStorage.removeItem('messageQueue_' + currentChatId);
            }
            
            // Reset rate limiting
            rateLimitConfig.sentMessages = [];
            rateLimitConfig.isLimited = false;
            
            // Clear chat messages
            chatMessages.innerHTML = '';
            
            // Reset all notices
            errorNotice.style.display = 'none';
            successNotice.style.display = 'none';
            formErrorNotice.style.display = 'none';
            
            // Reset message input
            messageInput.value = '';
            messageInput.disabled = false;
            
            // Reset buttons
            btnSendMessage.disabled = false;
            btnRequestTranscript.disabled = false;
            btnRequestTranscript.textContent = 'Primește transcript';

            // Reset form fields
            document.getElementById('chat-subject').value = '';
            document.getElementById('chat-email').value = '';
            document.getElementById('chat-name').value = '';
            document.getElementById('privacy-check').checked = false;
            document.getElementById('recording-check').checked = false;
            
            // Hide all sections except emergency check (since user is still authenticated)
            chatEnd.style.display = 'none';
            chatArea.style.display = 'none';
            chatForm.style.display = 'none';
            departmentSelect.style.display = 'none';
            loadingState.style.display = 'none';
            welcomeScreen.style.display = 'none';
            phoneVerification.style.display = 'none';
            
            // Show emergency check
            emergencyCheck.style.display = 'flex';
            
            // Generate a new encryption key
            chatSessionKey = generateEncryptionKey();
        }
        
        // =============================================
        // Cleanup function for listeners when chat ends
        // =============================================
        function cleanupChatListeners() {
            if (window.chatListeners) {
                if (window.chatListeners.chatDoc) {
                    window.chatListeners.chatDoc();
                }
                if (window.chatListeners.messages) {
                    window.chatListeners.messages();
                }
                if (window.chatListeners.typing) {
                    window.chatListeners.typing();
                }
                window.chatListeners = null;
            }
        }

        // Initialize the chat
        initializeChat();
    </script>
</body>
</html>
