<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Chat online cu Poliția Locală Slobozia pentru raportarea problemelor non-urgente">
    <meta name="theme-color" content="#1A2F5F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Chat - Poliția Locală Slobozia</title>
    
    <!-- Firebase SDK - Optimized version -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-functions-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Reset & Base Styles */
        :root {
            --primary-color: #1A2F5F;
            --primary-dark: #0F1B38;
            --secondary-color: #1E88E5;
            --secondary-light: rgba(30, 136, 229, 0.2);
            --accent-color: #FFCA28;
            --accent-dark: #FFC107;
            --accent-light: rgba(255, 202, 40, 0.15);
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-light: #FFFFFF;
            --background-light: #F5F7FA;
            --background-dark: #172B4D;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --border-radius-small: 12px;
            --border-radius-medium: 16px;
            --border-radius-large: 22px;
            --shadow-small: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 6px 20px rgba(0, 0, 0, 0.15);
            --shadow-large: 0 10px 30px rgba(0, 0, 0, 0.2);
            --transition-fast: all 0.3s ease;
            --transition-medium: all 0.5s ease;
            --font-size-base: 16px;
            --font-size-large: 18px;
            --font-size-xl: 20px;
            --font-size-xxl: 24px;
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-xxl: 48px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
            -webkit-overflow-scrolling: touch;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            font-size: var(--font-size-base);
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--background-light);
            -webkit-tap-highlight-color: transparent;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            margin-bottom: var(--spacing-md);
        }
        
        a:focus, button:focus, input:focus, select:focus, textarea:focus {
            outline: 3px solid var(--secondary-light);
            outline-offset: 2px;
        }
        
        button, input, textarea {
            font-family: inherit;
            font-size: inherit;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* App Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 100%;
            margin: 0 auto;
            overflow: hidden;
            background-color: white;
        }
        
        /* Header */
        .app-header {
            background-color: var(--primary-color);
            color: white;
            padding: var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-small);
            z-index: 10;
            height: 70px;
            flex-shrink: 0;
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }
        
        .header-logo {
            width: 40px;
            height: 40px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--spacing-md);
            flex-shrink: 0;
        }
        
        .header-logo img {
            width: 30px;
            height: 30px;
        }
        
        .header-title {
            font-size: var(--font-size-large);
            font-weight: 600;
        }
        
        .header-status {
            font-size: calc(var(--font-size-base) - 2px);
            opacity: 0.9;
            margin-top: -4px;
        }
        
        .header-actions {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .header-actions button {
            background: none;
            border: none;
            color: white;
            font-size: var(--font-size-xl);
            cursor: pointer;
            padding: var(--spacing-xs);
            transition: var(--transition-fast);
        }
        
        .header-actions button:hover {
            color: var(--accent-color);
        }
        
        /* Main Content Area */
        .app-content {
            flex: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        /* Two-column Layout for Desktop */
        @media (min-width: 992px) {
            .app-content {
                flex-direction: row;
            }
            
            .app-sidebar {
                width: 40%;
                border-right: 1px solid rgba(0, 0, 0, 0.1);
                overflow-y: auto;
                display: flex;
                flex-direction: column;
            }
            
            .app-main {
                width: 60%;
                display: flex;
                flex-direction: column;
                position: relative;
            }
            
            .welcome-screen, .emergency-check, .department-select, 
            .chat-form, .chat-area, .chat-end, .loading-container {
                height: 100%;
            }
        }
        
        /* App Sidebar for Desktop */
        .app-sidebar {
            display: none;
            background-color: var(--background-light);
        }
        
        @media (min-width: 992px) {
            .app-sidebar {
                display: flex;
            }
        }
        
        .sidebar-content {
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-xl);
        }
        
        .sidebar-logo {
            width: 64px;
            height: 64px;
            background: white;
            border-radius: 50%;
            box-shadow: var(--shadow-small);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--spacing-md);
        }
        
        .sidebar-logo img {
            width: 48px;
            height: 48px;
        }
        
        .sidebar-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .sidebar-section {
            margin-bottom: var(--spacing-xl);
            animation: fadeIn 0.5s ease-out;
        }
        
        .sidebar-section-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
        }
        
        .sidebar-section-title i {
            margin-right: var(--spacing-xs);
            color: var(--secondary-color);
        }
        
        .sidebar-section-content {
            background: white;
            border-radius: var(--border-radius-medium);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-small);
        }
        
        .sidebar-info-list {
            list-style: none;
        }
        
        .sidebar-info-item {
            display: flex;
            margin-bottom: var(--spacing-sm);
            align-items: flex-start;
        }
        
        .sidebar-info-item i {
            color: var(--secondary-color);
            margin-right: var(--spacing-sm);
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .sidebar-info-text {
            flex: 1;
        }
        
        .sidebar-info-label {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .sidebar-department-info {
            display: none;
        }
        
        .sidebar-quick-links {
            margin-top: auto;
            padding-top: var(--spacing-lg);
        }
        
        .quick-links-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }
        
        .quick-link {
            background-color: white;
            border-radius: var(--border-radius-small);
            padding: var(--spacing-xs) var(--spacing-md);
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 14px;
            box-shadow: var(--shadow-small);
            transition: var(--transition-fast);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .quick-link:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        /* App Main Content */
        .app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--spacing-xl);
            height: 100%;
            background: linear-gradient(to bottom, rgba(26, 47, 95, 0.9) 0%, rgba(26, 47, 95, 0.7) 100%), url('https://images4.imagebam.com/c0/05/ef/ME11M3FT_o.png');
            background-size: cover;
            background-position: center;
            color: var(--text-light);
        }
        
        .welcome-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: var(--spacing-lg);
        }
        
        .welcome-description {
            font-size: var(--font-size-large);
            margin-bottom: var(--spacing-xl);
            max-width: 600px;
        }
        
        .welcome-logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-medium);
        }
        
        .welcome-logo img {
            width: 60px;
            height: 60px;
        }
        
        /* Emergency Check */
        .emergency-check {
            padding: var(--spacing-xl);
            background-color: white;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .emergency-title {
            font-size: var(--font-size-xxl);
            color: var(--danger-color);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
        }
        
        .emergency-title i {
            margin-right: var(--spacing-sm);
        }
        
        .emergency-text {
            font-size: var(--font-size-large);
            margin-bottom: var(--spacing-xl);
            color: var(--text-primary);
        }
        
        .emergency-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        /* Department Selection */
        .department-select {
            padding: var(--spacing-lg);
            height: 100%;
            overflow-y: auto;
            display: none;
            flex-direction: column;
            background-color: white;
        }
        
        .department-title {
            font-family: 'Montserrat', sans-serif;
            font-size: var(--font-size-xl);
            margin-bottom: var(--spacing-xl);
            text-align: center;
            color: var(--primary-color);
        }
        
        .department-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }
        
        .department-item {
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-medium);
            background-color: var(--background-light);
            box-shadow: var(--shadow-small);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
        }
        
        .department-item:active {
            transform: scale(0.98);
        }
        
        .department-item:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }
        
        .department-icon {
            width: 56px;
            height: 56px;
            background-color: var(--secondary-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--spacing-md);
            color: var(--secondary-color);
            flex-shrink: 0;
        }
        
        .department-icon i {
            font-size: 28px;
        }
        
        .department-info {
            flex: 1;
        }
        
        .department-name {
            font-weight: 600;
            font-size: var(--font-size-large);
            margin-bottom: 4px;
        }
        
        .department-description {
            color: var(--text-secondary);
        }
        
        /* Pre-Chat Form */
        .chat-form {
            padding: var(--spacing-lg);
            overflow-y: auto;
            height: 100%;
            display: none;
            flex-direction: column;
            background-color: white;
        }
        
        .form-title {
            font-family: 'Montserrat', sans-serif;
            font-size: var(--font-size-xl);
            color: var(--primary-color);
            margin-bottom: var(--spacing-lg);
        }
        
        .form-group {
            margin-bottom: var(--spacing-lg);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            color: var(--text-primary);
            font-size: var(--font-size-base);
        }
        
        .form-control {
            width: 100%;
            padding: var(--spacing-md);
            border-radius: var(--border-radius-small);
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-color: var(--background-light);
            transition: var(--transition-fast);
            font-size: var(--font-size-large);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
        }
        
        .form-check {
            display: flex;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
            min-height: 36px; /* Ensure both checkboxes have same height */
        }
        
        .form-check-input {
            margin-right: var(--spacing-sm);
            margin-top: 4px;
            width: 20px;
            height: 20px;
            flex-shrink: 0; /* Prevent checkbox from shrinking */
        }
        
        .form-check-label {
            font-size: var(--font-size-base);
            color: var(--text-secondary);
            line-height: 1.5;
            flex: 1; /* Allow label to take remaining space */
        }
        
        .form-check-label a {
            color: var(--secondary-color);
            text-decoration: none;
        }
        
        .gdpr-info {
            margin-top: var(--spacing-md);
            font-size: 14px;
            color: var(--text-secondary);
            background-color: rgba(0, 0, 0, 0.03);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-small);
        }
        
        /* Chat Area */
        .chat-area {
            height: 100%;
            display: flex;
            flex-direction: column;
            display: none;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
            background-color: var(--background-light);
            display: flex;
            flex-direction: column;
            -webkit-overflow-scrolling: touch;
        }
        
        .message {
            margin-bottom: var(--spacing-md);
            max-width: 85%;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-received {
            align-self: flex-start;
        }
        
        .message-sent {
            align-self: flex-end;
        }
        
        .message-content {
            padding: var(--spacing-md);
            border-radius: var(--border-radius-medium);
            position: relative;
            font-size: var(--font-size-large);
            box-shadow: var(--shadow-small);
        }
        
        .message-received .message-content {
            background-color: white;
            border-bottom-left-radius: 4px;
        }
        
        .message-sent .message-content {
            background-color: var(--secondary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-top: 4px;
            padding: 0 var(--spacing-xs);
        }
        
        .message-time {
            color: var(--text-secondary);
        }
        
        .message-status {
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }
        
        .message-status i {
            font-size: 14px;
            margin-left: 4px;
        }
        
        .message-system {
            align-self: center;
            max-width: 90%;
            background-color: rgba(0,0,0,0.05);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-small);
            margin-bottom: var(--spacing-md);
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .chat-input {
            padding: var(--spacing-md);
            background-color: white;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .chat-input-field {
            flex: 1;
            padding: var(--spacing-md);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 24px;
            background-color: var(--background-light);
            transition: var(--transition-fast);
            font-size: var(--font-size-large);
        }
        
        .chat-input-field:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
        }
        
        .chat-actions {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .chat-action {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--secondary-light);
            color: var(--secondary-color);
            border: none;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .chat-action:hover, .chat-action:active {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .chat-action i {
            font-size: 24px;
        }
        
        .chat-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .chat-action-send {
            background-color: var(--secondary-color);
            color: white;
        }
        
        /* Chat End */
        .chat-end {
            padding: var(--spacing-xl);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
        }
        
        .chat-end-icon {
            font-size: 48px;
            color: var(--success-color);
            margin-bottom: var(--spacing-md);
        }
        
        .chat-end-title {
            font-family: 'Montserrat', sans-serif;
            font-size: var(--font-size-xxl);
            color: var(--primary-color);
            margin-bottom: var(--spacing-md);
        }
        
        .chat-end-text {
            margin-bottom: var(--spacing-xl);
            color: var(--text-secondary);
            font-size: var(--font-size-large);
        }
        
        /* Loading State */
        .loading-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            gap: var(--spacing-lg);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Notices */
        .notice {
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            border-radius: var(--border-radius-small);
            font-size: var(--font-size-base);
            display: none;
        }
        
        .error-notice {
            background-color: rgba(244, 67, 54, 0.1);
            border-left: 4px solid var(--danger-color);
            color: var(--danger-color);
        }
        
        .success-notice {
            background-color: rgba(76, 175, 80, 0.1);
            border-left: 4px solid var(--success-color);
            color: var(--success-color);
        }
        
        /* Typing Animation */
        @keyframes typingAnimation {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            margin: 10px 0;
            align-self: flex-start;
            background: white;
            padding: 12px 16px;
            border-radius: var(--border-radius-medium);
            box-shadow: var(--shadow-small);
        }
        
        .typing-dot {
            height: 10px;
            width: 10px;
            margin: 0 2px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: inline-block;
            animation: typingAnimation 1.5s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--border-radius-medium);
            font-weight: 600;
            text-decoration: none;
            transition: var(--transition-fast);
            font-size: var(--font-size-large);
            border: none;
            cursor: pointer;
            min-height: 56px;
            width: 100%;
            max-width: 400px;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
            box-shadow: var(--shadow-small);
        }
        
        .btn-primary:hover, .btn-primary:focus {
            background-color: #1976d2;
            box-shadow: var(--shadow-medium);
        }
        
        .btn-secondary {
            background-color: var(--background-light);
            color: var(--text-primary);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary:hover, .btn-secondary:focus {
            background-color: #e9e9e9;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
            box-shadow: var(--shadow-small);
        }
        
        .btn-danger:hover, .btn-danger:focus {
            background-color: #d32f2f;
            box-shadow: var(--shadow-medium);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
            box-shadow: var(--shadow-small);
        }
        
        .btn-success:hover, .btn-success:focus {
            background-color: #43a047;
            box-shadow: var(--shadow-medium);
        }
        
        .btn i {
            margin-right: var(--spacing-sm);
            font-size: 24px;
        }
        
        /* Welcome Screen Button */
        .welcome-btn {
            max-width: 280px;
            margin-top: var(--spacing-md);
        }
        
        /* Center the start chat button */
        #btnStartChat {
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            .message,
            .btn:hover,
            .department-item:hover,
            .loading-spinner,
            .typing-dot,
            .sidebar-section {
                animation: none !important;
                transition: none !important;
                transform: none !important;
            }
        }
        
        /* High contrast mode */
        @media (forced-colors: active) {
            .btn,
            .chat-action,
            .form-control,
            .message-content {
                border: 1px solid currentColor;
            }
        }
        
        /* Responsive Adjustments */
        @media (min-width: 768px) {
            .emergency-buttons {
                flex-direction: row;
                justify-content: center;
            }
            
            .btn {
                width: auto;
            }
        }
        
        /* Desktop-specific improvements */
        @media (min-width: 992px) {
            .welcome-screen {
                background-position: left center;
            }
            
            .department-list {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-md);
            }
            
            .welcome-btn {
                max-width: 320px;
            }
            
            .chat-messages {
                padding: var(--spacing-lg);
            }
            
            .message-content {
                padding: var(--spacing-md) var(--spacing-lg);
            }
            
            .chat-form {
                padding: var(--spacing-xl);
                max-width: 800px;
                margin: 0 auto;
                width: 100%;
            }
            
            .chat-end {
                padding: var(--spacing-xxl);
            }
        }
        
        /* PWA Installation Banner */
        .pwa-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            padding: var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 999;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .pwa-banner.show {
            transform: translateY(0);
        }
        
        .pwa-message {
            flex: 1;
            margin-right: var(--spacing-md);
        }
        
        .pwa-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .pwa-buttons {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .pwa-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-small);
            font-weight: 600;
            border: none;
            cursor: pointer;
        }
        
        .pwa-btn-install {
            background-color: var(--accent-color);
            color: var(--text-primary);
        }
        
        .pwa-btn-dismiss {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- App Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="header-logo">
                    <img src="https://images4.imagebam.com/d3/36/5c/ME11M3EE_o.png" alt="Logo Poliția Locală">
                </div>
                <div>
                    <div class="header-title">Poliția Locală Slobozia</div>
                    <div class="header-status">
                        <span id="connectionStatus">Online</span> • 
                        <span id="securityStatus">Chat Securizat</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <!-- Added Home Button -->
                <a href="/" aria-label="Pagina principală">
                    <button id="btnHome" aria-label="Pagina principală">
                        <i class="material-icons">home</i>
                    </button>
                </a>
                <button id="btnCloseChat" aria-label="Închide chat">
                    <i class="material-icons">close</i>
                </button>
            </div>
        </header>
        
        <!-- Main App Content -->
        <main class="app-content">
            <!-- Sidebar for Desktop -->
            <aside class="app-sidebar">
                <div class="sidebar-content">
                    <div class="sidebar-header">
                        <div class="sidebar-logo">
                            <img src="https://images4.imagebam.com/16/bf/9a/ME11NRG3_o.png" alt="Logo Poliția Locală">
                        </div>
                        <div>
                            <h2 class="sidebar-title">Poliția Locală Slobozia</h2>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h3 class="sidebar-section-title">
                            <i class="material-icons">info</i>
                            Despre serviciul de chat
                        </h3>
                        <div class="sidebar-section-content">
                            <p>Serviciul de chat online al Poliției Locale Slobozia vă permite să raportați probleme non-urgente și să obțineți asistență în timp real de la agenții noștri.</p>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h3 class="sidebar-section-title">
                            <i class="material-icons">contact_phone</i>
                            Informații de contact
                        </h3>
                        <div class="sidebar-section-content">
                            <ul class="sidebar-info-list">
                                <li class="sidebar-info-item">
                                    <i class="material-icons">location_on</i>
                                    <div class="sidebar-info-text">
                                        <div class="sidebar-info-label">Adresă:</div>
                                        <div>Str. Răzoare, nr. 3, Slobozia, Ialomița</div>
                                    </div>
                                </li>
                                <li class="sidebar-info-item">
                                    <i class="material-icons">phone</i>
                                    <div class="sidebar-info-text">
                                        <div class="sidebar-info-label">Dispecerat:</div>
                                        <div>0243 955</div>
                                    </div>
                                </li>
                                <li class="sidebar-info-item">
                                    <i class="material-icons">email</i>
                                    <div class="sidebar-info-text">
                                        <div class="sidebar-info-label">Email:</div>
                                        <div>politia.locala@sloboziail.ro</div>
                                    </div>
                                </li>
                                <li class="sidebar-info-item">
                                    <i class="material-icons">schedule</i>
                                    <div class="sidebar-info-text">
                                        <div class="sidebar-info-label">Program de lucru:</div>
                                        <div>Luni - Vineri: 08:00 - 16:00</div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Dynamic Department Information (shows when department selected) -->
                    <div id="sidebarDepartmentInfo" class="sidebar-section sidebar-department-info">
                        <h3 class="sidebar-section-title">
                            <i class="material-icons">business</i>
                            <span id="sidebarDepartmentTitle">Informații departament</span>
                        </h3>
                        <div class="sidebar-section-content">
                            <div id="sidebarDepartmentContent">
                                <!-- Content populated by JS when department selected -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="sidebar-section sidebar-quick-links">
                        <h3 class="sidebar-section-title">
                            <i class="material-icons">link</i>
                            Linkuri utile
                        </h3>
                        <div class="sidebar-section-content">
                            <div class="quick-links-list">
                                <a href="https://www.sloboziail.ro" target="_blank" class="quick-link">Primăria Slobozia</a>
                                <a href="/faq" class="quick-link">Întrebări frecvente</a>
                                <a href="/servicii" class="quick-link">Servicii</a>
                                <a href="/legislatie" class="quick-link">Legislație</a>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
            
            <!-- Main Content Area -->
            <div class="app-main">
                <!-- Error Notice -->
                <div id="errorNotice" class="notice error-notice" role="alert"></div>
                
                <!-- Success Notice -->
                <div id="successNotice" class="notice success-notice" role="status"></div>
                
                <!-- Welcome Screen -->
                <div id="welcomeScreen" class="welcome-screen">
                    <div class="welcome-logo">
                        <img src="https://images4.imagebam.com/16/bf/9a/ME11NRG3_o.png" alt="Logo Poliția Locală">
                    </div>
                    <h1 class="welcome-title">Chat Online cu Poliția Locală</h1>
                    <p class="welcome-description">Raportați probleme non-urgente și primiți asistență în timp real de la agenții Poliției Locale Slobozia.</p>
                    <button id="btnStartWelcome" class="btn btn-primary welcome-btn">
                        <i class="material-icons">message</i> Începe Chat
                    </button>
                </div>
                
                <!-- Emergency Check -->
                <div id="emergencyCheck" class="emergency-check" style="display:none;">
                    <h2 class="emergency-title">
                        <i class="material-icons">warning</i>Verificare Urgență
                    </h2>
                    <p class="emergency-text">Vă aflați într-o situație de urgență care necesită asistență imediată?</p>
                    <div class="emergency-buttons">
                        <button id="btnEmergency" class="btn btn-danger">
                            <i class="material-icons">call</i> Da, am nevoie de ajutor acum
                        </button>
                        <button id="btnNonemergency" class="btn btn-success">
                            <i class="material-icons">check_circle</i> Nu, este o situație non-urgentă
                        </button>
                    </div>
                </div>
                
                <!-- Department Selection -->
                <div id="departmentSelect" class="department-select">
                    <h2 class="department-title">Selectați departamentul care vă poate ajuta</h2>
                    
                    <div class="department-list">
                        <div class="department-item" data-id="traffic">
                            <div class="department-icon">
                                <i class="material-icons">directions_car</i>
                            </div>
                            <div class="department-info">
                                <div class="department-name">Circulație Rutieră</div>
                                <div class="department-description">Probleme legate de trafic, parcare sau semaforizare</div>
                            </div>
                        </div>
                        
                        <div class="department-item" data-id="public-order">
                            <div class="department-icon">
                                <i class="material-icons">public</i>
                            </div>
                            <div class="department-info">
                                <div class="department-name">Ordine Publică</div>
                                <div class="department-description">Tulburarea liniștii publice, comportament necorespunzător</div>
                            </div>
                        </div>
                        
                        <div class="department-item" data-id="environment">
                            <div class="department-icon">
                                <i class="material-icons">nature</i>
                            </div>
                            <div class="department-info">
                                <div class="department-name">Protecția Mediului</div>
                                <div class="department-description">Depozitarea deșeurilor, poluare, animale abandonate</div>
                            </div>
                        </div>
                        
                        <div class="department-item" data-id="commerce">
                            <div class="department-icon">
                                <i class="material-icons">store</i>
                            </div>
                            <div class="department-info">
                                <div class="department-name">Control Comercial</div>
                                <div class="department-description">Comerț ilegal, nereguli în activități comerciale</div>
                            </div>
                        </div>
                        
                        <div class="department-item" data-id="general">
                            <div class="department-icon">
                                <i class="material-icons">help_outline</i>
                            </div>
                            <div class="department-info">
                                <div class="department-name">Informații Generale</div>
                                <div class="department-description">Întrebări generale, informații despre serviciile poliției</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Pre-Chat Form -->
                <div id="chatForm" class="chat-form">
                    <div class="notice error-notice" id="formErrorNotice" style="display:none;">
                        Vă rugăm să completați toate câmpurile obligatorii.
                    </div>
                    
                    <h2 class="form-title">Înainte de a începe</h2>
                    
                    <div class="form-group">
                        <label class="form-label" for="chat-subject">Subiect:</label>
                        <input type="text" id="chat-subject" class="form-control" placeholder="Descrieți pe scurt problema" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="chat-name">Numele dumneavoastră:</label>
                        <input type="text" id="chat-name" class="form-control" placeholder="Nume și prenume" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="chat-email">Email (pentru transcriere):</label>
                        <input type="email" id="chat-email" class="form-control" placeholder="adresa@email.ro">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="chat-phone">Telefon:</label>
                        <input type="tel" id="chat-phone" class="form-control" placeholder="Număr de telefon">
                    </div>
                    
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="privacy-check" required>
                            <label class="form-check-label" for="privacy-check">Am citit și accept <a href="/privacy-policy" target="_blank">politica de confidențialitate</a>.</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="recording-check" required>
                            <label class="form-check-label" for="recording-check">Înțeleg că această conversație poate fi înregistrată pentru îmbunătățirea serviciilor.</label>
                        </div>
                    </div>
                    
                    <div class="gdpr-info">
                        <p>Datele dumneavoastră sunt protejate în conformitate cu Regulamentul General privind Protecția Datelor (GDPR).</p>
                    </div>
                    
                    <button id="btnStartChat" class="btn btn-primary">
                        <i class="material-icons">chat</i> Începe Chat
                    </button>
                </div>
                
                <!-- Loading State -->
                <div id="loadingState" class="loading-container">
                    <div class="loading-spinner"></div>
                    <p id="loadingText">Se conectează la chat...</p>
                </div>
                
                <!-- Chat Area -->
                <div id="chatArea" class="chat-area">
                    <!-- Chat Messages -->
                    <div id="chatMessages" class="chat-messages"></div>
                    
                    <!-- Chat Input -->
                    <div id="chatInput" class="chat-input">
                        <input type="text" class="chat-input-field" id="messageInput" placeholder="Scrieți mesajul aici..." aria-label="Scrieți mesajul">
                        <div class="chat-actions">
                            <button id="btnSendMessage" class="chat-action chat-action-send" aria-label="Trimite mesaj">
                                <i class="material-icons">send</i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Chat End -->
                <div id="chatEnd" class="chat-end">
                    <i class="material-icons chat-end-icon">check_circle</i>
                    <h2 class="chat-end-title">Conversație încheiată</h2>
                    <p class="chat-end-text">Vă mulțumim pentru că ați contactat Poliția Locală Slobozia. Puteți primi transcriptul conversației pe email sau puteți începe o nouă conversație.</p>
                    <button id="btnRequestTranscript" class="btn btn-secondary">
                        <i class="material-icons">description</i> Primește transcript
                    </button>
                    <button id="btnStartNewChat" class="btn btn-primary" style="margin-top: var(--spacing-md);">
                        <i class="material-icons">chat</i> Conversație nouă
                    </button>
                </div>
            </div>
        </main>
        
        <!-- PWA Installation Banner -->
        <div id="pwaBanner" class="pwa-banner">
            <div class="pwa-message">
                <div class="pwa-title">Instalează aplicația</div>
                <div class="pwa-description">Adaugă pe ecranul principal pentru acces rapid</div>
            </div>
            <div class="pwa-buttons">
                <button id="btnDismissPwa" class="pwa-btn pwa-btn-dismiss">Nu acum</button>
                <button id="btnInstallPwa" class="pwa-btn pwa-btn-install">Instalează</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase configuration -->
    <script src="../chat/js/firebase-config.js"></script>
    
    <script>
        // =============================================
        // Firebase Services
        // =============================================
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();
        
        // =============================================
        // DOM Elements
        // =============================================
        // Screens
        const welcomeScreen = document.getElementById('welcomeScreen');
        const emergencyCheck = document.getElementById('emergencyCheck');
        const departmentSelect = document.getElementById('departmentSelect');
        const chatForm = document.getElementById('chatForm');
        const loadingState = document.getElementById('loadingState');
        const chatArea = document.getElementById('chatArea');
        const chatEnd = document.getElementById('chatEnd');
        
        // Notices
        const errorNotice = document.getElementById('errorNotice');
        const successNotice = document.getElementById('successNotice');
        const formErrorNotice = document.getElementById('formErrorNotice');
        
        // Chat Elements
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const messageInput = document.getElementById('messageInput');
        
        // Buttons
        const btnStartWelcome = document.getElementById('btnStartWelcome');
        const btnEmergency = document.getElementById('btnEmergency');
        const btnNonemergency = document.getElementById('btnNonemergency');
        const btnStartChat = document.getElementById('btnStartChat');
        const btnSendMessage = document.getElementById('btnSendMessage');
        const btnCloseChat = document.getElementById('btnCloseChat');
        const btnRequestTranscript = document.getElementById('btnRequestTranscript');
        const btnStartNewChat = document.getElementById('btnStartNewChat');
        
        // Department selection
        const departmentItems = document.querySelectorAll('.department-item');
        
        // Sidebar elements
        const sidebarDepartmentInfo = document.getElementById('sidebarDepartmentInfo');
        const sidebarDepartmentTitle = document.getElementById('sidebarDepartmentTitle');
        const sidebarDepartmentContent = document.getElementById('sidebarDepartmentContent');
        
        // Other elements
        const connectionStatus = document.getElementById('connectionStatus');
        const securityStatus = document.getElementById('securityStatus');
        const loadingText = document.getElementById('loadingText');
        
        // PWA Banner
        const pwaBanner = document.getElementById('pwaBanner');
        const btnDismissPwa = document.getElementById('btnDismissPwa');
        const btnInstallPwa = document.getElementById('btnInstallPwa');
        
        // =============================================
        // State Variables
        // =============================================
        let currentUser = null;
        let currentChatId = null;
        let selectedDepartment = null;
        let chatSessionKey = null; // For encryption
        let agentPublicKey = null; // For encryption
        let chatEnded = false;
        let isTyping = false;
        let typingTimeout = null;
        let lastReadTimestamp = null;
        let unreadCount = 0;
        let offlineTimeout = null;
        let messageQueue = []; // For offline message queuing
        let agentJoinedFlag = false; // Flag to track if agent has already joined
        let deferredPrompt = null; // For PWA installation
        
        // Department info for sidebar
        const departmentInfoMap = {
            'traffic': {
                title: 'Circulație Rutieră',
                icon: 'directions_car',
                content: `
                    <p>Departamentul de Circulație Rutieră se ocupă cu:</p>
                    <ul style="list-style: none; padding-left: 0; margin-top: 10px;">
                        <li style="margin-bottom: 8px;">• Monitorizarea traficului rutier</li>
                        <li style="margin-bottom: 8px;">• Sancționarea parcărilor neregulamentare</li>
                        <li style="margin-bottom: 8px;">• Coordonarea în zone cu trafic intens</li>
                        <li style="margin-bottom: 8px;">• Verificarea autorizațiilor de parcare</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Program patrulare:</strong> Zilnic, 07:00 - 22:00</p>
                `
            },
            'public-order': {
                title: 'Ordine Publică',
                icon: 'public',
                content: `
                    <p>Departamentul de Ordine Publică se ocupă cu:</p>
                    <ul style="list-style: none; padding-left: 0; margin-top: 10px;">
                        <li style="margin-bottom: 8px;">• Asigurarea ordinii și liniștii publice</li>
                        <li style="margin-bottom: 8px;">• Intervenții la reclamații și sesizări</li>
                        <li style="margin-bottom: 8px;">• Patrulări în zone publice și parcuri</li>
                        <li style="margin-bottom: 8px;">• Combaterea faptelor antisociale</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Program intervenție:</strong> Non-stop</p>
                `
            },
            'environment': {
                title: 'Protecția Mediului',
                icon: 'nature',
                content: `
                    <p>Departamentul de Protecția Mediului se ocupă cu:</p>
                    <ul style="list-style: none; padding-left: 0; margin-top: 10px;">
                        <li style="margin-bottom: 8px;">• Monitorizarea depozitării deșeurilor</li>
                        <li style="margin-bottom: 8px;">• Verificări privind curățenia spațiilor publice</li>
                        <li style="margin-bottom: 8px;">• Intervenții pentru animale abandonate</li>
                        <li style="margin-bottom: 8px;">• Sancționarea poluării fonice și a aerului</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Program funcționare:</strong> Luni - Vineri, 08:00 - 16:00</p>
                `
            },
            'commerce': {
                title: 'Control Comercial',
                icon: 'store',
                content: `
                    <p>Departamentul de Control Comercial se ocupă cu:</p>
                    <ul style="list-style: none; padding-left: 0; margin-top: 10px;">
                        <li style="margin-bottom: 8px;">• Verificarea autorizațiilor comerciale</li>
                        <li style="margin-bottom: 8px;">• Controlul comerțului stradal</li>
                        <li style="margin-bottom: 8px;">• Monitorizarea piețelor și târgurilor</li>
                        <li style="margin-bottom: 8px;">• Sancționarea activităților comerciale ilegale</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Program control:</strong> Luni - Sâmbătă, 08:00 - 20:00</p>
                `
            },
            'general': {
                title: 'Informații Generale',
                icon: 'help_outline',
                content: `
                    <p>Serviciul de Informații Generale oferă:</p>
                    <ul style="list-style: none; padding-left: 0; margin-top: 10px;">
                        <li style="margin-bottom: 8px;">• Îndrumări privind serviciile Poliției Locale</li>
                        <li style="margin-bottom: 8px;">• Informații despre depunerea petițiilor</li>
                        <li style="margin-bottom: 8px;">• Consiliere pentru diverse situații</li>
                        <li style="margin-bottom: 8px;">• Redirectare către departamentele competente</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Program relații publice:</strong> Luni - Vineri, 08:00 - 16:00</p>
                `
            }
        };
        
        // Rate limiting
        const rateLimitConfig = {
            maxMessages: 20,
            timeWindow: 60000, // 1 minute
            sentMessages: [],
            isLimited: false
        };
        
        // =============================================
        // Security and Encryption Functions
        // =============================================
        
        // Generate a new encryption key for the chat session
        function generateEncryptionKey() {
            // In a real implementation, this would use the Web Crypto API
            // For demo purposes, we're using CryptoJS to generate a random key
            const randomBytes = CryptoJS.lib.WordArray.random(32);
            return randomBytes.toString();
        }
        
        // Encrypt a message
        function encryptMessage(message, key) {
            try {
                if (!key) return message; // Fallback
                return CryptoJS.AES.encrypt(message, key).toString();
            } catch (error) {
                console.error('Encryption error:', error);
                return message; // Fallback
            }
        }
        
        // Decrypt a message
        function decryptMessage(encryptedMessage, key) {
            try {
                if (!key) return encryptedMessage; // Fallback
                const bytes = CryptoJS.AES.decrypt(encryptedMessage, key);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch (error) {
                console.error('Decryption error:', error);
                return encryptedMessage; // Fallback
            }
        }
        
        // =============================================
        // Chat Status and Connection Management
        // =============================================
        
        // Update connection status
        function updateConnectionStatus(status) {
            connectionStatus.textContent = status;
            
            if (status === 'Offline') {
                connectionStatus.style.color = 'var(--danger-color)';
                
                // Queue up messages when offline
                if (!chatEnded && chatArea.style.display !== 'none') {
                    showNotice(errorNotice, 'Conexiune pierdută. Mesajele vor fi trimise când conexiunea va fi restabilită.');
                }
            } else if (status === 'Connecting...') {
                connectionStatus.style.color = 'var(--warning-color)';
            } else {
                connectionStatus.style.color = '';
                errorNotice.style.display = 'none';
                
                // Send queued messages if there are any
                if (messageQueue.length > 0) {
                    processMessageQueue();
                }
            }
        }
        
        // Monitor connection status
        function setupConnectionMonitoring() {
            // Set up Firebase connection state monitoring
            try {
                const connectedRef = firebase.database().ref('.info/connected');
                connectedRef.on('value', (snap) => {
                    if (snap && snap.val() === true) {
                        updateConnectionStatus('Online');
                        
                        if (offlineTimeout) {
                            clearTimeout(offlineTimeout);
                            offlineTimeout = null;
                        }
                    } else {
                        // Set a timeout to show offline only after a delay
                        if (!offlineTimeout) {
                            offlineTimeout = setTimeout(() => {
                                updateConnectionStatus('Offline');
                            }, 5000);
                        }
                    }
                }, (error) => {
                    console.error('Error monitoring connection status:', error);
                    updateConnectionStatus(navigator.onLine ? 'Online' : 'Offline');
                });
            } catch (error) {
                console.error('Error setting up connection monitoring:', error);
                updateConnectionStatus(navigator.onLine ? 'Online' : 'Offline');
            }
            
            // Also monitor window online/offline events as a backup
            window.addEventListener('online', () => {
                updateConnectionStatus('Online');
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus('Offline');
            });
        }
        
        // Show a notice
        function showNotice(element, message, duration = 5000) {
            element.textContent = message;
            element.style.display = 'block';
            
            if (duration > 0) {
                setTimeout(() => {
                    element.style.display = 'none';
                }, duration);
            }
        }
        
        // =============================================
        // Rate Limiting
        // =============================================
        
        // Check rate limit before sending a message
        function checkRateLimit() {
            const now = Date.now();
            
            // Remove messages outside the time window
            rateLimitConfig.sentMessages = rateLimitConfig.sentMessages.filter(
                timestamp => now - timestamp < rateLimitConfig.timeWindow
            );
            
            // Check if we've hit the limit
            if (rateLimitConfig.sentMessages.length >= rateLimitConfig.maxMessages) {
                if (!rateLimitConfig.isLimited) {
                    rateLimitConfig.isLimited = true;
                    showNotice(
                        errorNotice, 
                        `Ați trimis prea multe mesaje într-un interval scurt de timp. Vă rugăm să așteptați ${Math.ceil(rateLimitConfig.timeWindow/1000)} secunde.`,
                        rateLimitConfig.timeWindow
                    );
                    
                    // Reset rate limit after the time window
                    setTimeout(() => {
                        rateLimitConfig.isLimited = false;
                        errorNotice.style.display = 'none';
                    }, rateLimitConfig.timeWindow);
                }
                return false;
            }
            
            return true;
        }
        
        // Record a sent message for rate limiting
        function recordMessageSent() {
            rateLimitConfig.sentMessages.push(Date.now());
        }
        
        // =============================================
        // Message Queue Management (for offline support)
        // =============================================
        
        // Add a message to the queue
        function queueMessage(message) {
            messageQueue.push(message);
            localStorage.setItem('messageQueue_' + currentChatId, JSON.stringify(messageQueue));
        }
        
        // Process the message queue when back online
        function processMessageQueue() {
            if (messageQueue.length === 0) return;
            
            showNotice(successNotice, `Se trimit ${messageQueue.length} mesaje din coada offline...`);
            
            const processNext = () => {
                if (messageQueue.length === 0) {
                    showNotice(successNotice, 'Toate mesajele au fost trimise cu succes.');
                    return;
                }
                
                const message = messageQueue.shift();
                
                // Send the message
                sendMessageToFirestore(message)
                    .then(() => {
                        // Update local storage
                        localStorage.setItem('messageQueue_' + currentChatId, JSON.stringify(messageQueue));
                        // Process next message
                        processNext();
                    })
                    .catch(error => {
                        console.error('Error processing queued message:', error);
                        // Put the message back in the queue
                        messageQueue.unshift(message);
                        localStorage.setItem('messageQueue_' + currentChatId, JSON.stringify(messageQueue));
                        // Stop processing for now
                        showNotice(errorNotice, 'Nu s-au putut trimite toate mesajele. Se va încerca din nou mai târziu.');
                    });
            };
            
            processNext();
        }
        
        // Load queued messages from localStorage
        function loadMessageQueue() {
            const queueStr = localStorage.getItem('messageQueue_' + currentChatId);
            if (queueStr) {
                try {
                    messageQueue = JSON.parse(queueStr);
                } catch (e) {
                    console.error('Error loading message queue:', e);
                    messageQueue = [];
                }
            } else {
                messageQueue = [];
            }
        }
        
        // =============================================
        // Initialization and Main Flow
        // =============================================
        
        // Initialize chat
        function initializeChat() {
            console.log('Initializing chat application...');
            
            // Set up connection monitoring
            setupConnectionMonitoring();
            
            // Generate a unique session key for this page load
            chatSessionKey = generateEncryptionKey();
            
            // Check if user is already logged in
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    console.log('User already logged in:', user.uid);
                }
            });
            
            // Set up event listeners
            setupEventListeners();
            
            // Set up PWA
            setupPwa();
        }
        
        // Set up all event listeners
        function setupEventListeners() {
            // Welcome screen
            btnStartWelcome.addEventListener('click', function() {
                welcomeScreen.style.display = 'none';
                emergencyCheck.style.display = 'flex';
            });
            
            // Emergency check
            btnEmergency.addEventListener('click', handleEmergency);
            btnNonemergency.addEventListener('click', showDepartmentSelection);
            
            // Department selection
            departmentItems.forEach(item => {
                item.addEventListener('click', function() {
                    selectDepartment(item.dataset.id);
                });
            });
            
            // Chat form
            btnStartChat.addEventListener('click', handleStartChat);
            
            // Chat functionality
            btnSendMessage.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', handleEnterPress);
            
            // Chat management
            btnCloseChat.addEventListener('click', confirmEndChat);
            btnRequestTranscript.addEventListener('click', requestTranscript);
            btnStartNewChat.addEventListener('click', resetChat);
            
            // Input typing detection
            messageInput.addEventListener('input', handleTypingStart);
            
            // PWA installation
            btnDismissPwa.addEventListener('click', () => {
                pwaBanner.classList.remove('show');
                localStorage.setItem('pwa_dismissed', Date.now());
            });
            
            btnInstallPwa.addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        } else {
                            console.log('User dismissed the install prompt');
                        }
                        deferredPrompt = null;
                        pwaBanner.classList.remove('show');
                    });
                }
            });
        }
        
        // =============================================
        // PWA Setup
        // =============================================
        
        function setupPwa() {
            // PWA installation
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent Chrome 67+ from automatically showing the prompt
                e.preventDefault();
                // Stash the event so it can be triggered later
                deferredPrompt = e;
                
                // Show the banner if not dismissed recently
                const lastDismissed = localStorage.getItem('pwa_dismissed');
                if (!lastDismissed || Date.now() - lastDismissed > 7 * 24 * 60 * 60 * 1000) { // 7 days
                    setTimeout(() => {
                        pwaBanner.classList.add('show');
                    }, 5000);
                }
            });
            
            // When the PWA is installed
            window.addEventListener('appinstalled', (evt) => {
                pwaBanner.classList.remove('show');
                console.log('App was installed');
            });
        }
        
        // =============================================
        // Chat Flow Functions
        // =============================================
        
        // Handle emergency button click
        function handleEmergency() {
            // Log the emergency (useful for statistics and monitoring)
            logEmergencyRequest();
            
            // For emergency, redirect to call page or show emergency info
            alert('Pentru situații de urgență, vă rugăm să sunați la 112. Vă redirecționăm către pagina de informații despre urgențe.');
            // In a real implementation, redirect to emergency page
            // window.location.href = '/urgenta';
        }
        
        // Log emergency request
        function logEmergencyRequest() {
            try {
                db.collection('emergency_logs').add({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userAgent: navigator.userAgent,
                    ipAddress: '', // This would be populated by a Cloud Function
                    location: '' // This would be populated by a Cloud Function if available
                });
            } catch (error) {
                console.error('Error logging emergency request:', error);
            }
        }
        
        // Show department selection
        function showDepartmentSelection() {
            emergencyCheck.style.display = 'none';
            departmentSelect.style.display = 'flex';
        }
        
        // Select department
        function selectDepartment(departmentId) {
            selectedDepartment = departmentId;
            departmentSelect.style.display = 'none';
            chatForm.style.display = 'flex';
            
            // Pre-fill subject based on department
            const subjectMap = {
                'traffic': 'Problemă de circulație rutieră',
                'public-order': 'Problemă de ordine publică',
                'environment': 'Problemă de mediu',
                'commerce': 'Problemă comercială',
                'general': 'Informații generale'
            };
            
            document.getElementById('chat-subject').value = subjectMap[departmentId] || '';
            
            // Update sidebar department info on desktop
            if (window.innerWidth >= 992) {
                updateSidebarDepartmentInfo(departmentId);
            }
        }
        
        // Update sidebar department info
        function updateSidebarDepartmentInfo(departmentId) {
            const deptInfo = departmentInfoMap[departmentId];
            if (deptInfo) {
                sidebarDepartmentInfo.style.display = 'block';
                sidebarDepartmentTitle.textContent = deptInfo.title;
                sidebarDepartmentContent.innerHTML = deptInfo.content;
            } else {
                sidebarDepartmentInfo.style.display = 'none';
            }
        }
        
        // Handle start chat button click
        function handleStartChat() {
            // Validate form
            const nameInput = document.getElementById('chat-name');
            const subjectInput = document.getElementById('chat-subject');
            const privacyCheck = document.getElementById('privacy-check');
            const recordingCheck = document.getElementById('recording-check');
            
            // Reset error notice
            formErrorNotice.style.display = 'none';
            
            // Check required fields
            if (!nameInput.value.trim() || !subjectInput.value.trim() || !privacyCheck.checked || !recordingCheck.checked) {
                formErrorNotice.style.display = 'block';
                return;
            }
            
            // Show loading state
            chatForm.style.display = 'none';
            loadingState.style.display = 'flex';
            loadingText.textContent = 'Se inițializează conexiunea securizată...';
            
            // Start authentication process
            authenticateAnonymously();
        }
        
        // Authenticate anonymously
        function authenticateAnonymously() {
            auth.signInAnonymously()
                .then(userCredential => {
                    currentUser = userCredential.user;
                    loadingText.textContent = 'Se creează sesiunea de chat...';
                    
                    // Get user info from form
                    const chatSubject = document.getElementById('chat-subject').value;
                    const chatName = document.getElementById('chat-name').value;
                    const chatEmail = document.getElementById('chat-email').value;
                    const chatPhone = document.getElementById('chat-phone').value;
                    
                    // Create chat session
                    return createChatSession(chatSubject, chatName, chatEmail, chatPhone);
                })
                .then(() => {
                    loadingText.textContent = 'Se conectează la departamentul relevant...';
                    return setupChatListeners();
                })
                .then(() => {
                    // Show chat interface
                    loadingState.style.display = 'none';
                    chatArea.style.display = 'flex';
                    
                    // Add welcome message
                    addSystemMessage('Conectat la Poliția Locală Slobozia. Un agent va răspunde în curând.');
                    
                    // Set up read receipts
                    setupReadReceipts();
                    
                    // Focus on input
                    messageInput.focus();
                })
                .catch(error => {
                    console.error('Error starting chat:', error);
                    loadingState.style.display = 'none';
                    chatForm.style.display = 'flex';
                    showNotice(errorNotice, 'Eroare la inițierea conversației. Vă rugăm să încercați din nou.');
                });
        }
        
        // Create a new chat session
        function createChatSession(subject, name, email, phone) {
            return new Promise((resolve, reject) => {
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                
                // Create chat document
                db.collection('chats').add({
                    userId: currentUser.uid,
                    userName: name,
                    userEmail: email || '',
                    userPhone: phone || '',
                    subject: subject,
                    department: selectedDepartment,
                    status: 'waiting',
                    priority: 'normal',
                    createdAt: timestamp,
                    updatedAt: timestamp,
                    agentId: null,
                    agentName: null,
                    conversationData: {
                        clientPlatform: navigator.platform,
                        clientBrowser: navigator.userAgent,
                        clientLanguage: navigator.language,
                        chatSource: 'web'
                    }
                }).then(docRef => {
                    currentChatId = docRef.id;
                    
                    // Store the encryption key in a separate collection for security
                    return db.collection('chatKeys').doc(currentChatId).set({
                        key: chatSessionKey,
                        createdAt: timestamp
                    });
                }).then(() => {
                    resolve();
                }).catch(error => {
                    reject(error);
                });
            });
        }
        
        // Set up chat listeners
        function setupChatListeners() {
            return new Promise((resolve, reject) => {
                try {
                    // Listen for chat status changes (e.g., agent joined, priority changed)
                    const chatDocListener = db.collection('chats').doc(currentChatId)
                        .onSnapshot(doc => {
                            if (!doc.exists) {
                                console.error('Chat document does not exist');
                                return;
                            }
                            
                            const chatData = doc.data();
                            
                            // Check if an agent was assigned
                            if (chatData.agentId && chatData.status === 'active' && !agentJoinedFlag) {
                                // An agent has joined - mark the flag so we don't trigger this again
                                agentJoinedFlag = true;
                                
                                // Store agent public key for encryption if available
                                agentPublicKey = chatData.agentPublicKey || null;
                            }
                            
                            // Check if chat was ended by the agent
                            if (chatData.status === 'closed' && !chatEnded) {
                                handleChatEnded();
                            }
                        }, error => {
                            console.error('Error in chat document listener:', error);
                        });
                    
                    // Listen for messages
                    const messagesListener = db.collection('chats').doc(currentChatId).collection('messages')
                        .orderBy('timestamp', 'asc')
                        .onSnapshot(snapshot => {
                            snapshot.docChanges().forEach(change => {
                                if (change.type === 'added') {
                                    const message = change.doc.data();
                                    // Add the message ID to the message object
                                    message.id = change.doc.id;
                                    
                                    // If the message has encrypted content, decrypt it
                                    if (message.encrypted && message.content) {
                                        message.content = decryptMessage(message.content, chatSessionKey);
                                    }
                                    
                                    // Check for duplicate message before displaying
                                    if (!document.querySelector(`[data-message-id="${message.id}"]`) && 
                                        !(message.type === 'system' && message.clientGeneratedId && 
                                          document.querySelector(`[data-message-id="${message.clientGeneratedId}"]`))) {
                                        
                                        displayMessage(message);
                                        
                                        // Update read status for agent messages
                                        if (message.type === 'agent') {
                                            updateMessageReadStatus(change.doc.id);
                                        }
                                    }
                                }
                            });
                            
                            // Scroll to bottom
                            scrollToBottom();
                        }, error => {
                            console.error('Error in messages listener:', error);
                        });
                    
                    // Listen for typing indicators
                    const typingListener = db.collection('chats').doc(currentChatId).collection('typing')
                        .doc('agent')
                        .onSnapshot(doc => {
                            if (doc.exists && doc.data().isTyping) {
                                showTypingIndicator();
                            } else {
                                hideTypingIndicator();
                            }
                        }, error => {
                            console.error('Error in typing indicator listener:', error);
                        });
                    
                    // Load queued messages if any
                    loadMessageQueue();
                    
                    // Store listeners for cleanup
                    window.chatListeners = {
                        chatDoc: chatDocListener,
                        messages: messagesListener,
                        typing: typingListener
                    };
                    
                    resolve();
                } catch (error) {
                    console.error('Error setting up chat listeners:', error);
                    reject(error);
                }
            });
        }
        
        // =============================================
        // Message Handling
        // =============================================
        
        // Send a message
        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || chatEnded) return;
            
            // Check rate limit
            if (!checkRateLimit()) {
                return;
            }
            
            // Disable input during send
            messageInput.disabled = true;
            btnSendMessage.disabled = true;
            
            // Record this message for rate limiting
            recordMessageSent();
            
            // Create the message object
            const messageObj = {
                type: 'user',
                content: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                sender: {
                    id: currentUser.uid,
                    name: document.getElementById('chat-name').value || 'Anonim'
                },
                status: 'sent'
            };
            
            // Encrypt message content if we have encryption set up
            if (chatSessionKey) {
                messageObj.content = encryptMessage(text, chatSessionKey);
                messageObj.encrypted = true;
            }
            
            // Try to send to Firestore
            sendMessageToFirestore(messageObj)
                .then(() => {
                    // Clear input and enable it again
                    messageInput.value = '';
                    messageInput.disabled = false;
                    btnSendMessage.disabled = false;
                    
                    // Reset typing indicator
                    resetTypingIndicator();
                    
                    // Focus input field
                    messageInput.focus();
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    
                    // Queue the message for later if we're offline
                    if (connectionStatus.textContent === 'Offline') {
                        queueMessage(messageObj);
                        
                        // Show a temporary version of the message
                        displayLocalMessage(messageObj);
                        
                        // Clear input
                        messageInput.value = '';
                    } else {
                        showNotice(errorNotice, 'Eroare la trimiterea mesajului. Vă rugăm să încercați din nou.');
                    }
                    
                    // Re-enable input
                    messageInput.disabled = false;
                    btnSendMessage.disabled = false;
                });
        }
        
        // Send a message to Firestore
        function sendMessageToFirestore(messageObj) {
            return new Promise((resolve, reject) => {
                // Add message to Firestore 
                db.collection('chats').doc(currentChatId).collection('messages').add(messageObj)
                    .then(messageRef => {
                        // Update the chat's last activity timestamp
                        return db.collection('chats').doc(currentChatId).update({
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastMessage: messageObj.encrypted ? "[Encrypted message]" : (messageObj.content || '[Mesaj gol]'),
                            lastMessageSender: 'user'
                        });
                    })
                    .then(() => {
                        resolve();
                    })
                    .catch(error => {
                        console.error('Error details:', error);
                        reject(error);
                    });
            });
        }
        
        // Handle Enter key press
        function handleEnterPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        // =============================================
        // Message Display Functions
        // =============================================
        
        // Display a message in the chat
        function displayMessage(message) {
            // Check if this message is already displayed (for offline message handling)
            const existingMessage = document.querySelector(`[data-message-id="${message.id}"]`);
            if (existingMessage) return;
            
            // Create message element
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            // Set message ID if available
            if (message.id) {
                messageElement.dataset.messageId = message.id;
            }
            
            // Format timestamp
            let timeString = 'Acum';
            if (message.timestamp) {
                const timestamp = message.timestamp.toDate ? message.timestamp.toDate() : new Date();
                timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // Handle different message types
            if (message.type === 'system') {
                // System message
                messageElement.className = 'message-system';
                messageElement.textContent = message.content;
            } else if (message.type === 'user') {
                // User message (sent by current user)
                messageElement.classList.add('message-sent');
                
                // Create HTML for the message
                let messageHtml = '';
                
                // Add text content
                if (message.content) {
                    messageHtml += `
                        <div class="message-content">
                            ${message.content}
                        </div>
                    `;
                }
                
                // Add metadata (time, status)
                let statusHtml = '';
                if (message.status === 'sent') {
                    statusHtml = `<i class="material-icons" aria-hidden="true">done</i>`;
                } else if (message.status === 'delivered') {
                    statusHtml = `<i class="material-icons" aria-hidden="true">done_all</i>`;
                } else if (message.status === 'read') {
                    statusHtml = `<i class="material-icons" style="color: var(--secondary-color);" aria-hidden="true">done_all</i>`;
                }
                
                messageHtml += `
                    <div class="message-meta">
                        <span class="message-time">${timeString}</span>
                        <span class="message-status">
                            ${statusHtml}
                        </span>
                    </div>
                `;
                
                messageElement.innerHTML = messageHtml;
            } else if (message.type === 'agent') {
                // Agent message
                messageElement.classList.add('message-received');
                
                // Hide typing indicator when receiving agent message
                hideTypingIndicator();
                
                // Create HTML for the message
                let messageHtml = '';
                
                // Add text content
                if (message.content) {
                    messageHtml += `
                        <div class="message-content">
                            ${message.content}
                        </div>
                    `;
                }
                
                // Add metadata (time)
                messageHtml += `
                    <div class="message-meta">
                        <span class="message-time">${timeString}</span>
                    </div>
                `;
                
                messageElement.innerHTML = messageHtml;
            }
            
            // Add to chat
            chatMessages.appendChild(messageElement);
            
            // Scroll to bottom
            scrollToBottom();
        }
        
        // Display a local message (for offline support)
        function displayLocalMessage(message) {
            // Clone the message object to avoid modifying the original
            const localMessage = { ...message };
            
            // Add a local ID
            localMessage.id = 'local-' + Date.now();
            
            // Add pending status indicator
            localMessage.status = 'pending';
            
            // Display with "pending" styling
            displayMessage(localMessage);
            
            // Update the message element to show it's queued
            const messageElement = document.querySelector(`[data-message-id="${localMessage.id}"]`);
            if (messageElement) {
                const statusSpan = messageElement.querySelector('.message-status');
                if (statusSpan) {
                    statusSpan.innerHTML = '<i class="material-icons" style="color: var(--warning-color);">schedule</i>';
                }
            }
        }
        
        // Add a system message
        function addSystemMessage(text) {
            // Create a temporary ID to prevent duplication
            const tempId = 'local-system-' + Date.now();
            
            // First add to UI immediately with the temp ID
            const systemMessage = {
                type: 'system',
                content: text,
                timestamp: new Date(),
                id: tempId // Temporary ID to prevent duplication
            };
            
            displayMessage(systemMessage);
            
            // Then add to Firestore, but don't display it again when it comes back
            db.collection('chats').doc(currentChatId).collection('messages').add({
                type: 'system',
                content: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                clientGeneratedId: tempId // Track that this was generated by the client
            }).catch(error => {
                console.error('Error adding system message:', error);
            });
        }
        
        // Scroll chat to bottom
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 50);
        }
        
        // =============================================
        // Typing Indicators
        // =============================================
        
        // Handle user typing start
        function handleTypingStart() {
            if (!isTyping) {
                isTyping = true;
                
                // Notify the server that the user is typing
                db.collection('chats').doc(currentChatId).collection('typing')
                    .doc('user')
                    .set({
                        isTyping: true,
                        userId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(error => {
                        console.error('Error updating typing status:', error);
                    });
            }
            
            // Reset the typing timeout
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            typingTimeout = setTimeout(resetTypingIndicator, 3000);
        }
        
        // Reset typing indicator
        function resetTypingIndicator() {
            if (isTyping) {
                isTyping = false;
                
                // Notify the server that the user stopped typing
                db.collection('chats').doc(currentChatId).collection('typing')
                    .doc('user')
                    .set({
                        isTyping: false,
                        userId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(error => {
                        console.error('Error updating typing status:', error);
                    });
            }
            
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                typingTimeout = null;
            }
        }
        
        // Show agent typing indicator
        function showTypingIndicator() {
            // Check if typing indicator already exists
            let typingIndicator = document.querySelector('.typing-indicator');
            
            if (!typingIndicator) {
                typingIndicator = document.createElement('div');
                typingIndicator.className = 'typing-indicator';
                typingIndicator.setAttribute('aria-label', 'Agentul scrie un mesaj');
                
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('span');
                    dot.className = 'typing-dot';
