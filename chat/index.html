<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Chat online cu Poliția Locală Slobozia pentru raportarea problemelor non-urgente">
    <meta name="theme-color" content="#1A2F5F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Chat - Poliția Locală Slobozia</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="https://images4.imagebam.com/d3/36/5c/ME11M3EE_o.png">
    
    <!-- Firebase SDK - Optimized version -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-functions-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Reset & Base Styles */
        :root {
            --primary-color: #1A2F5F;
            --primary-dark: #0F1B38;
            --primary-light: rgba(26, 47, 95, 0.05);
            --primary-gradient: linear-gradient(135deg, #1A2F5F 0%, #253F78 100%);
            --secondary-color: #1E88E5;
            --secondary-light: rgba(30, 136, 229, 0.2);
            --secondary-dark: #1565C0;
            --secondary-gradient: linear-gradient(135deg, #1E88E5 0%, #1976D2 100%);
            --accent-color: #FFCA28;
            --accent-dark: #FFC107;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-light: #FFFFFF;
            --background-light: #F5F7FA;
            --background-dark: #172B4D;
            --background-gradient: linear-gradient(to bottom, #F5F7FA 0%, #EAEEF5 100%);
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --border-radius-small: 12px;
            --border-radius-medium: 16px;
            --border-radius-large: 22px;
            --shadow-small: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 6px 20px rgba(0, 0, 0, 0.15);
            --shadow-large: 0 10px 30px rgba(0, 0, 0, 0.2);
            --shadow-float: 0 10px 24px rgba(26, 47, 95, 0.08), 0 2px 8px rgba(26, 47, 95, 0.1);
            --shadow-card: 0 4px 20px rgba(26, 47, 95, 0.08), 0 2px 6px rgba(26, 47, 95, 0.04), 0 0 1px rgba(26, 47, 95, 0.12);
            --transition-fast: all 0.3s ease;
            --transition-medium: all 0.5s ease;
            --font-size-base: 16px;
            --font-size-large: 18px;
            --font-size-xl: 20px;
            --font-size-xxl: 24px;
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: auto;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            font-size: var(--font-size-base);
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--background-light);
            background-image: url('https://images4.imagebam.com/e7/9c/be/ME11NTZI_o.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: -1;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            margin-bottom: var(--spacing-md);
        }
        
        a:focus, button:focus, input:focus, select:focus, textarea:focus {
            outline: 3px solid var(--secondary-light);
            outline-offset: 2px;
        }
        
        button, input, textarea {
            font-family: inherit;
            font-size: inherit;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* App Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            overflow: hidden;
            background-color: white;
            box-shadow: var(--shadow-card);
        }
        
        /* Header */
        .app-header {
            background-image: var(--primary-gradient);
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-medium);
            z-index: 10;
            height: 70px;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }
        
        .header-logo {
            width: 40px;
            height: 40px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--spacing-sm);
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: var(--transition-fast);
        }
        
        .header-logo:hover {
            transform: scale(1.05);
        }
        
        .header-logo img {
            width: 32px;
            height: 32px;
        }
        
        .header-title {
            font-size: var(--font-size-large);
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        
        .header-status {
            font-size: calc(var(--font-size-base) - 2px);
            opacity: 0.9;
            margin-top: -2px;
            display: flex;
            align-items: center;
        }
        
        .header-status::before {
            content: "";
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--success-color);
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .header-actions {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .header-actions a {
            text-decoration: none;
            color: white;
        }
        
        .header-actions button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: var(--font-size-xl);
            cursor: pointer;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-fast);
        }
        
        .header-button-with-text {
            min-width: 36px;
            height: 36px;
        }
        
        .header-button-with-text span {
            display: none;
        }
        
        .header-actions button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        /* Main Content Area */
        .app-content {
            flex: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Notifications Container */
        .notifications-container {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            pointer-events: none;
        }

        /* Notice Styling */
        .notice {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-small);
            font-size: 14px;
            box-shadow: var(--shadow-medium);
            animation: slideDown 0.3s ease-out;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .notice i {
            font-size: 20px;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .error-notice {
            background-color: var(--danger-color);
            color: white;
        }
        
        .success-notice {
            background-color: var(--success-color);
            color: white;
        }

        .warning-notice {
            background-color: var(--warning-color);
            color: white;
        }

        .info-notice {
            background-color: var(--secondary-color);
            color: white;
        }
        
        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--spacing-lg) var(--spacing-lg);
            height: 100%;
            background: linear-gradient(to bottom, rgba(26, 47, 95, 0.92) 0%, rgba(26, 47, 95, 0.85) 100%), url('https://images4.imagebam.com/c0/05/ef/ME11M3FT_o.png');
            background-size: cover;
            background-position: center;
            color: var(--text-light);
        }
        
        .welcome-title {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: var(--spacing-md);
            letter-spacing: 0.5px;
        }
        
        .welcome-description {
            font-size: var(--font-size-base);
            margin-bottom: var(--spacing-lg);
            max-width: 600px;
            line-height: 1.7;
        }
        
        .welcome-logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--spacing-lg);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
        }
        
        .welcome-logo img {
            width: 60px;
            height: 60px;
        }
        
        /* Account Registration Screen */
        .account-registration {
            padding: var(--spacing-lg) var(--spacing-lg);
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            background-color: white;
        }
        
        .registration-title {
            font-size: var(--font-size-xl);
            color: var(--primary-color);
            margin-bottom: var(--spacing-md);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }
        
        .registration-description {
            font-size: var(--font-size-base);
            margin-bottom: var(--spacing-lg);
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.7;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--background-light);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            position: relative;
        }

        .step.active {
            background-color: var(--secondary-color);
            color: white;
        }

        .step.completed {
            background-color: var(--success-color);
            color: white;
        }

        .step-line {
            width: 50px;
            height: 2px;
            background-color: var(--background-light);
            margin: 0 var(--spacing-xs);
        }

        .step-line.completed {
            background-color: var(--success-color);
        }
        
        .registration-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .form-group {
            position: relative;
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
            color: var(--text-primary);
            font-size: var(--font-size-base);
        }
        
        .form-control {
            width: 100%;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-small);
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-color: var(--background-light);
            transition: var(--transition-fast);
            font-size: var(--font-size-base);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1), inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .phone-input-group {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            border: 2px solid var(--background-light);
            border-radius: var(--border-radius-medium);
            overflow: hidden;
            transition: var(--transition-fast);
        }

        .phone-input-group:focus-within {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px var(--secondary-light);
        }
        
        .phone-prefix {
            background-color: var(--background-light);
            padding: var(--spacing-sm) var(--spacing-md);
            border-right: 2px solid var(--background-light);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .phone-input-group input {
            flex: 1;
            border: none;
            padding: var(--spacing-md) var(--spacing-md);
            font-size: var(--font-size-large);
            outline: none;
            background: transparent;
        }
        
        .verification-code-section {
            margin-top: var(--spacing-xl);
        }
        
        .code-input-group {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            justify-content: center;
        }
        
        .code-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: var(--font-size-xl);
            border: 2px solid var(--background-light);
            border-radius: var(--border-radius-small);
            transition: var(--transition-fast);
            font-weight: 600;
        }
        
        .code-input:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px var(--secondary-light);
        }

        .code-input.filled {
            border-color: var(--success-color);
            background-color: rgba(76, 175, 80, 0.05);
        }
        
        .retry-message {
            text-align: center;
            color: var(--text-secondary);
            margin-top: var(--spacing-md);
            font-size: 14px;
        }
        
        .retry-timer {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .form-check {
            display: flex;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
            min-height: 36px;
        }
        
        .form-check-input {
            margin-right: var(--spacing-sm);
            margin-top: 4px;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .form-check-label {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            flex: 1;
        }
        
        .form-check-label a {
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 500;
        }
        
        .form-check-label a:hover {
            text-decoration: underline;
        }

        /* Emergency Check */
        .emergency-check {
            padding: var(--spacing-lg) var(--spacing-lg) var(--spacing-lg);
            background-color: white;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-width: 700px;
            margin: 0 auto;
            width: 100%;
        }
        
        .emergency-title {
            font-size: var(--font-size-xl);
            color: var(--danger-color);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .emergency-title i {
            margin-right: var(--spacing-sm);
        }
        
        .emergency-text {
            font-size: var(--font-size-base);
            margin-bottom: var(--spacing-lg);
            color: var(--text-primary);
            line-height: 1.7;
            text-align: center;
        }
        
        .emergency-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            align-items: center;
        }
        
        /* Department Selection */
        .department-select {
            padding: var(--spacing-md) var(--spacing-lg);
            height: 100%;
            overflow-y: auto;
            display: none;
            flex-direction: column;
            background-color: white;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }
        
        .department-title {
            font-size: var(--font-size-large);
            margin-bottom: var(--spacing-lg);
            text-align: center;
            color: var(--primary-color);
        }
        
        .department-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .department-item {
            padding: var(--spacing-md);
            border-radius: var(--border-radius-medium);
            background-color: var(--background-light);
            box-shadow: var(--shadow-small);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .department-item:active {
            transform: scale(0.98);
        }
        
        .department-item:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-3px);
            background-color: white;
        }
        
        .department-icon {
            width: 56px;
            height: 56px;
            background-color: var(--secondary-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--spacing-sm);
            color: var(--secondary-color);
            flex-shrink: 0;
            transition: var(--transition-fast);
        }
        
        .department-item:hover .department-icon {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .department-icon i {
            font-size: 28px;
        }
        
        .department-info {
            flex: 1;
        }
        
        .department-name {
            font-weight: 600;
            font-size: var(--font-size-base);
            margin-bottom: 4px;
        }
        
        .department-description {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* Chat Area */
        .chat-area {
            height: 100%;
            display: flex;
            flex-direction: column;
            display: none;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--background-light);
            display: flex;
            flex-direction: column;
            -webkit-overflow-scrolling: touch;
        }
        
        .message {
            margin-bottom: var(--spacing-sm);
            max-width: 85%;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-received {
            align-self: flex-start;
        }
        
        .message-sent {
            align-self: flex-end;
        }
        
        .message-content {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-medium);
            position: relative;
            font-size: var(--font-size-base);
            box-shadow: var(--shadow-small);
            line-height: 1.6;
            transition: transform 0.2s ease;
        }
        
        .message-received .message-content {
            background-color: white;
            border-bottom-left-radius: 4px;
        }
        
        .message-sent .message-content {
            background-image: var(--secondary-gradient);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-content:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .message-meta {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin-top: 2px;
            padding: 0 var(--spacing-xs);
        }
        
        .message-time {
            color: var(--text-secondary);
        }
        
        .message-status {
            color: var(--text-secondary);
            display: flex;
            align-items: center;
        }
        
        .message-status i {
            font-size: 12px;
            margin-left: 4px;
        }
        
        .message-system {
            align-self: center;
            max-width: 90%;
            background-color: rgba(0,0,0,0.05);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-small);
            margin-bottom: var(--spacing-sm);
            text-align: center;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .chat-input {
            padding: var(--spacing-xs) var(--spacing-sm);
            background-color: white;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .chat-input-field {
            flex: 1;
            padding: var(--spacing-sm);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 28px;
            background-color: var(--background-light);
            transition: var(--transition-fast);
            font-size: var(--font-size-base);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            min-height: 46px;
            resize: none;
        }
        
        .chat-input-field:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1), inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .chat-actions {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .chat-action {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--secondary-light);
            color: var(--secondary-color);
            border: none;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .chat-action:hover, .chat-action:active {
            background-color: var(--secondary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-small);
        }
        
        .chat-action i {
            font-size: 22px;
        }
        
        .chat-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .chat-action-send {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .chat-action-send:hover {
            background-color: var(--secondary-dark);
        }
        
        /* Chat End */
        .chat-end {
            padding: var(--spacing-lg);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
        }
        
        .chat-end-icon {
            font-size: 48px;
            color: var(--success-color);
            margin-bottom: var(--spacing-sm);
            animation: scaleIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes scaleIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .chat-end-title {
            font-size: var(--font-size-xl);
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
        }
        
        .chat-end-text {
            margin-bottom: var(--spacing-lg);
            color: var(--text-secondary);
            font-size: var(--font-size-base);
            max-width: 600px;
        }
        
        /* Loading State */
        .loading-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            gap: var(--spacing-md);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Typing Animation */
        @keyframes typingAnimation {
            0% { opacity: 0.3; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-2px); }
            100% { opacity: 0.3; transform: translateY(0); }
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            margin: 8px 0;
            align-self: flex-start;
            background: white;
            padding: 10px 14px;
            border-radius: var(--border-radius-medium);
            box-shadow: var(--shadow-small);
        }
        
        .typing-dot {
            height: 8px;
            width: 8px;
            margin: 0 2px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            display: inline-block;
            animation: typingAnimation 1.5s infinite;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-medium);
            font-weight: 600;
            text-decoration: none;
            transition: var(--transition-fast);
            font-size: var(--font-size-base);
            border: none;
            cursor: pointer;
            min-height: 48px;
            width: 100%;
            max-width: 280px;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .btn:hover::after {
            transform: translateY(0);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background-image: var(--secondary-gradient);
            color: white;
            box-shadow: var(--shadow-small);
        }
        
        .btn-primary:hover, .btn-primary:focus {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: var(--background-light);
            color: var(--text-primary);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary:hover, .btn-secondary:focus {
            background-color: #e9e9e9;
            transform: translateY(-2px);
            box-shadow: var(--shadow-small);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
            box-shadow: var(--shadow-small);
        }
        
        .btn-danger:hover, .btn-danger:focus {
            background-color: #d32f2f;
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
            box-shadow: var(--shadow-small);
        }
        
        .btn-success:hover, .btn-success:focus {
            background-color: #43a047;
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }
        
        .btn i {
            margin-right: var(--spacing-sm);
            font-size: 22px;
        }

        .btn.loading {
            pointer-events: none;
            opacity: 0.8;
        }

        .btn.loading i {
            animation: spin 1s linear infinite;
        }
        
        /* Welcome Screen Button */
        .welcome-btn {
            max-width: 250px;
            margin-top: var(--spacing-md);
        }
        
        /* Center the start chat button */
        #btnStartChat {
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Form Submit Button */
        .form-submit-btn {
            margin-top: 24px;
            display: flex;
            justify-content: center;
        }
        
        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            .message,
            .btn:hover,
            .department-item:hover,
            .loading-spinner,
            .typing-dot {
                animation: none !important;
                transition: none !important;
                transform: none !important;
            }
        }
        
        /* High contrast mode */
        @media (forced-colors: active) {
            .btn,
            .chat-action,
            .form-control,
            .message-content {
                border: 1px solid currentColor;
            }
        }
        
        /* Desktop Specific Styles */
        @media (min-width: 768px) {
            body {
                background-color: transparent;
                padding: 20px;
                overflow: auto;
                position: static;
            }
            
            .app-container {
                width: 90%;
                max-width: 1200px;
                height: calc(100vh - 40px);
                margin: 0 auto;
                border-radius: var(--border-radius-large);
                box-shadow: var(--shadow-large);
                overflow: hidden;
                transition: all 0.3s ease;
            }
            
            .app-header {
                height: 80px;
                padding: var(--spacing-md) var(--spacing-lg);
            }
            
            .header-logo {
                width: 48px;
                height: 48px;
                margin-right: var(--spacing-md);
            }
            
            .header-logo img {
                width: 36px;
                height: 36px;
            }
            
            .header-title {
                font-size: var(--font-size-xl);
            }
            
            .header-status {
                font-size: calc(var(--font-size-base) - 1px);
            }
            
            .header-button-with-text {
                min-width: 42px;
                height: 42px;
            }
            
            .header-button-with-text span {
                display: inline-block;
                margin-left: 6px;
                font-size: 14px;
                font-weight: 500;
            }
            
            .chat-messages {
                padding: var(--spacing-lg) var(--spacing-xl);
            }
            
            .message {
                max-width: 65%;
                margin-bottom: var(--spacing-md);
            }
            
            .message-content {
                padding: var(--spacing-md) var(--spacing-lg);
                font-size: var(--font-size-large);
            }
            
            .message-meta {
                font-size: 12px;
                margin-top: 4px;
            }
            
            .message-status i {
                font-size: 14px;
            }
            
            .message-system {
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: 14px;
                margin-bottom: var(--spacing-md);
            }
            
            .chat-input {
                padding: var(--spacing-md) var(--spacing-xl);
            }
            
            .chat-input-field {
                min-height: 60px;
                font-size: var(--font-size-large);
                padding: var(--spacing-md) var(--spacing-lg);
            }
            
            .chat-action {
                width: 54px;
                height: 54px;
            }
            
            .chat-action i {
                font-size: 24px;
            }
            
            .emergency-buttons {
                flex-direction: row;
                justify-content: center;
                gap: var(--spacing-lg);
            }
            
            .btn {
                width: auto;
                padding: var(--spacing-md) var(--spacing-xl);
                font-size: var(--font-size-large);
                min-height: 56px;
                max-width: 400px;
            }
            
            .btn i {
                font-size: 24px;
            }
            
            .welcome-screen {
                padding: var(--spacing-xl) var(--spacing-xl) var(--spacing-xl);
            }
            
            .welcome-title {
                font-size: 36px;
                margin-bottom: var(--spacing-lg);
            }
            
            .welcome-description {
                font-size: 20px;
                margin-bottom: var(--spacing-xl);
                max-width: 700px;
            }
            
            .welcome-logo {
                width: 100px;
                height: 100px;
                margin-bottom: var(--spacing-xl);
            }
            
            .welcome-logo img {
                width: 76px;
                height: 76px;
            }
            
            .welcome-btn {
                max-width: 280px;
            }
            
            .department-list {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                gap: var(--spacing-lg);
            }
            
            .department-item {
                height: 100%;
                padding: var(--spacing-lg);
            }
            
            .department-icon {
                width: 64px;
                height: 64px;
                margin-right: var(--spacing-md);
            }
            
            .department-icon i {
                font-size: 32px;
            }
            
            .department-name {
                font-size: var(--font-size-large);
            }
            
            .department-description {
                font-size: inherit;
            }
            
            .department-title {
                font-size: var(--font-size-xl);
                margin-bottom: var(--spacing-xl);
            }
            
            .department-select {
                padding: var(--spacing-lg) var(--spacing-xl);
            }
            
            .form-title {
                font-size: var(--font-size-xl);
                margin-bottom: var(--spacing-lg);
            }
            
            .form-control {
                padding: var(--spacing-md);
                font-size: var(--font-size-large);
            }
            
            .form-check-label {
                font-size: var(--font-size-base);
            }
            
            .chat-form {
                padding: var(--spacing-xl);
            }
            
            .form-group {
                margin-bottom: var(--spacing-lg);
            }
            
            .emergency-title {
                font-size: var(--font-size-xxl);
                margin-bottom: var(--spacing-lg);
            }
            
            .emergency-text {
                font-size: var(--font-size-large);
                margin-bottom: var(--spacing-xl);
            }
            
            .emergency-check {
                padding: var(--spacing-xl) var(--spacing-xl) var(--spacing-xl);
            }
            
            .chat-end {
                padding: var(--spacing-xl);
            }
            
            .chat-end-icon {
                font-size: 56px;
                margin-bottom: var(--spacing-md);
            }
            
            .chat-end-title {
                font-size: var(--font-size-xxl);
                margin-bottom: var(--spacing-md);
            }
            
            .chat-end-text {
                font-size: var(--font-size-large);
                margin-bottom: var(--spacing-xl);
            }
            
            .loading-spinner {
                width: 60px;
                height: 60px;
                border-width: 4px;
            }
            
            .loading-container {
                gap: var(--spacing-lg);
            }
            
            .notice {
                padding: var(--spacing-md);
                margin-bottom: var(--spacing-md);
                font-size: var(--font-size-base);
            }
            
            .typing-indicator {
                margin: 10px 0;
                padding: 12px 16px;
            }
            
            .typing-dot {
                height: 10px;
                width: 10px;
            }
            
            .department-item:hover .department-name {
                color: var(--secondary-color);
            }
            
            .header-logo:hover {
                transform: scale(1.05);
            }
            
            .chat-action:hover {
                transform: translateY(-3px);
            }
            
            .btn-primary:hover, .btn-success:hover, .btn-danger:hover, .btn-secondary:hover {
                transform: translateY(-3px);
            }
        }
        
        /* Large Desktop */
        @media (min-width: 1400px) {
            .app-container {
                max-width: 1400px;
            }
            
            .chat-messages {
                padding: var(--spacing-xl) var(--spacing-xl);
            }
            
            .message {
                max-width: 60%;
            }
            
            .welcome-title {
                font-size: 42px;
            }
            
            .welcome-description {
                font-size: 22px;
                max-width: 800px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- App Header -->
        <header class="app-header">
            <div class="header-left">
                <div class="header-logo">
                    <img src="https://images4.imagebam.com/d3/36/5c/ME11M3EE_o.png" alt="Logo Poliția Locală">
                </div>
                <div>
                    <div class="header-title">Poliția Locală Slobozia</div>
                    <div class="header-status">
                        <span id="connectionStatus">Online</span> • 
                        <span id="securityStatus">Chat Securizat</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <a href="/" aria-label="Pagina principală">
                    <button id="btnHome" aria-label="Pagina principală" class="header-button-with-text">
                        <i class="material-icons">home</i>
                        <span>Acasă</span>
                    </button>
                </a>
                <button id="btnCloseChat" aria-label="Închide chat" class="header-button-with-text">
                    <i class="material-icons">close</i>
                    <span>Închide</span>
                </button>
            </div>
        </header>
        
        <!-- Main App Content -->
        <main class="app-content">
            <!-- Notifications Container -->
            <div class="notifications-container" id="notificationsContainer"></div>
            
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="welcome-screen">
                <div class="welcome-logo">
                    <img src="https://images4.imagebam.com/16/bf/9a/ME11NRG3_o.png" alt="Logo Poliția Locală">
                </div>
                <h1 class="welcome-title">Chat Online cu Poliția Locală</h1>
                <p class="welcome-description">Raportați probleme non-urgente și primiți asistență în timp real de la agenții Poliției Locale Slobozia.</p>
                <button id="btnStartWelcome" class="btn btn-primary welcome-btn">
                    <i class="material-icons">message</i> Începe Chat
                </button>
            </div>
            
            <!-- Account Registration Screen -->
            <div id="accountRegistration" class="account-registration" style="display:none;">
                <div class="step-indicator">
                    <div class="step active" id="step1">1</div>
                    <div class="step-line" id="stepLine1"></div>
                    <div class="step" id="step2">2</div>
                    <div class="step-line" id="stepLine2"></div>
                    <div class="step" id="step3">3</div>
                </div>

                <h2 class="registration-title">
                    <i class="material-icons">person_add</i>
                    Înregistrare Cont
                </h2>
                <p class="registration-description">Pentru a utiliza serviciul de chat, vă rugăm să vă creați un cont. Avem nevoie de datele dumneavoastră reale pentru a asigura securitatea și pentru a putea da curs sesizărilor.</p>
                
                <!-- Step 1: Personal Information -->
                <div id="registrationStep1" class="registration-form">
                    <div class="form-group">
                        <label class="form-label" for="firstName">Prenume: *</label>
                        <input type="text" id="firstName" class="form-control" placeholder="Ex: Ion" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="lastName">Nume: *</label>
                        <input type="text" id="lastName" class="form-control" placeholder="Ex: Popescu" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="email">Email: *</label>
                        <input type="email" id="email" class="form-control" placeholder="Ex: ion.popescu@email.com" required>
                    </div>
                    
                    <button id="btnNextStep1" class="btn btn-primary">
                        <i class="material-icons">arrow_forward</i> Continuă
                    </button>
                </div>
                
                <!-- Step 2: Phone Verification -->
                <div id="registrationStep2" class="registration-form" style="display:none;">
                    <div class="phone-input-group">
                        <span class="phone-prefix">+40</span>
                        <input type="tel" id="phoneNumber" class="form-control" placeholder="7XX XXX XXX" maxlength="9" pattern="[0-9]*" inputmode="numeric" autocomplete="tel">
                    </div>
                    
                    <button id="btnSendCode" class="btn btn-primary">
                        <i class="material-icons">sms</i> Trimite Cod SMS
                    </button>
                    
                    <div id="verificationSection" class="verification-code-section" style="display:none;">
                        <p class="registration-description">Introduceți codul de 6 cifre primit prin SMS:</p>
                        <div class="code-input-group">
                            <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                            <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                            <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                            <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                            <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                            <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
                        </div>
                        <button id="btnVerifyCode" class="btn btn-primary" disabled>
                            <i class="material-icons">check</i> Verifică Cod
                        </button>
                        <div class="retry-message" id="retryMessage" style="display:none;">
                            Puteți solicita un nou cod în <span class="retry-timer" id="retryTimer">60</span> secunde.
                        </div>
                    </div>
                    
                    <div id="recaptcha-container"></div>
                </div>
                
                <!-- Step 3: Terms and Conditions -->
                <div id="registrationStep3" class="registration-form" style="display:none;">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="terms-check" required>
                        <label class="form-check-label" for="terms-check">Accept <a href="/terms" target="_blank">termenii și condițiile</a> *</label>
                    </div>
                    
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="privacy-check" required>
                        <label class="form-check-label" for="privacy-check">Accept <a href="/privacy-policy" target="_blank">politica de confidențialitate</a> *</label>
                    </div>
                    
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="recording-check" required>
                        <label class="form-check-label" for="recording-check">Înțeleg că conversația este înregistrată *</label>
                    </div>
                    
                    <button id="btnCompleteRegistration" class="btn btn-primary">
                        <i class="material-icons">check_circle</i> Finalizează Înregistrarea
                    </button>
                </div>
            </div>
            
            <!-- Emergency Check -->
            <div id="emergencyCheck" class="emergency-check" style="display:none;">
                <h2 class="emergency-title">
                    <i class="material-icons">warning</i>Verificare Urgență
                </h2>
                <p class="emergency-text">Această platformă este destinată exclusiv situațiilor non-urgente. În caz de urgență, apelați imediat 112.</p>
                <p class="emergency-text"><strong>Aveți o urgență care necesită intervenție imediată?</strong></p>
                <div class="emergency-buttons">
                    <button id="btnEmergency" class="btn btn-danger">
                        <i class="material-icons">call</i> Da, sun la 112
                    </button>
                    <button id="btnNonemergency" class="btn btn-success">
                        <i class="material-icons">check_circle</i> Nu, continuă
                    </button>
                </div>
            </div>
            
            <!-- Department Selection -->
            <div id="departmentSelect" class="department-select">
                <h2 class="department-title">Selectați departamentul</h2>
                
                <div class="department-list">
                    <div class="department-item" data-id="traffic">
                        <div class="department-icon">
                            <i class="material-icons">directions_car</i>
                        </div>
                        <div class="department-info">
                            <div class="department-name">Circulație Rutieră</div>
                            <div class="department-description">Parcări neregulamentare, blocări acces, accidente ușoare</div>
                        </div>
                    </div>
                    
                    <div class="department-item" data-id="public-order">
                        <div class="department-icon">
                            <i class="material-icons">public</i>
                        </div>
                        <div class="department-info">
                            <div class="department-name">Ordine Publică</div>
                            <div class="department-description">Tulburarea liniștii publice, scandal, cerșetorie</div>
                        </div>
                    </div>
                    
                    <div class="department-item" data-id="environment">
                        <div class="department-icon">
                            <i class="material-icons">nature</i>
                        </div>
                        <div class="department-info">
                            <div class="department-name">Mediu</div>
                            <div class="department-description">Depozitare ilegală deșeuri, poluare, câini fără stăpân</div>
                        </div>
                    </div>
                    
                    <div class="department-item" data-id="commerce">
                        <div class="department-icon">
                            <i class="material-icons">store</i>
                        </div>
                        <div class="department-info">
                            <div class="department-name">Control Comercial</div>
                            <div class="department-description">Comerț stradal neautorizat, probleme magazine</div>
                        </div>
                    </div>
                    
                    <div class="department-item" data-id="general">
                        <div class="department-icon">
                            <i class="material-icons">help_outline</i>
                        </div>
                        <div class="department-info">
                            <div class="department-name">Altele</div>
                            <div class="department-description">Alte situații sau nu știu exact unde să raportez</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="loadingState" class="loading-container">
                <div class="loading-spinner"></div>
                <p id="loadingText">Se conectează...</p>
            </div>
            
            <!-- Chat Area -->
            <div id="chatArea" class="chat-area">
                <div id="chatMessages" class="chat-messages"></div>
                
                <div id="chatInput" class="chat-input">
                    <input type="text" class="chat-input-field" id="messageInput" placeholder="Scrieți mesajul..." aria-label="Scrieți mesajul">
                    <div class="chat-actions">
                        <button id="btnSendMessage" class="chat-action chat-action-send" aria-label="Trimite mesaj">
                            <i class="material-icons">send</i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Chat End Screen -->
            <div id="chatEnd" class="chat-end">
                <i class="material-icons chat-end-icon">check_circle</i>
                <h2 class="chat-end-title">Conversație încheiată</h2>
                <p class="chat-end-text">Vă mulțumim că ați contactat Poliția Locală Slobozia. Sesizarea dumneavoastră a fost înregistrată.</p>
                <button id="btnRequestTranscript" class="btn btn-secondary">
                    <i class="material-icons">description</i> Primește transcript
                </button>
                <button id="btnStartNewChat" class="btn btn-primary" style="margin-top: var(--spacing-md);">
                    <i class="material-icons">chat</i> Conversație nouă
                </button>
            </div>
        </main>
    </div>
    
    <!-- Firebase configuration -->
    <script src="../chat/js/firebase-config.js"></script>
    
    <script>
        // =============================================
        // Firebase Services
        // =============================================
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();
        const realtimeDb = firebase.database();
        
        // =============================================
        // DOM Elements
        // =============================================
        // Screens
        const welcomeScreen = document.getElementById('welcomeScreen');
        const accountRegistration = document.getElementById('accountRegistration');
        const emergencyCheck = document.getElementById('emergencyCheck');
        const departmentSelect = document.getElementById('departmentSelect');
        const loadingState = document.getElementById('loadingState');
        const chatArea = document.getElementById('chatArea');
        const chatEnd = document.getElementById('chatEnd');
        
        // Registration steps
        const registrationStep1 = document.getElementById('registrationStep1');
        const registrationStep2 = document.getElementById('registrationStep2');
        const registrationStep3 = document.getElementById('registrationStep3');
        
        // Registration form elements
        const firstNameInput = document.getElementById('firstName');
        const lastNameInput = document.getElementById('lastName');
        const emailInput = document.getElementById('email');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const termsCheck = document.getElementById('terms-check');
        const privacyCheck = document.getElementById('privacy-check');
        const recordingCheck = document.getElementById('recording-check');
        
        // Phone verification elements
        const btnSendCode = document.getElementById('btnSendCode');
        const verificationSection = document.getElementById('verificationSection');
        const btnVerifyCode = document.getElementById('btnVerifyCode');
        const retryMessage = document.getElementById('retryMessage');
        const retryTimer = document.getElementById('retryTimer');
        const codeInputs = document.querySelectorAll('.code-input');
        
        // Registration buttons
        const btnNextStep1 = document.getElementById('btnNextStep1');
        const btnCompleteRegistration = document.getElementById('btnCompleteRegistration');
        
        // Notifications
        const notificationsContainer = document.getElementById('notificationsContainer');
        
        // Chat Elements
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const messageInput = document.getElementById('messageInput');
        
        // Buttons
        const btnStartWelcome = document.getElementById('btnStartWelcome');
        const btnEmergency = document.getElementById('btnEmergency');
        const btnNonemergency = document.getElementById('btnNonemergency');
        const btnSendMessage = document.getElementById('btnSendMessage');
        const btnCloseChat = document.getElementById('btnCloseChat');
        const btnRequestTranscript = document.getElementById('btnRequestTranscript');
        const btnStartNewChat = document.getElementById('btnStartNewChat');
        
        // Department selection
        const departmentItems = document.querySelectorAll('.department-item');
        
        // Other elements
        const connectionStatus = document.getElementById('connectionStatus');
        const securityStatus = document.getElementById('securityStatus');
        const loadingText = document.getElementById('loadingText');
        
        // =============================================
        // State Variables
        // =============================================
        let currentUser = null;
        let currentChatId = null;
        let selectedDepartment = null;
        let chatSessionKey = null;
        let agentPublicKey = null;
        let chatEnded = false;
        let isTyping = false;
        let typingTimeout = null;
        let lastReadTimestamp = null;
        let unreadCount = 0;
        let offlineTimeout = null;
        let messageQueue = [];
        let agentJoinedFlag = false;
        let deviceFingerprint = null;
        let verificationId = null;
        let retryCountdown = null;
        let retryTimeLeft = 60;
        
        // Registration data
        let registrationData = {
            firstName: '',
            lastName: '',
            email: '',
            phone: ''
        };
        
        // Rate limiting
        const rateLimitConfig = {
            maxMessages: 20,
            timeWindow: 60000,
            sentMessages: [],
            isLimited: false
        };
        
        // Phone verification rate limiting
        const phoneRateLimitConfig = {
            maxAttempts: 3,
            timeWindow: 3600000, // 1 hour
            cooldownPeriods: [60, 300, 900, 3600, 86400], // 1min, 5min, 15min, 1hr, 24hr
            attempts: []
        };
        
        // =============================================
        // Notification System
        // =============================================
        
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notice ${type}-notice`;
            
            // Add icon based on type
            let icon;
            switch(type) {
                case 'error':
                    icon = 'error';
                    break;
                case 'success':
                    icon = 'check_circle';
                    break;
                case 'warning':
                    icon = 'warning';
                    break;
                default:
                    icon = 'info';
            }
            
            notification.innerHTML = `
                <i class="material-icons">${icon}</i>
                <span>${message}</span>
            `;
            
            notificationsContainer.appendChild(notification);
            
            // Auto-remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    notification.style.animation = 'slideDown 0.3s ease-out reverse';
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, duration);
            }
            
            return notification;
        }

        // =============================================
        // Device Fingerprinting
        // =============================================
        
        async function generateDeviceFingerprint() {
            try {
                const components = [
                    navigator.userAgent,
                    navigator.language,
                    navigator.platform,
                    screen.colorDepth,
                    screen.width + 'x' + screen.height,
                    new Date().getTimezoneOffset(),
                    !!window.sessionStorage,
                    !!window.localStorage,
                    !!window.indexedDB
                ];

                // Canvas fingerprint
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 200;
                    canvas.height = 50;
                    ctx.textBaseline = 'alphabetic';
                    ctx.fillStyle = '#f60';
                    ctx.fillRect(125, 1, 62, 20);
                    ctx.fillStyle = '#069';
                    ctx.font = '11pt Arial';
                    ctx.fillText('Canvas fingerprint', 2, 15);
                    ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                    ctx.font = '18pt Arial';
                    ctx.fillText('BrowserLeaks.com', 4, 45);
                    components.push(canvas.toDataURL());
                } catch (e) {
                    components.push('canvas-not-supported');
                }

                const fingerprint = CryptoJS.SHA256(components.join('###')).toString();
                localStorage.setItem('deviceFingerprint', fingerprint);
                
                return fingerprint;
            } catch (error) {
                console.error('Error generating device fingerprint:', error);
                return CryptoJS.SHA256(Math.random().toString()).toString();
            }
        }

        async function registerDeviceFingerprint(fingerprint) {
            if (!fingerprint) return;
            
            try {
                const fingerprintRef = db.collection('deviceFingerprints').doc(fingerprint);
                
                await fingerprintRef.set({
                    fingerprint: fingerprint,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    userAgent: navigator.userAgent,
                    ...(currentUser ? { userId: currentUser.uid } : {})
                }, { merge: true });
                
                console.log('Device fingerprint registered successfully');
            } catch (error) {
                console.error('Error registering device fingerprint:', error);
            }
        }
        
        // =============================================
        // Security and Encryption Functions
        // =============================================
        
        function generateEncryptionKey() {
            return CryptoJS.lib.WordArray.random(32).toString();
        }
        
        function encryptMessage(message, key) {
            try {
                if (!key) return message;
                return CryptoJS.AES.encrypt(message, key).toString();
            } catch (error) {
                console.error('Encryption error:', error);
                return message;
            }
        }
        
        function decryptMessage(encryptedMessage, key) {
            try {
                if (!key) return encryptedMessage;
                const bytes = CryptoJS.AES.decrypt(encryptedMessage, key);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch (error) {
                console.error('Decryption error:', error);
                return encryptedMessage;
            }
        }
        
        // =============================================
        // Phone Authentication Rate Limiting
        // =============================================
        
        async function checkPhoneRateLimits(deviceFingerprint, phoneNumber) {
            const phoneHash = CryptoJS.SHA256(phoneNumber).toString();
            const today = new Date().toISOString().split('T')[0];
            
            try {
                // Check daily global limit
                const dailyStatsRef = db.collection('dailyVerificationStats').doc(today);
                const dailyStats = await dailyStatsRef.get();
                
                if (dailyStats.exists && dailyStats.data().totalAttempts >= 50) {
                    throw new Error('Limita zilnică de verificări a fost atinsă. Vă rugăm să încercați mâine.');
                }
                
                // Check device limits
                const deviceRef = db.collection('phoneVerificationAttempts').doc(deviceFingerprint);
                const deviceData = await deviceRef.get();
                
                if (deviceData.exists) {
                    const data = deviceData.data();
                    
                    // Check if device is blocked
                    if (data.isBlocked && data.blockUntil > firebase.firestore.Timestamp.now()) {
                        const waitTime = calculateWaitTime(data.blockUntil);
                        throw new Error(`Dispozitivul este blocat. Încercați din nou în ${waitTime}.`);
                    }
                    
                    // Check recent attempts
                    const recentAttempts = data.recentAttempts || [];
                    const now = Date.now();
                    const validAttempts = recentAttempts.filter(attempt => 
                        now - attempt.timestamp < phoneRateLimitConfig.timeWindow
                    );
                    
                    if (validAttempts.length >= phoneRateLimitConfig.maxAttempts) {
                        const cooldownIndex = Math.min(
                            validAttempts.length - phoneRateLimitConfig.maxAttempts, 
                            phoneRateLimitConfig.cooldownPeriods.length - 1
                        );
                        const cooldownPeriod = phoneRateLimitConfig.cooldownPeriods[cooldownIndex];
                        
                        // Block the device
                        await deviceRef.update({
                            isBlocked: true,
                            blockUntil: firebase.firestore.Timestamp.fromMillis(now + cooldownPeriod * 1000),
                            attempts: firebase.firestore.FieldValue.increment(1)
                        });
                        
                        throw new Error(`Prea multe încercări. Vă rugăm să așteptați ${formatDuration(cooldownPeriod)}.`);
                    }
                }
                
                // Log this attempt
                await logVerificationAttempt(deviceFingerprint, phoneHash);
                
                return true;
            } catch (error) {
                console.error('Rate limit check error:', error);
                throw error;
            }
        }
        
        async function logVerificationAttempt(deviceFingerprint, phoneHash) {
            const timestamp = Date.now();
            const today = new Date().toISOString().split('T')[0];
            
            try {
                // Update device attempts
                const deviceRef = db.collection('phoneVerificationAttempts').doc(deviceFingerprint);
                
                await deviceRef.set({
                    deviceFingerprint: deviceFingerprint,
                    lastAttempt: timestamp,
                    recentAttempts: firebase.firestore.FieldValue.arrayUnion({
                        phoneHash: phoneHash,
                        timestamp: timestamp
                    }),
                    attempts: firebase.firestore.FieldValue.increment(1)
                }, { merge: true });
                
                // Update daily stats
                await db.collection('dailyVerificationStats').doc(today).set({
                    date: today,
                    totalAttempts: firebase.firestore.FieldValue.increment(1),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error('Error logging verification attempt:', error);
            }
        }
        
        // =============================================
        // Phone Verification Functions
        // =============================================
        
        function validateRomanianPhoneNumber(phoneNumber) {
            const romanianMobileRegex = /^7\d{8}$/;
            return romanianMobileRegex.test(phoneNumber);
        }
        
        function formatPhoneNumber(phoneNumber) {
            if (!phoneNumber) return '';
            return phoneNumber.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3');
        }
        
        function formatDuration(seconds) {
            if (seconds < 60) return `${seconds} secunde`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)} minute`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} ore`;
            return `${Math.floor(seconds / 86400)} zile`;
        }
        
        function calculateWaitTime(blockUntilTimestamp) {
            const now = firebase.firestore.Timestamp.now();
            const blockUntil = blockUntilTimestamp.toMillis();
            const difference = blockUntil - now.toMillis();
            
            if (difference <= 0) return 'acum';
            
            return formatDuration(Math.ceil(difference / 1000));
        }
        
        function handlePhoneInput(event) {
            const value = event.target.value.replace(/\D/g, '');
            event.target.value = value;
            
            // Enable/disable send code button
            btnSendCode.disabled = !validateRomanianPhoneNumber(value);
        }
        
        function handleCodeInput(event, index) {
            const input = event.target;
            const value = input.value.replace(/\D/g, '').substr(0, 1);
            input.value = value;
            
            if (value) {
                input.classList.add('filled');
                if (index < codeInputs.length - 1) {
                    codeInputs[index + 1].focus();
                }
            } else {
                input.classList.remove('filled');
            }
            
            // Check if all code inputs are filled
            const code = Array.from(codeInputs).map(input => input.value).join('');
            btnVerifyCode.disabled = code.length !== 6;
        }
        
        function handleCodePaste(event) {
            event.preventDefault();
            const pastedData = (event.clipboardData || window.clipboardData).getData('text');
            const cleanData = pastedData.replace(/\D/g, '').substr(0, 6);
            
            // Fill inputs with pasted data
            for (let i = 0; i < cleanData.length && i < codeInputs.length; i++) {
                codeInputs[i].value = cleanData[i];
                codeInputs[i].classList.add('filled');
            }
            
            // Focus last filled input or first empty one
            if (cleanData.length > 0) {
                const nextEmptyIndex = cleanData.length < 6 ? cleanData.length : 5;
                codeInputs[nextEmptyIndex].focus();
            }
            
            // Check if all inputs are filled
            btnVerifyCode.disabled = cleanData.length !== 6;
        }
        
        function setupCodeInputs() {
            codeInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => handleCodeInput(e, index));
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !input.value && index > 0) {
                        codeInputs[index - 1].focus();
                        codeInputs[index - 1].value = '';
                        codeInputs[index - 1].classList.remove('filled');
                    }
                });
                input.addEventListener('paste', handleCodePaste);
            });
        }
        
        function startRetryCountdown() {
            retryTimeLeft = 60;
            retryMessage.style.display = 'block';
            retryTimer.textContent = retryTimeLeft;
            
            if (retryCountdown) {
                clearInterval(retryCountdown);
            }
            
            retryCountdown = setInterval(() => {
                retryTimeLeft--;
                retryTimer.textContent = retryTimeLeft;
                
                if (retryTimeLeft <= 0) {
                    clearInterval(retryCountdown);
                    retryMessage.style.display = 'none';
                    btnSendCode.disabled = false;
                    btnSendCode.innerHTML = '<i class="material-icons">refresh</i> Retrimite Cod';
                }
            }, 1000);
        }
        
        async function sendVerificationCode() {
            const phoneNumber = phoneNumberInput.value.trim();
            
            if (!validateRomanianPhoneNumber(phoneNumber)) {
                showNotification('Introduceți un număr valid (format: 7XX XXX XXX)', 'error');
                return;
            }
            
            const fullPhoneNumber = '+40' + phoneNumber;
            
            try {
                // Show loading state
                btnSendCode.disabled = true;
                btnSendCode.classList.add('loading');
                btnSendCode.innerHTML = '<i class="material-icons">hourglass_empty</i> Se trimite...';
                
                // Check rate limits
                await checkPhoneRateLimits(deviceFingerprint, fullPhoneNumber);
                
                // Set up reCAPTCHA
                if (!window.recaptchaVerifier) {
                    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                        size: 'invisible',
                        callback: (response) => {
                            console.log('reCAPTCHA solved');
                        },
                        'expired-callback': () => {
                            console.log('reCAPTCHA expired');
                        }
                    });
                }
                
                // Send verification code
                const confirmationResult = await auth.signInWithPhoneNumber(fullPhoneNumber, window.recaptchaVerifier);
                window.confirmationResult = confirmationResult;
                
                // Update UI
                verificationSection.style.display = 'block';
                codeInputs[0].focus();
                
                // Start retry countdown
                startRetryCountdown();
                
                // Update button state
                btnSendCode.innerHTML = '<i class="material-icons">refresh</i> Retrimite Cod';
                btnSendCode.disabled = true;
                btnSendCode.classList.remove('loading');
                
                showNotification('Cod trimis! Verificați SMS-ul.', 'success');
                
            } catch (error) {
                console.error('Error sending verification code:', error);
                handleAuthError(error);
                
                // Reset button
                btnSendCode.disabled = false;
                btnSendCode.classList.remove('loading');
                btnSendCode.innerHTML = '<i class="material-icons">sms</i> Trimite Cod SMS';
                
                // Reset reCAPTCHA
                if (window.recaptchaVerifier) {
                    window.recaptchaVerifier.clear();
                    window.recaptchaVerifier = null;
                }
            }
        }
        
        async function verifyCode() {
            const code = Array.from(codeInputs).map(input => input.value).join('');
            
            if (code.length !== 6) {
                showNotification('Introduceți codul complet de 6 cifre', 'error');
                return;
            }
            
            try {
                // Show loading state
                btnVerifyCode.disabled = true;
                btnVerifyCode.classList.add('loading');
                btnVerifyCode.innerHTML = '<i class="material-icons">hourglass_empty</i> Se verifică...';
                
                // Verify the code
                const result = await window.confirmationResult.confirm(code);
                currentUser = result.user;
                
                // Store phone number in registration data
                registrationData.phone = currentUser.phoneNumber;
                
                // Clear retry countdown
                if (retryCountdown) {
                    clearInterval(retryCountdown);
                }
                
                showNotification('Verificare reușită!', 'success');
                
                // Update UI steps
                document.getElementById('step2').classList.add('completed');
                document.getElementById('step3').classList.add('active');
                document.getElementById('stepLine2').classList.add('completed');
                
                // Move to step 3
                registrationStep2.style.display = 'none';
                registrationStep3.style.display = 'block';
                
            } catch (error) {
                console.error('Error verifying code:', error);
                handleAuthError(error);
                
                // Reset button
                btnVerifyCode.disabled = false;
                btnVerifyCode.classList.remove('loading');
                btnVerifyCode.innerHTML = '<i class="material-icons">check</i> Verifică Cod';
            }
        }
        
        function handleAuthError(error) {
            let message = 'A apărut o eroare. Încercați din nou.';
            
            switch (error.code) {
                case 'auth/invalid-phone-number':
                    message = 'Număr de telefon invalid.';
                    break;
                case 'auth/too-many-requests':
                    message = 'Prea multe încercări. Așteptați puțin.';
                    break;
                case 'auth/quota-exceeded':
                    message = 'Serviciul temporar indisponibil.';
                    break;
                case 'auth/invalid-verification-code':
                    message = 'Cod invalid. Verificați și încercați din nou.';
                    break;
                case 'auth/code-expired':
                    message = 'Codul a expirat. Solicitați unul nou.';
                    break;
                default:
                    if (error.message) {
                        message = error.message;
                    }
            }
            
            showNotification(message, 'error');
        }
        
        // =============================================
        // Registration Functions
        // =============================================
        
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        function handleStep1() {
            const firstName = firstNameInput.value.trim();
            const lastName = lastNameInput.value.trim();
            const email = emailInput.value.trim();
            
            if (!firstName || !lastName || !email) {
                showNotification('Completați toate câmpurile obligatorii', 'error');
                return;
            }
            
            if (!validateEmail(email)) {
                showNotification('Introduceți o adresă de email validă', 'error');
                return;
            }
            
            // Save data
            registrationData.firstName = firstName;
            registrationData.lastName = lastName;
            registrationData.email = email;
            
            // Update steps
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('active');
            document.getElementById('stepLine1').classList.add('completed');
            
            // Move to step 2
            registrationStep1.style.display = 'none';
            registrationStep2.style.display = 'block';
        }
        
        async function completeRegistration() {
            if (!termsCheck.checked || !privacyCheck.checked || !recordingCheck.checked) {
                showNotification('Acceptați toate termenii și condițiile', 'error');
                return;
            }
            
            try {
                // Show loading
                btnCompleteRegistration.disabled = true;
                btnCompleteRegistration.classList.add('loading');
                btnCompleteRegistration.innerHTML = '<i class="material-icons">hourglass_empty</i> Se finalizează...';
                
                // Create user profile
                const userProfile = {
                    firstName: registrationData.firstName,
                    lastName: registrationData.lastName,
                    email: registrationData.email,
                    phone: registrationData.phone,
                    userId: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    deviceFingerprint: deviceFingerprint,
                    termsAccepted: true,
                    privacyAccepted: true,
                    recordingAccepted: true
                };
                
                // Save user profile
                await db.collection('users').doc(currentUser.uid).set(userProfile, { merge: true });
                
                // Register device fingerprint
                await registerDeviceFingerprint(deviceFingerprint);
                
                // Update step
                document.getElementById('step3').classList.add('completed');
                
                showNotification('Înregistrare completă!', 'success');
                
                // Move to emergency check
                accountRegistration.style.display = 'none';
                emergencyCheck.style.display = 'flex';
                
            } catch (error) {
                console.error('Error completing registration:', error);
                showNotification('Eroare la finalizarea înregistrării', 'error');
                
                // Reset button
                btnCompleteRegistration.disabled = false;
                btnCompleteRegistration.classList.remove('loading');
                btnCompleteRegistration.innerHTML = '<i class="material-icons">check_circle</i> Finalizează Înregistrarea';
            }
        }
        
        // =============================================
        // Chat Connection Management
        // =============================================
        
        function updateConnectionStatus(status) {
            connectionStatus.textContent = status;
            
            if (status === 'Offline') {
                connectionStatus.style.color = 'var(--danger-color)';
                if (!chatEnded && chatArea.style.display !== 'none') {
                    showNotification('Conexiune pierdută. Reconectare...', 'warning');
                }
            } else {
                connectionStatus.style.color = '';
                
                if (messageQueue.length > 0) {
                    processMessageQueue();
                }
            }
        }
        
        function setupConnectionMonitoring() {
            try {
                const connectedRef = realtimeDb.ref('.info/connected');
                connectedRef.on('value', (snap) => {
                    if (snap.val() === true) {
                        updateConnectionStatus('Online');
                    } else {
                        updateConnectionStatus('Offline');
                    }
                });
            } catch (error) {
                console.error('Error setting up connection monitoring:', error);
            }
            
            window.addEventListener('online', () => updateConnectionStatus('Online'));
            window.addEventListener('offline', () => updateConnectionStatus('Offline'));
        }
        
        // =============================================
        // Rate Limiting
        // =============================================
        
        function checkRateLimit() {
            const now = Date.now();
            
            rateLimitConfig.sentMessages = rateLimitConfig.sentMessages.filter(
                timestamp => now - timestamp < rateLimitConfig.timeWindow
            );
            
            if (rateLimitConfig.sentMessages.length >= rateLimitConfig.maxMessages) {
                if (!rateLimitConfig.isLimited) {
                    rateLimitConfig.isLimited = true;
                    showNotification(
                        `Prea multe mesaje. Așteptați ${Math.ceil(rateLimitConfig.timeWindow/1000)} secunde.`,
                        'warning',
                        rateLimitConfig.timeWindow
                    );
                    
                    setTimeout(() => {
                        rateLimitConfig.isLimited = false;
                    }, rateLimitConfig.timeWindow);
                }
                return false;
            }
            
            return true;
        }
        
        function recordMessageSent() {
            rateLimitConfig.sentMessages.push(Date.now());
        }
        
        // =============================================
        // Message Queue Management
        // =============================================
        
        function queueMessage(message) {
            messageQueue.push(message);
            localStorage.setItem('messageQueue_' + currentChatId, JSON.stringify(messageQueue));
        }
        
        function processMessageQueue() {
            if (messageQueue.length === 0) return;
            
            showNotification(`Se trimit ${messageQueue.length} mesaje...`, 'info');
            
            const processNext = () => {
                if (messageQueue.length === 0) {
                    showNotification('Toate mesajele au fost trimise.', 'success');
                    return;
                }
                
                const message = messageQueue.shift();
                
                sendMessageToFirestore(message)
                    .then(() => {
                        localStorage.setItem('messageQueue_' + currentChatId, JSON.stringify(messageQueue));
                        processNext();
                    })
                    .catch(error => {
                        console.error('Error processing queued message:', error);
                        messageQueue.unshift(message);
                        localStorage.setItem('messageQueue_' + currentChatId, JSON.stringify(messageQueue));
                        showNotification('Eroare la trimiterea mesajelor.', 'error');
                    });
            };
            
            processNext();
        }
        
        async function sendMessageToFirestore(messageObj) {
            await db.collection('chats').doc(currentChatId).collection('messages').add(messageObj);
            
            await db.collection('chats').doc(currentChatId).update({
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastMessage: messageObj.encrypted ? "[Encrypted message]" : (messageObj.content || '[Mesaj gol]'),
                lastMessageSender: 'user'
            });
        }
        
        // =============================================
        // Message Display Functions
        // =============================================
        
        function displayMessage(message) {
            const existingMessage = document.querySelector(`[data-message-id="${message.id}"]`);
            if (existingMessage) return;
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            
            if (message.id) {
                messageElement.dataset.messageId = message.id;
            }
            
            // Format timestamp
            let timeString = 'Acum';
            if (message.timestamp) {
                const timestamp = message.timestamp.toDate ? message.timestamp.toDate() : new Date();
                timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // Handle different message types
            if (message.type === 'system') {
                messageElement.className = 'message-system';
                messageElement.textContent = message.content;
            } else if (message.type === 'user') {
messageElement.classList.add('message-sent');
                
                let messageHtml = '';
                
                if (message.content) {
                    messageHtml += `
                        <div class="message-content">
                            ${message.content}
                        </div>
                    `;
                }
                
                let statusHtml = '';
                if (message.status === 'sent') {
                    statusHtml = `<i class="material-icons" aria-hidden="true">done</i>`;
                } else if (message.status === 'delivered') {
                    statusHtml = `<i class="material-icons" aria-hidden="true">done_all</i>`;
                } else if (message.status === 'read') {
                    statusHtml = `<i class="material-icons" style="color: var(--secondary-color);" aria-hidden="true">done_all</i>`;
                }
                
                messageHtml += `
                    <div class="message-meta">
                        <span class="message-time">${timeString}</span>
                        <span class="message-status">
                            ${statusHtml}
                        </span>
                    </div>
                `;
                
                messageElement.innerHTML = messageHtml;
            } else if (message.type === 'agent') {
                messageElement.classList.add('message-received');
                
                hideTypingIndicator();
                
                let messageHtml = '';
                
                if (message.content) {
                    messageHtml += `
                        <div class="message-content">
                            ${message.content}
                        </div>
                    `;
                }
                
                messageHtml += `
                    <div class="message-meta">
                        <span class="message-time">${timeString}</span>
                    </div>
                `;
                
                messageElement.innerHTML = messageHtml;
            }
            
            chatMessages.appendChild(messageElement);
            scrollToBottom();
        }
        
        function displayLocalMessage(message) {
            const localMessage = { ...message };
            localMessage.id = 'local-' + Date.now();
            localMessage.status = 'pending';
            
            displayMessage(localMessage);
            
            const messageElement = document.querySelector(`[data-message-id="${localMessage.id}"]`);
            if (messageElement) {
                const statusSpan = messageElement.querySelector('.message-status');
                if (statusSpan) {
                    statusSpan.innerHTML = '<i class="material-icons" style="color: var(--warning-color);">schedule</i>';
                }
            }
        }
        
        function addSystemMessage(text) {
            const tempId = 'local-system-' + Date.now();
            
            const systemMessage = {
                type: 'system',
                content: text,
                timestamp: new Date(),
                id: tempId
            };
            
            displayMessage(systemMessage);
            
            db.collection('chats').doc(currentChatId).collection('messages').add({
                type: 'system',
                content: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                clientGeneratedId: tempId
            }).catch(error => {
                console.error('Error adding system message:', error);
            });
        }
        
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 50);
        }
        
        // =============================================
        // Typing Indicators
        // =============================================
        
        function handleTypingStart() {
            if (!isTyping) {
                isTyping = true;
                
                db.collection('chats').doc(currentChatId).collection('typing')
                    .doc('user')
                    .set({
                        isTyping: true,
                        userId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(error => {
                        console.error('Error updating typing status:', error);
                    });
            }
            
            if (typingTimeout) {
                clearTimeout(typingTimeout);
            }
            
            typingTimeout = setTimeout(resetTypingIndicator, 3000);
        }
        
        function resetTypingIndicator() {
            if (isTyping) {
                isTyping = false;
                
                db.collection('chats').doc(currentChatId).collection('typing')
                    .doc('user')
                    .set({
                        isTyping: false,
                        userId: currentUser.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(error => {
                        console.error('Error updating typing status:', error);
                    });
            }
            
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                typingTimeout = null;
            }
        }
        
        function showTypingIndicator() {
            let typingIndicator = document.querySelector('.typing-indicator');
            
            if (!typingIndicator) {
                typingIndicator = document.createElement('div');
                typingIndicator.className = 'typing-indicator';
                typingIndicator.setAttribute('aria-label', 'Agentul scrie un mesaj');
                
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('span');
                    dot.className = 'typing-dot';
                    typingIndicator.appendChild(dot);
                }
                
                chatMessages.appendChild(typingIndicator);
                scrollToBottom();
            }
        }
        
        function hideTypingIndicator() {
            const typingIndicator = document.querySelector('.typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // =============================================
        // Read Receipts
        // =============================================
        
        function setupReadReceipts() {
            document.addEventListener('visibilitychange', updateReadStatus);
            chatMessages.addEventListener('scroll', updateReadStatus);
            
            updateReadStatus();
        }
        
        function updateReadStatus() {
            if (document.visibilityState === 'visible' && !chatEnded) {
                const agentMessages = document.querySelectorAll('.message-received');
                if (agentMessages.length > 0) {
                    const lastAgentMessage = agentMessages[agentMessages.length - 1];
                    const messageId = lastAgentMessage.dataset.messageId;
                    
                    if (messageId && !messageId.startsWith('local-')) {
                        updateMessageReadStatus(messageId);
                    }
                }
            }
        }
        
        function updateMessageReadStatus(messageId) {
            db.collection('chats').doc(currentChatId).collection('messages').doc(messageId)
                .update({
                    readAt: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(error => {
                    console.error('Error updating read status:', error);
                });
        }
        
        // =============================================
        // Chat Management
        // =============================================
        
        async function createChatSession() {
            try {
                // Get user profile
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userProfile = userDoc.data();
                
                const chatData = {
                    department: selectedDepartment,
                    subject: `Chat din ${new Date().toLocaleDateString()}`,
                    userName: `${userProfile.firstName} ${userProfile.lastName}`,
                    userEmail: userProfile.email,
                    userPhone: userProfile.phone,
                    userId: currentUser.uid,
                    status: 'waiting',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    sessionKey: chatSessionKey,
                    metadata: {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        deviceFingerprint: deviceFingerprint
                    }
                };
                
                const chatRef = await db.collection('chats').add(chatData);
                currentChatId = chatRef.id;
                
                setupChatListeners();
                loadExistingMessages();
                
                addSystemMessage('Bine ați venit! Un agent vă va răspunde în curând.');
                
                return chatRef.id;
            } catch (error) {
                console.error('Error creating chat session:', error);
                throw error;
            }
        }
        
        function setupChatListeners() {
            cleanupChatListeners();
            
            window.chatListeners = {};
            
            window.chatListeners.chatDoc = db.collection('chats').doc(currentChatId)
                .onSnapshot(doc => {
                    const data = doc.data();
                    if (data) {
                        if (data.status === 'active' && !agentJoinedFlag) {
                            agentJoinedFlag = true;
                            const agentName = data.agentName || 'Un agent';
                            addSystemMessage(`${agentName} s-a alăturat conversației.`);
                            
                            if (data.agentPublicKey) {
                                agentPublicKey = data.agentPublicKey;
                            }
                        } else if (data.status === 'closed' && !chatEnded) {
                            handleChatEnded();
                        }
                    }
                });
            
            window.chatListeners.messages = db.collection('chats').doc(currentChatId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const messageData = change.doc.data();
                            const messageId = change.doc.id;
                            
                            if (messageData.clientGeneratedId) {
                                const existingMessage = document.querySelector(`[data-message-id="${messageData.clientGeneratedId}"]`);
                                if (existingMessage) {
                                    existingMessage.dataset.messageId = messageId;
                                    return;
                                }
                            }
                            
                            if (messageData.encrypted && chatSessionKey) {
                                messageData.content = decryptMessage(messageData.content, chatSessionKey);
                            }
                            
                            displayMessage({
                                ...messageData,
                                id: messageId
                            });
                            
                            if (messageData.type === 'agent' && document.visibilityState === 'visible') {
                                updateMessageReadStatus(messageId);
                            }
                        }
                    });
                });
            
            window.chatListeners.typing = db.collection('chats').doc(currentChatId)
                .collection('typing')
                .doc('agent')
                .onSnapshot(doc => {
                    const data = doc.data();
                    if (data && data.isTyping) {
                        showTypingIndicator();
                    } else {
                        hideTypingIndicator();
                    }
                });
        }
        
        function loadExistingMessages() {
            db.collection('chats').doc(currentChatId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const messageData = doc.data();
                        const messageId = doc.id;
                        
                        if (messageData.encrypted && chatSessionKey) {
                            messageData.content = decryptMessage(messageData.content, chatSessionKey);
                        }
                        
                        displayMessage({
                            ...messageData,
                            id: messageId
                        });
                    });
                    
                    scrollToBottom();
                })
                .catch(error => {
                    console.error('Error loading existing messages:', error);
                });
        }
        
        function sendMessage() {
            const messageText = messageInput.value.trim();
            
            if (!messageText) {
                return;
            }
            
            if (!checkRateLimit()) {
                return;
            }
            
            messageInput.value = '';
            resetTypingIndicator();
            
            const messageObj = {
                type: 'user',
                content: chatSessionKey ? encryptMessage(messageText, chatSessionKey) : messageText,
                encrypted: !!chatSessionKey,
                senderId: currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'sent'
            };
            
            if (navigator.onLine) {
                displayMessage({
                    ...messageObj,
                    content: messageText,
                    timestamp: new Date(),
                    id: 'local-' + Date.now()
                });
                
                sendMessageToFirestore(messageObj)
                    .then(() => {
                        recordMessageSent();
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);
                        showNotification('Eroare la trimiterea mesajului.', 'error');
                        queueMessage(messageObj);
                    });
            } else {
                displayLocalMessage({
                    ...messageObj,
                    content: messageText,
                    timestamp: new Date()
                });
                
                queueMessage(messageObj);
                showNotification('Mesajul va fi trimis când veți fi online.', 'warning');
            }
        }
        
        function handleChatEnded() {
            chatEnded = true;
            
            addSystemMessage('Conversația a fost încheiată.');
            
            messageInput.disabled = true;
            btnSendMessage.disabled = true;
            
            setTimeout(() => {
                chatArea.style.display = 'none';
                chatEnd.style.display = 'flex';
            }, 2000);
        }
        
        function confirmEndChat() {
            if (confirm('Sigur doriți să încheiați conversația?')) {
                endChat();
            }
        }
        
        function endChat() {
            chatEnded = true;
            
            db.collection('chats').doc(currentChatId).update({
                status: 'closed',
                endedBy: 'user',
                endedAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                handleChatEnded();
            }).catch(error => {
                console.error('Error ending chat:', error);
                showNotification('Eroare la închiderea conversației.', 'error');
            });
        }
        
        function requestTranscript() {
            const userDoc = db.collection('users').doc(currentUser.uid).get();
            
            userDoc.then(doc => {
                const userData = doc.data();
                const email = userData.email;
                
                if (!email || !email.includes('@')) {
                    showNotification('Email-ul dvs. este invalid.', 'error');
                    return;
                }
                
                btnRequestTranscript.disabled = true;
                btnRequestTranscript.innerHTML = '<i class="material-icons">hourglass_empty</i> Se trimite...';
                
                const sendTranscriptFunction = functions.httpsCallable('sendChatTranscript');
                sendTranscriptFunction({ chatId: currentChatId, email: email })
                    .then(result => {
                        showNotification('Transcriptul a fost trimis pe email.', 'success');
                        btnRequestTranscript.innerHTML = '<i class="material-icons">done</i> Transcript trimis';
                    })
                    .catch(error => {
                        console.error('Error requesting transcript:', error);
                        showNotification('Eroare la trimiterea transcriptului.', 'error');
                        btnRequestTranscript.disabled = false;
                        btnRequestTranscript.innerHTML = '<i class="material-icons">description</i> Primește transcript';
                    });
            });
        }
        
        function resetChat() {
            cleanupChatListeners();
            
            currentChatId = null;
            selectedDepartment = null;
            chatSessionKey = null;
            agentPublicKey = null;
            chatEnded = false;
            isTyping = false;
            agentJoinedFlag = false;
            
            if (typingTimeout) {
                clearTimeout(typingTimeout);
                typingTimeout = null;
            }
            
            messageQueue = [];
            if (currentChatId) {
                localStorage.removeItem('messageQueue_' + currentChatId);
            }
            
            rateLimitConfig.sentMessages = [];
            rateLimitConfig.isLimited = false;
            
            chatMessages.innerHTML = '';
            messageInput.value = '';
            messageInput.disabled = false;
            btnSendMessage.disabled = false;
            
            chatEnd.style.display = 'none';
            chatArea.style.display = 'none';
            departmentSelect.style.display = 'none';
            loadingState.style.display = 'none';
            welcomeScreen.style.display = 'none';
            accountRegistration.style.display = 'none';
            
            emergencyCheck.style.display = 'flex';
            
            chatSessionKey = generateEncryptionKey();
        }
        
        function cleanupChatListeners() {
            if (window.chatListeners) {
                if (window.chatListeners.chatDoc) {
                    window.chatListeners.chatDoc();
                }
                if (window.chatListeners.messages) {
                    window.chatListeners.messages();
                }
                if (window.chatListeners.typing) {
                    window.chatListeners.typing();
                }
                window.chatListeners = null;
            }
        }

        // =============================================
        // Event Listeners
        // =============================================
        
        btnStartWelcome.addEventListener('click', () => {
            welcomeScreen.style.display = 'none';
            accountRegistration.style.display = 'flex';
        });
        
        btnNextStep1.addEventListener('click', handleStep1);
        btnSendCode.addEventListener('click', sendVerificationCode);
        btnVerifyCode.addEventListener('click', verifyCode);
        btnCompleteRegistration.addEventListener('click', completeRegistration);
        
        phoneNumberInput.addEventListener('input', handlePhoneInput);
        
        btnEmergency.addEventListener('click', () => {
            window.location.href = 'tel:112';
        });
        
        btnNonemergency.addEventListener('click', () => {
            emergencyCheck.style.display = 'none';
            departmentSelect.style.display = 'flex';
        });
        
        departmentItems.forEach(item => {
            item.addEventListener('click', () => {
                selectedDepartment = item.dataset.id;
                departmentSelect.style.display = 'none';
                loadingState.style.display = 'flex';
                loadingText.textContent = 'Se creează sesiunea de chat...';
                
                createChatSession()
                    .then(() => {
                        loadingState.style.display = 'none';
                        chatArea.style.display = 'flex';
                        messageInput.focus();
                    })
                    .catch(error => {
                        console.error('Error starting chat:', error);
                        loadingState.style.display = 'none';
                        departmentSelect.style.display = 'flex';
                        showNotification('Eroare la crearea sesiunii.', 'error');
                    });
            });
        });
        
        btnSendMessage.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        messageInput.addEventListener('input', handleTypingStart);
        
        btnCloseChat.addEventListener('click', confirmEndChat);
        btnRequestTranscript.addEventListener('click', requestTranscript);
        btnStartNewChat.addEventListener('click', resetChat);
        
        // =============================================
        // Initialize the chat
        // =============================================
        async function initializeChat() {
            try {
                setupConnectionMonitoring();
                
                deviceFingerprint = await generateDeviceFingerprint();
                
                setupCodeInputs();
                
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        await registerDeviceFingerprint(deviceFingerprint);
                        
                        // Check if user profile exists
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        
                        if (userDoc.exists) {
                            // User is already registered, go to emergency check
                            welcomeScreen.style.display = 'none';
                            accountRegistration.style.display = 'none';
                            emergencyCheck.style.display = 'flex';
                        } else {
                            // User needs to complete registration
                            welcomeScreen.style.display = 'none';
                            accountRegistration.style.display = 'flex';
                        }
                    } else {
                        if (emergencyCheck.style.display !== 'none' || 
                            departmentSelect.style.display !== 'none' || 
                            chatArea.style.display !== 'none') {
                            resetToWelcome();
                        }
                    }
                });
                
                chatSessionKey = generateEncryptionKey();
                
            } catch (error) {
                console.error('Error initializing chat:', error);
                showNotification('Eroare la inițializare.', 'error');
            }
        }
        
        function resetToWelcome() {
            welcomeScreen.style.display = 'flex';
            accountRegistration.style.display = 'none';
            emergencyCheck.style.display = 'none';
            departmentSelect.style.display = 'none';
            loadingState.style.display = 'none';
            chatArea.style.display = 'none';
            chatEnd.style.display = 'none';
            
            currentUser = null;
            resetChat();
        }

        // Initialize the chat application
        initializeChat();
    </script>
</body>
</html>
